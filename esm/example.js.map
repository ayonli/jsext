{"version":3,"file":"example.js","sources":["../example.ts"],"sourcesContent":["/**\n * Inspired by Golang's **Example as Test** design, creates a function that carries example code\n * with `// output:` comments, when the returned function is called, it will automatically check if\n * the actual output matches the one declared in the comment.\n *\n * The example function receives a customized `console` object which will be used to log outputs\n * instead of using the built-in `console`.\n *\n * NOTE: this function is used to simplify the process of writing tests, it does not work in Bun and\n * browsers currently, because Bun removes comments during runtime, and the function relies on\n * Node.js built-in modules.\n *\n * @experimental\n *\n * @example\n *  it(\"should output as expected\", example(console => {\n *      console.log(\"Hello, World!\");\n *      // output:\n *      // Hello, World!\n *  }));\n */\nexport default function example(fn) {\n    const call = {};\n    Error.captureStackTrace(call, example);\n    return async function (...args) {\n        const fnStr = fn.toString();\n        let lines = fnStr.split(\"\\n\").slice(1, -1);\n        let offset = lines.findIndex(line => line.trim().toLowerCase() === \"// output:\");\n        if (offset === -1) {\n            // no output is detected, skip the function\n            return;\n        }\n        else {\n            offset += 1;\n            lines = lines.slice(offset);\n        }\n        if (lines.findIndex(line => line.trim().toLowerCase() === \"// output:\") !== -1) {\n            throw new Error(\"there can only be one output comment in the example\");\n        }\n        let expected = [];\n        for (let line of lines) {\n            line = line.trimStart();\n            if (line.startsWith(\"// \")) {\n                expected.push(line.slice(3));\n            }\n            else {\n                throw new Error(\"the output comment must be at the end of the example\");\n            }\n        }\n        // remove empty tailing lines\n        const _expected = [...expected];\n        expected = [];\n        for (let i = _expected.length - 1; i >= 0; i--) {\n            if (_expected[i] !== \"\") {\n                expected.push(_expected[i]);\n            }\n        }\n        expected.reverse();\n        const assert = await import(\"node:assert\");\n        const util = await import(\"node:util\");\n        const logs = [];\n        const log = (format, ...args) => {\n            logs.push(util.format(format, ...args));\n        };\n        const _console = {\n            log,\n            debug: log,\n            error: log,\n            info: log,\n            warn: log,\n            dir: (obj, options) => {\n                logs.push(util.inspect(obj, options));\n            }\n        };\n        const returns = fn.call(this, _console, ...args);\n        const handleResult = () => {\n            var _a;\n            const actual = logs.join(\"\\n\");\n            const _expected = expected.join(\"\\n\");\n            try {\n                // @ts-ignore\n                assert.ok(actual === _expected, `\\nexpected:\\n${_expected}\\n\\ngot:\\n${actual}`);\n            }\n            catch (err) {\n                err.stack = err.stack\n                    + \"\\n\" + ((_a = call.stack) === null || _a === void 0 ? void 0 : _a.split(\"\\n\").slice(1).join(\"\\n\"));\n                throw err;\n            }\n        };\n        if (typeof (returns === null || returns === void 0 ? void 0 : returns.then) === \"function\") {\n            return returns.then(handleResult);\n        }\n        else {\n            handleResult();\n            return;\n        }\n    };\n}\n//# sourceMappingURL=example.js.map"],"names":[],"mappings":"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"}