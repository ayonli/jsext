{"version":3,"file":"http.js","sources":["../http.ts"],"sourcesContent":["/**\n * Functions to transform Node.js HTTP APIs to modern Web standards.\n *\n * NOTE: This module requires Node.js version v18.3 or higher.\n * @module\n */\n/**\n * Transforms a Node.js HTTP request to a modern `Request` object.\n */\nfunction toWebRequest(req) {\n    var _a;\n    const protocol = req.socket[\"encrypted\"] ? \"https\" : \"http\";\n    const url = new URL((_a = req.url) !== null && _a !== void 0 ? _a : \"/\", `${protocol}://${req.headers.host}`);\n    const headers = new Headers(req.headers);\n    const init = {\n        method: req.method,\n        headers,\n    };\n    const cache = headers.get(\"Cache-Control\");\n    const mode = headers.get(\"Sec-Fetch-Mode\");\n    const referrer = headers.get(\"Referer\");\n    if (cache === \"no-cache\") {\n        init.cache = \"no-cache\";\n    }\n    else if (cache === \"no-store\") {\n        init.cache = \"no-store\";\n    }\n    else if (cache === \"only-if-cached\" && mode === \"same-origin\") {\n        init.cache = \"only-if-cached\";\n    }\n    else {\n        init.cache = \"default\";\n    }\n    if (mode === \"no-cors\") {\n        init.mode = \"no-cors\";\n    }\n    else if (mode === \"same-origin\") {\n        init.mode = \"same-origin\";\n    }\n    else {\n        init.mode = \"cors\";\n    }\n    if (referrer) {\n        init.referrer = referrer;\n    }\n    if (req.method !== \"GET\" && req.method !== \"HEAD\" && req.method !== \"OPTIONS\") {\n        const { readable, writable } = new TransformStream();\n        const writer = writable.getWriter();\n        req.on(\"data\", (chunk) => {\n            writer.write(chunk);\n        }).once(\"error\", (err) => {\n            writer.abort(err);\n        }).once(\"end\", () => {\n            writer.close();\n        });\n        init.body = readable;\n        // @ts-ignore Node.js special\n        init.duplex = \"half\";\n    }\n    const request = new Request(url, init);\n    Object.assign(request, {\n        [Symbol.for(\"incomingMessage\")]: req,\n    });\n    return request;\n}\n/**\n * Pipes a modern `Response` object to a Node.js HTTP response.\n */\nfunction toNodeResponse(res, nodeRes) {\n    const { status, statusText, headers } = res;\n    nodeRes.writeHead(status, statusText, Object.fromEntries(headers.entries()));\n    if (!res.body) {\n        nodeRes.end();\n    }\n    else {\n        res.body.pipeTo(new WritableStream({\n            write(chunk) {\n                nodeRes.write(chunk);\n            },\n            close() {\n                nodeRes.end();\n            },\n            abort(err) {\n                nodeRes.destroy(err);\n            },\n        }));\n    }\n}\n/**\n * Creates a Node.js HTTP request listener using modern Web APIs.\n *\n * @example\n * ```ts\n * import * as http from \"node:http\";\n * import { useWeb } from \"@ayonli/jsext/http\";\n *\n * const server = http.createServer(useWeb(async (req) => {\n *     return new Response(\"Hello, World!\");\n * }));\n *\n * server.listen(8000);\n * ```\n */\nexport function useWeb(listener) {\n    return async (nReq, nRes) => {\n        const req = toWebRequest(nReq);\n        const res = await listener(req);\n        if (res && !nRes.headersSent) {\n            if (res.status === 101) {\n                // When the status code is 101, it means the server is upgrading\n                // the connection to a different protocol, usually to WebSocket.\n                // In this case, the response shall be and may have already been\n                // written by the request socket. So we should not write the\n                // response again.\n                return;\n            }\n            toNodeResponse(res, nRes);\n        }\n    };\n}\n//# sourceMappingURL=http.js.map"],"names":[],"mappings":"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"}