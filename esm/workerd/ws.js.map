{"version":3,"file":"ws.js","sources":["../../workerd/ws.ts"],"sourcesContent":["var _a;\nimport { createCloseEvent, createErrorEvent } from \"../event\";\nimport { WebSocketConnection } from \"../ws/base.ts\";\nconst _handler = Symbol.for(\"handler\");\nconst _clients = Symbol.for(\"clients\");\nexport class WebSocketServer {\n    constructor(...args) {\n        var _b, _c, _d;\n        this[_a] = new Map();\n        if (args.length === 2) {\n            this.idleTimeout = ((_b = args[0]) === null || _b === void 0 ? void 0 : _b.idleTimeout) || 30;\n            this.perMessageDeflate = (_d = (_c = args[0]) === null || _c === void 0 ? void 0 : _c.perMessageDeflate) !== null && _d !== void 0 ? _d : false;\n            this[_handler] = args[1];\n        }\n        else {\n            this.idleTimeout = 30;\n            this.perMessageDeflate = false;\n            this[_handler] = args[0];\n        }\n    }\n    async upgrade(request) {\n        const upgradeHeader = request.headers.get(\"Upgrade\");\n        if (!upgradeHeader || upgradeHeader !== \"websocket\") {\n            throw new TypeError(\"Expected Upgrade: websocket\");\n        }\n        const handler = this[_handler];\n        const clients = this[_clients];\n        const [client, server] = Object.values(new WebSocketPair());\n        const socket = new WebSocketConnection(server);\n        clients.set(request, socket);\n        server.accept();\n        server.addEventListener(\"message\", ev => {\n            if (typeof ev.data === \"string\") {\n                socket.dispatchEvent(new MessageEvent(\"message\", {\n                    data: ev.data,\n                }));\n            }\n            else if (ev.data instanceof ArrayBuffer) {\n                socket.dispatchEvent(new MessageEvent(\"message\", {\n                    data: new Uint8Array(ev.data),\n                }));\n            }\n            else {\n                ev.data.arrayBuffer().then(buffer => {\n                    socket.dispatchEvent(new MessageEvent(\"message\", {\n                        data: new Uint8Array(buffer),\n                    }));\n                }).catch(() => { });\n            }\n        });\n        server.addEventListener(\"close\", ev => {\n            if (!ev.wasClean) {\n                socket.dispatchEvent(createErrorEvent(\"error\", {\n                    error: new Error(`WebSocket connection closed: ${ev.reason} (${ev.code})`),\n                }));\n            }\n            clients.delete(request);\n            socket.dispatchEvent(createCloseEvent(\"close\", {\n                code: ev.code,\n                reason: ev.reason,\n                wasClean: ev.wasClean,\n            }));\n        });\n        if (socket.readyState === 1) {\n            handler === null || handler === void 0 ? void 0 : handler.call(this, socket);\n        }\n        else {\n            server.addEventListener(\"open\", () => {\n                handler === null || handler === void 0 ? void 0 : handler.call(this, socket);\n            });\n        }\n        return {\n            socket,\n            response: new Response(null, {\n                status: 101,\n                // @ts-ignore\n                webSocket: client,\n            }),\n        };\n    }\n}\n_a = _clients;\n//# sourceMappingURL=ws.js.map"],"names":[],"mappings":"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"}