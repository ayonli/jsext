{"version":3,"file":"cookie.js","sources":["../../http/cookie.ts"],"sourcesContent":["import { capitalize } from \"../string.ts\";\n/**\n * Parses the `Set-Cookie` header.\n *\n * @example\n * ```ts\n * import { parseCookie } from \"@ayonli/jsext/http\";\n *\n * const cookie = parseCookie(\"foo=bar; Domain=example.com; Path=/; Expires=Wed, 09 Jun 2021 10:18:14 GMT; HttpOnly; Secure; SameSite=Strict\");\n * console.log(cookie);\n * // {\n * //     name: \"foo\",\n * //     value: \"bar\",\n * //     domain: \"example.com\",\n * //     path: \"/\",\n * //     expires: 1623233894000,\n * //     httpOnly: true,\n * //     secure: true,\n * //     sameSite: \"strict\"\n * // }\n * ```\n */\nexport function parseCookie(str) {\n    const [nameValue, ...params] = str.split(\";\").map((part) => part.trim());\n    if (!nameValue || !nameValue.includes(\"=\")) {\n        throw new TypeError(\"Invalid Set-Cookie header\");\n    }\n    const [name, value] = nameValue.split(\"=\");\n    const cookie = { name: name, value: value };\n    for (const param of params) {\n        if (param) {\n            const [key, value = \"\"] = param.split(\"=\");\n            if (key === \"Domain\") {\n                cookie.domain = value;\n            }\n            else if (key === \"Expires\") {\n                cookie.expires = new Date(value).valueOf();\n            }\n            else if (key === \"Max-Age\") {\n                cookie.maxAge = parseInt(value);\n            }\n            else if (key === \"HttpOnly\") {\n                cookie.httpOnly = true;\n            }\n            else if (key === \"Secure\") {\n                cookie.secure = true;\n            }\n            else if (key === \"Path\") {\n                cookie.path = value || \"/\";\n            }\n            else if (key === \"SameSite\" && value) {\n                cookie.sameSite = value.toLowerCase();\n            }\n            else if (key === \"Partitioned\") {\n                cookie.partitioned = true;\n            }\n        }\n    }\n    return cookie;\n}\n/**\n * Converts a {@link Cookie} object to a string.\n *\n * @example\n * ```ts\n * import { stringifyCookie } from \"@ayonli/jsext/http\";\n *\n * const cookie = stringifyCookie({\n *     name: \"foo\",\n *     value: \"bar\",\n *     domain: \"example.com\",\n *     path: \"/\",\n *     expires: new Date(\"2021-06-09T10:18:14Z\"),\n *     httpOnly: true,\n *     secure: true,\n *     sameSite: \"Strict\"\n * });\n * console.log(cookie);\n * // foo=bar; Domain=example.com; Path=/; Expires=Wed, 09 Jun 2021 10:18:14 GMT; HttpOnly; Secure; SameSite=Strict\n */\nexport function stringifyCookie(cookie) {\n    let str = `${cookie.name}=${cookie.value}`;\n    if (cookie.domain)\n        str += `; Domain=${cookie.domain}`;\n    if (cookie.path)\n        str += `; Path=${cookie.path}`;\n    if (cookie.expires)\n        str += `; Expires=${new Date(cookie.expires).toUTCString()}`;\n    if (cookie.maxAge)\n        str += `; Max-Age=${cookie.maxAge}`;\n    if (cookie.httpOnly)\n        str += \"; HttpOnly\";\n    if (cookie.secure)\n        str += \"; Secure\";\n    if (cookie.sameSite)\n        str += `; SameSite=${capitalize(cookie.sameSite)}`;\n    if (cookie.partitioned)\n        str += \"; Partitioned\";\n    return str;\n}\n/**\n * Parses the `Cookie` header or the `document.cookie` property.\n */\nexport function parseCookies(str) {\n    return !str ? [] : str.split(/;\\s*/g).reduce((cookies, part) => {\n        const [name, value] = part.split(\"=\");\n        if (name && value !== undefined) {\n            cookies.push({ name, value });\n        }\n        return cookies;\n    }, []);\n}\n/**\n * Converts a list of cookies to a string that can be used in the `Cookie`\n * header.\n */\nexport function stringifyCookies(cookies) {\n    return cookies.map(({ name, value }) => `${name}=${value}`).join(\"; \");\n}\n/**\n * Gets the cookies from the `Cookie` header of the request or the `Set-Cookie`\n * header of the response.\n *\n * @example\n * ```ts\n * import { getCookies } from \"@ayonli/jsext/http\";\n *\n * export default {\n *     fetch(req: Request) {\n *         const cookies = getCookies(req);\n *         console.log(cookies);\n *\n *         return new Response(\"Hello, World!\");\n *     }\n * }\n * ```\n */\nexport function getCookies(obj) {\n    var _a;\n    if (\"ok\" in obj && \"status\" in obj) {\n        return obj.headers.getSetCookie().map(str => parseCookie(str));\n    }\n    else {\n        return parseCookies((_a = obj.headers.get(\"Cookie\")) !== null && _a !== void 0 ? _a : \"\");\n    }\n}\n/**\n * Gets the cookie by the given `name` from the `Cookie` header of the request\n * or the `Set-Cookie` header of the response.\n *\n * @example\n * ```ts\n * import { getCookie } from \"@ayonli/jsext/http\";\n *\n * export default {\n *     fetch(req: Request) {\n *         const cookie = getCookie(req, \"foo\");\n *         console.log(cookie);\n *\n *         return new Response(\"Hello, World!\");\n *     }\n * }\n * ```\n */\nexport function getCookie(obj, name) {\n    var _a;\n    return (_a = getCookies(obj).find(cookie => cookie.name === name)) !== null && _a !== void 0 ? _a : null;\n}\nexport function setCookie(obj, cookie) {\n    if (obj instanceof Headers) { // deprecated usage\n        obj.append(\"Set-Cookie\", stringifyCookie(cookie));\n    }\n    else if (obj instanceof Response) {\n        obj.headers.append(\"Set-Cookie\", stringifyCookie(cookie));\n    }\n    else {\n        const cookies = getCookies(obj);\n        const index = cookies.findIndex(({ name }) => name === cookie.name);\n        if (index === -1) {\n            cookies.push(cookie);\n        }\n        else {\n            cookies[index] = cookie;\n        }\n        obj.headers.set(\"Cookie\", stringifyCookies(cookies));\n    }\n}\n//# sourceMappingURL=cookie.js.map"],"names":[],"mappings":"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"}