{"version":3,"file":"internal.js","sources":["../../http/internal.ts"],"sourcesContent":["import { orderBy } from \"../array.ts\";\nimport { join } from \"../path.ts\";\nimport runtime from \"../runtime.ts\";\nimport { EventEndpoint } from \"../sse.ts\";\nimport { dedent } from \"../string.ts\";\nexport function createContext(request, props) {\n    const { ws, remoteAddress = null, ...rest } = props;\n    return {\n        remoteAddress,\n        createEventEndpoint: () => {\n            const events = new EventEndpoint(request);\n            return { events, response: events.response };\n        },\n        upgradeWebSocket: () => ws.upgrade(request),\n        ...rest,\n    };\n}\n;\nexport function withHeaders(handle, headers = undefined) {\n    if (headers === undefined) {\n        const { identity, version } = runtime();\n        let serverName = ({\n            \"node\": \"Node.js\",\n            \"deno\": \"Deno\",\n            \"bun\": \"Bun\",\n            \"workerd\": \"Cloudflare Workers\",\n            \"fastly\": \"Fastly Compute\",\n        })[identity] || \"Unknown\";\n        if (version) {\n            serverName += `/${version}`;\n        }\n        headers = { \"Server\": serverName };\n    }\n    return (...args) => Promise.resolve(handle(...args))\n        .then((response) => {\n        if (response.status === 101) {\n            // WebSocket headers cannot be modified\n            return response;\n        }\n        try {\n            const patch = (name, value) => {\n                if (!response.headers.has(name)) {\n                    response.headers.set(name, value);\n                }\n            };\n            if (headers instanceof Headers) {\n                headers.forEach((value, name) => patch(name, value));\n            }\n            else if (Array.isArray(headers)) {\n                headers.forEach(([name, value]) => patch(name, value));\n            }\n            else if (headers !== null) {\n                Object.entries(headers).forEach(([name, value]) => patch(name, value));\n            }\n        }\n        catch (_a) {\n            // In case the headers are immutable, ignore the error.\n        }\n        return response;\n    });\n}\nexport function listenFetchEvent(options) {\n    const { ws, fetch, headers, onError, bindings } = options;\n    // @ts-ignore\n    addEventListener(\"fetch\", (event) => {\n        var _a, _b, _c;\n        const { request } = event;\n        const address = (_a = request.headers.get(\"cf-connecting-ip\")) !== null && _a !== void 0 ? _a : (_b = event.client) === null || _b === void 0 ? void 0 : _b.address;\n        const ctx = createContext(request, {\n            ws,\n            remoteAddress: address ? {\n                family: address.includes(\":\") ? \"IPv6\" : \"IPv4\",\n                address: address,\n                port: 0,\n            } : null,\n            waitUntil: (_c = event.waitUntil) === null || _c === void 0 ? void 0 : _c.bind(event),\n            bindings,\n        });\n        const _handle = withHeaders(fetch, headers);\n        const _onError = withHeaders(onError, headers);\n        const response = Promise.resolve((_handle(request, ctx)))\n            .catch(err => _onError(err, request, ctx));\n        event.respondWith(response);\n    });\n}\nexport async function respondDir(entries, pathname, extraHeaders = {}) {\n    const list = [\n        ...orderBy(entries.filter(e => e.kind === \"directory\"), e => e.name).map(e => e.name + \"/\"),\n        ...orderBy(entries.filter(e => e.kind === \"file\"), e => e.name).map(e => e.name),\n    ];\n    if (pathname !== \"/\") {\n        list.unshift(\"../\");\n    }\n    const listHtml = list.map((name) => {\n        let url = join(pathname, name);\n        if (name.endsWith(\"/\") && url !== \"/\") {\n            url += \"/\";\n        }\n        return dedent `\n            <li>\n                <a href=\"${url}\">${name}</a>\n            </li>\n            `;\n    });\n    return new Response(dedent `\n                <!DOCTYPE HTML>\n                <html lang=\"en\">\n                <head>\n                    <meta charset=\"utf-8\">\n                    <title>Directory listing for ${pathname}</title>\n                    <style>\n                    body {\n                        font-family: system-ui;\n                    }\n                    </style>\n                </head>\n                <body>\n                    <h1>Directory listing for ${pathname}</h1>\n                    <hr>\n                    <ul>\n                        ${listHtml.join(\"\")}\n                    </ul>\n                </body>\n                </html>\n                `, {\n        status: 200,\n        statusText: \"OK\",\n        headers: {\n            ...extraHeaders,\n            \"Content-Type\": \"text/html; charset=utf-8\",\n        },\n    });\n}\n//# sourceMappingURL=internal.js.map"],"names":[],"mappings":"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"}