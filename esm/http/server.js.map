{"version":3,"file":"server.js","sources":["../../http/server.ts"],"sourcesContent":["var _a, _b, _c, _d;\nimport runtime from \"../runtime.ts\";\nconst _hostname = Symbol.for(\"hostname\");\nconst _port = Symbol.for(\"port\");\nconst _http = Symbol.for(\"http\");\nconst _ws = Symbol.for(\"ws\");\nconst _handler = Symbol.for(\"handler\");\n/**\n * A unified HTTP server interface.\n */\nexport class Server {\n    constructor(impl) {\n        this[_a] = \"\";\n        this[_b] = 0;\n        this[_c] = null;\n        this[_d] = null;\n        this[_http] = impl().then(({ http, ws, hostname, port, fetch }) => {\n            this[_ws] = ws;\n            this[_hostname] = hostname;\n            this[_port] = port;\n            this[_handler] = fetch;\n            return http;\n        });\n        const _this = this;\n        const { identity } = runtime();\n        if (identity === \"cloudflare-worker\") {\n            this.fetch = (req, bindings, ctx) => {\n                if (!_this[_handler]) {\n                    return new Response(\"Service Unavailable\", {\n                        status: 503,\n                        statusText: \"Service Unavailable\",\n                    });\n                }\n                const ws = _this[_ws];\n                return _this[_handler](req, {\n                    remoteAddress: null,\n                    upgradeWebSocket: () => ws.upgrade(req),\n                    waitUntil: ctx.waitUntil,\n                    bindings,\n                });\n            };\n        }\n        else if (identity === \"deno\") {\n            this.fetch = (req) => {\n                if (!_this[_handler]) {\n                    return new Response(\"Service Unavailable\", {\n                        status: 503,\n                        statusText: \"Service Unavailable\",\n                    });\n                }\n                const ws = _this[_ws];\n                return _this[_handler](req, {\n                    remoteAddress: null,\n                    upgradeWebSocket: () => ws.upgrade(req),\n                });\n            };\n        }\n    }\n    /**\n     * The hostname of which the server is listening on, only available after\n     * the server is ready.\n     */\n    get hostname() {\n        return this[_hostname];\n    }\n    /**\n     * The port of which the server is listening on, only available after the\n     * server is ready.\n     */\n    get port() {\n        return this[_port];\n    }\n    /**\n     * A promise that resolves when the server is ready to accept connections.\n     */\n    get ready() {\n        return this[_http].then(() => this);\n    }\n    /**\n     * Closes the server and stops it from accepting new connections.\n     * @param force Terminate all active connections immediately.\n     */\n    async close(force = false) {\n        const server = await this[_http];\n        if (!server)\n            return;\n        if (typeof server.stop === \"function\") {\n            server.stop(force);\n        }\n        else if (typeof server.shutdown === \"function\") {\n            const _server = server;\n            _server.shutdown();\n            await _server.finished;\n        }\n        else if (typeof server.close === \"function\") {\n            const _server = server;\n            await new Promise((resolve, reject) => {\n                if (force && typeof _server.closeAllConnections === \"function\") {\n                    _server.closeAllConnections();\n                }\n                _server.close((err) => err ? reject(err) : resolve());\n            });\n        }\n    }\n    /**\n     * Opposite of `unref()`, calling `ref()` on a previously `unref`ed server\n     * will _not_ let the program exit if it's the only server left (the default\n     * behavior). If the server is `ref`ed calling `ref()` again will have no\n     * effect.\n     */\n    ref() {\n        this[_http].then(server => { var _e; return (_e = server === null || server === void 0 ? void 0 : server.ref) === null || _e === void 0 ? void 0 : _e.call(server); });\n    }\n    /**\n     * Calling `unref()` on a server will allow the program to exit if this is\n     * the only active server in the event system. If the server is already\n     * `unref`ed calling`unref()` again will have no effect.\n     */\n    unref() {\n        this[_http].then(server => { var _e; return (_e = server === null || server === void 0 ? void 0 : server.unref) === null || _e === void 0 ? void 0 : _e.call(server); });\n    }\n}\n_a = _hostname, _b = _port, _c = _ws, _d = _handler;\n//# sourceMappingURL=server.js.map"],"names":[],"mappings":"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"}