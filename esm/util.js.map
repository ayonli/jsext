{"version":3,"file":"util.js","sources":["../util.ts"],"sourcesContent":["var _a;\nimport { Channel, id } from \"./chan.ts\";\nexport const isDeno = typeof Deno === \"object\";\nexport const isBun = typeof Bun === \"object\";\nexport const isNode = !isDeno && !isBun && typeof process === \"object\" && !!((_a = process.versions) === null || _a === void 0 ? void 0 : _a.node);\nexport const isBeforeNode14 = isNode && parseInt(process.version.slice(1)) < 14;\nexport const IsPath = /^(\\.[\\/\\\\]|\\.\\.[\\/\\\\]|[a-zA-Z]:|\\/)/;\nconst moduleCache = new Map();\nconst channelStore = new Map();\nexport async function resolveModule(modId, baseUrl = undefined) {\n    let module;\n    if (isNode || isBun) {\n        const { fileURLToPath } = await import(\"url\");\n        const path = baseUrl ? fileURLToPath(new URL(modId, baseUrl).href) : modId;\n        module = await import(path);\n    }\n    else {\n        const url = new URL(modId, baseUrl).href;\n        module = moduleCache.get(url);\n        if (!module) {\n            if (isDeno) {\n                module = await import(url);\n                moduleCache.set(url, module);\n            }\n            else {\n                try {\n                    module = await import(url);\n                    moduleCache.set(url, module);\n                }\n                catch (err) {\n                    if (String(err).includes(\"Failed\")) {\n                        // The content-type of the response isn't application/javascript, try to\n                        // download it and load it with object URL.\n                        const res = await fetch(url);\n                        const buf = await res.arrayBuffer();\n                        const blob = new Blob([new Uint8Array(buf)], {\n                            type: \"application/javascript\",\n                        });\n                        const _url = URL.createObjectURL(blob);\n                        module = await import(_url);\n                        moduleCache.set(url, module);\n                    }\n                    else {\n                        throw err;\n                    }\n                }\n            }\n        }\n    }\n    if (typeof module[\"default\"] === \"object\" && typeof module[\"default\"].default !== \"undefined\") {\n        module = module[\"default\"]; // CommonJS module with exports.default\n    }\n    return module;\n}\nexport function isChannelMessage(msg) {\n    return msg\n        && typeof msg === \"object\"\n        && [\"push\", \"close\"].includes(msg.type)\n        && typeof msg.channelId === \"number\";\n}\nexport async function handleChannelMessage(msg) {\n    const channel = channelStore.get(msg.channelId);\n    if (!channel)\n        return;\n    if (msg.type === \"push\") {\n        channel.raw.push(msg.value);\n    }\n    else if (msg.type === \"close\") {\n        channel.raw.close(msg.value);\n        channelStore.delete(msg.channelId);\n    }\n}\nexport function wrapChannel(channel, channelWrite) {\n    const channelId = channel[id];\n    if (!channelStore.has(channelId)) {\n        const push = channel.push.bind(channel);\n        const close = channel.close.bind(channel);\n        channelStore.set(channelId, { channel, raw: { push, close } });\n    }\n    Object.defineProperties(channel, {\n        push: {\n            configurable: true,\n            writable: true,\n            value: async (value) => {\n                if (channel[\"state\"] !== 1) {\n                    throw new Error(\"the channel is closed\");\n                }\n                await Promise.resolve(channelWrite(\"push\", value, channelId));\n            },\n        },\n        close: {\n            configurable: true,\n            writable: true,\n            value: (err = null) => {\n                const record = channelStore.get(channelId);\n                record === null || record === void 0 ? void 0 : record.raw.close(err);\n                channelWrite(\"close\", err, channelId);\n                channelStore.delete(channelId);\n                if (record) {\n                    // recover to the original methods\n                    Object.defineProperties(channel, {\n                        push: {\n                            configurable: true,\n                            writable: true,\n                            value: record.raw.push,\n                        },\n                        close: {\n                            configurable: true,\n                            writable: true,\n                            value: record.raw.close,\n                        },\n                    });\n                }\n            },\n        },\n    });\n    return { \"@@type\": \"Channel\", \"@@id\": channelId, \"capacity\": channel.capacity };\n}\nexport function unwrapChannel(obj, channelWrite) {\n    var _a;\n    const channelId = obj[\"@@id\"];\n    let record = channelStore.get(channelId);\n    if (!record) {\n        const channel = Object.assign(Object.create(Channel.prototype), {\n            [id]: channelId,\n            capacity: (_a = obj.capacity) !== null && _a !== void 0 ? _a : 0,\n            buffer: [],\n            producers: [],\n            consumers: [],\n            error: null,\n            state: 1,\n        });\n        if (!channelStore.has(channelId)) {\n            const push = channel.push.bind(channel);\n            const close = channel.close.bind(channel);\n            channelStore.set(channelId, record = { channel, raw: { push, close } });\n        }\n        Object.defineProperties(channel, {\n            push: {\n                configurable: true,\n                writable: true,\n                value: async (value) => {\n                    if (channel[\"state\"] !== 1) {\n                        throw new Error(\"the channel is closed\");\n                    }\n                    await Promise.resolve(channelWrite(\"push\", value, channelId));\n                },\n            },\n            close: {\n                configurable: true,\n                writable: true,\n                value: (err = null) => {\n                    const record = channelStore.get(channelId);\n                    record === null || record === void 0 ? void 0 : record.raw.close(err);\n                    channelWrite(\"close\", err, channelId);\n                    channelStore.delete(channelId);\n                    if (record) {\n                        // recover to the original methods\n                        Object.defineProperties(channel, {\n                            push: {\n                                configurable: true,\n                                writable: true,\n                                value: record.raw.push,\n                            },\n                            close: {\n                                configurable: true,\n                                writable: true,\n                                value: record.raw.close,\n                            },\n                        });\n                    }\n                },\n            },\n        });\n    }\n    return record.channel;\n}\n//# sourceMappingURL=util.js.map"],"names":[],"mappings":"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"}