{"version":3,"file":"file.js","sources":["../../../dialog/cli/file.ts"],"sourcesContent":["import { asyncTask } from \"../../async.ts\";\nimport { isWSL, which } from \"../../cli.ts\";\nimport { Exception, NotSupportedError } from \"../../error.ts\";\nimport { createProgressEvent } from \"../../event.ts\";\nimport { readDir, readFileAsFile, writeFile } from \"../../fs.ts\";\nimport { fixFileType } from \"../../fs/util.ts\";\nimport { as, pick } from \"../../object.ts\";\nimport { basename, join } from \"../../path.ts\";\nimport { platform } from \"../../runtime.ts\";\nimport progress from \"./progress.ts\";\nimport { linuxPickFile, linuxPickFiles, linuxPickFolder } from \"./file/linux.ts\";\nimport { macPickFile, macPickFiles, macPickFolder } from \"./file/mac.ts\";\nimport { windowsPickFile, windowsPickFiles, windowsPickFolder } from \"./file/windows.ts\";\nexport async function pickFile(options = {}) {\n    const _platform = platform();\n    if (_platform === \"darwin\") {\n        return await macPickFile(options.title, {\n            type: options.type,\n            forSave: options === null || options === void 0 ? void 0 : options.forSave,\n            defaultName: options === null || options === void 0 ? void 0 : options.defaultName,\n        });\n    }\n    else if (_platform === \"windows\" || isWSL()) {\n        return await windowsPickFile(options.title, {\n            type: options.type,\n            forSave: options === null || options === void 0 ? void 0 : options.forSave,\n            defaultName: options === null || options === void 0 ? void 0 : options.defaultName,\n        });\n    }\n    else if (_platform === \"linux\" || await which(\"zenity\")) {\n        return await linuxPickFile(options.title, {\n            type: options.type,\n            forSave: options === null || options === void 0 ? void 0 : options.forSave,\n            defaultName: options === null || options === void 0 ? void 0 : options.defaultName,\n        });\n    }\n    throw new NotSupportedError(\"Unsupported platform\");\n}\nexport async function pickFiles(options = {}) {\n    const _platform = platform();\n    if (_platform === \"darwin\") {\n        return await macPickFiles(options.title, options.type);\n    }\n    else if (_platform === \"windows\" || isWSL()) {\n        return await windowsPickFiles(options.title, options.type);\n    }\n    else if (_platform === \"linux\" || await which(\"zenity\")) {\n        return await linuxPickFiles(options.title, options.type);\n    }\n    throw new NotSupportedError(\"Unsupported platform\");\n}\nexport async function pickDirectory(options = {}) {\n    const _platform = platform();\n    if (_platform === \"darwin\") {\n        return await macPickFolder(options.title);\n    }\n    else if (_platform === \"windows\" || isWSL()) {\n        return await windowsPickFolder(options.title);\n    }\n    else if (_platform === \"linux\" || await which(\"zenity\")) {\n        return await linuxPickFolder(options.title);\n    }\n    throw new NotSupportedError(\"Unsupported platform\");\n}\nexport async function openFile(options) {\n    let filename = await pickFile(options);\n    if (filename) {\n        return await readFileAsFile(filename);\n    }\n    else {\n        return null;\n    }\n}\nexport async function openFiles(options = {}) {\n    const filenames = await pickFiles(options);\n    return await Promise.all(filenames.map(path => readFileAsFile(path)));\n}\nexport async function openDirectory(options = {}) {\n    const dirname = await pickDirectory(options);\n    if (dirname) {\n        const files = [];\n        for await (const entry of readDir(dirname, { recursive: true })) {\n            if (entry.kind === \"file\") {\n                const path = join(dirname, entry.relativePath);\n                const file = await readFileAsFile(path);\n                Object.defineProperty(file, \"webkitRelativePath\", {\n                    configurable: true,\n                    enumerable: true,\n                    writable: false,\n                    value: entry.relativePath.replace(/\\\\/g, \"/\"),\n                });\n                files.push(fixFileType(file));\n            }\n        }\n        return files;\n    }\n    else {\n        return [];\n    }\n}\nexport async function saveFile(file, options = {}) {\n    var _a;\n    const { title } = options;\n    let filename;\n    if (typeof Blob === \"function\" && file instanceof Blob) {\n        filename = await pickFile({\n            title,\n            type: options.type || file.type,\n            forSave: true,\n            defaultName: options.name || ((_a = as(file, File)) === null || _a === void 0 ? void 0 : _a.name),\n        });\n    }\n    else {\n        filename = await pickFile({\n            title,\n            type: options.type,\n            forSave: true,\n            defaultName: options.name,\n        });\n    }\n    if (filename) {\n        await writeFile(filename, file, pick(options, [\"signal\"]));\n    }\n}\nexport async function downloadFile(url, options = {}) {\n    var _a;\n    const src = typeof url === \"object\" ? url.href : url;\n    const name = options.name || basename(src);\n    const dest = await pickFile({\n        title: options.title,\n        type: options.type,\n        forSave: true,\n        defaultName: name,\n    });\n    if (!dest) // user canceled\n        return;\n    const task = asyncTask();\n    let signal = (_a = options.signal) !== null && _a !== void 0 ? _a : null;\n    let result;\n    let updateProgress;\n    if (options.showProgress) {\n        const ctrl = new AbortController();\n        signal = ctrl.signal;\n        result = progress(\"Downloading...\", async (set) => {\n            updateProgress = set;\n            return await task;\n        }, () => {\n            ctrl.abort();\n            throw new Exception(\"Download canceled\", { name: \"AbortError\" });\n        });\n    }\n    else {\n        result = task;\n    }\n    const res = await fetch(src, { signal });\n    if (!res.ok) {\n        throw new Error(`Failed to download: ${src}`);\n    }\n    const size = parseInt(res.headers.get(\"Content-Length\") || \"0\", 10);\n    let stream = res.body;\n    if (options.onProgress || options.showProgress) {\n        const { onProgress } = options;\n        let loaded = 0;\n        const transform = new TransformStream({\n            transform(chunk, controller) {\n                controller.enqueue(chunk);\n                loaded += chunk.byteLength;\n                if (onProgress) {\n                    try {\n                        onProgress === null || onProgress === void 0 ? void 0 : onProgress(createProgressEvent(\"progress\", {\n                            lengthComputable: !!size,\n                            loaded,\n                            total: size !== null && size !== void 0 ? size : 0,\n                        }));\n                    }\n                    catch (_a) {\n                        // ignore\n                    }\n                }\n                if (updateProgress && size) {\n                    updateProgress({\n                        percent: loaded / size,\n                    });\n                }\n            },\n        });\n        stream = stream.pipeThrough(transform);\n    }\n    writeFile(dest, stream, { signal: signal }).then(() => {\n        task.resolve();\n    }).catch(err => {\n        task.reject(err);\n    });\n    await result;\n}\n//# sourceMappingURL=file.js.map"],"names":[],"mappings":"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"}