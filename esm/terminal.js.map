{"version":3,"file":"terminal.js","sources":["../terminal.ts"],"sourcesContent":["/**\n * Useful utility functions for interacting with the terminal.\n *\n * NOTE: this module is not intended to be used in the browser.\n * @module\n */\nimport { text } from \"./bytes.ts\";\nimport { interop } from \"./module.ts\";\nimport { PowerShellCommands } from \"./terminal/constants.ts\";\nexport const PopularPlatforms = [\n    \"android\",\n    \"darwin\",\n    \"freebsd\",\n    \"linux\",\n    \"windows\",\n];\n/**\n * Returns a string identifying the operating system platform in which the\n * program is running.\n */\nexport function platform() {\n    if (typeof Deno === \"object\") {\n        if (PopularPlatforms.includes(Deno.build.os)) {\n            return Deno.build.os;\n        }\n        else {\n            return \"others\";\n        }\n    }\n    else if (typeof process === \"object\" && typeof process.platform === \"string\") {\n        if (process.platform === \"win32\") {\n            return \"windows\";\n        }\n        else if (PopularPlatforms.includes(process.platform)) {\n            return process.platform;\n        }\n        else {\n            return \"others\";\n        }\n    }\n    else if (typeof navigator === \"object\" && typeof navigator.userAgent === \"string\") {\n        if (navigator.userAgent.includes(\"Android\")) {\n            return \"android\";\n        }\n        else if (navigator.userAgent.includes(\"Macintosh\")) {\n            return \"darwin\";\n        }\n        else if (navigator.userAgent.includes(\"Windows\")) {\n            return \"windows\";\n        }\n        else if (navigator.userAgent.includes(\"Linux\")) {\n            return \"linux\";\n        }\n        else {\n            return \"others\";\n        }\n    }\n    else {\n        return \"others\";\n    }\n}\n/**\n * Quotes a string to be used as a single argument to a shell command.\n */\nexport function quote(arg) {\n    if ((/[\"\\s]/).test(arg) && !(/'/).test(arg)) {\n        return \"'\" + arg.replace(/(['\\\\])/g, '\\\\$1') + \"'\";\n    }\n    if ((/[\"'\\s]/).test(arg)) {\n        return '\"' + arg.replace(/([\"\\\\$`!])/g, '\\\\$1') + '\"';\n    }\n    return String(arg).replace(/([A-Za-z]:)?([#!\"$&'()*,:;<=>?@[\\\\\\]^`{|}])/g, '$1\\\\$2');\n}\n/**\n * Executes a command in the terminal and returns the exit code and outputs.\n */\nexport async function run(cmd, args) {\n    var _a;\n    const isWindows = platform() === \"windows\";\n    if (typeof Deno === \"object\") {\n        const { Buffer } = await import(\"node:buffer\");\n        // @ts-ignore\n        const { decode } = await interop(import(\"npm:iconv-lite\"), false);\n        const _cmd = isWindows && PowerShellCommands.includes(cmd)\n            ? new Deno.Command(\"powershell\", { args: [\"-c\", cmd, ...args.map(quote)] })\n            : new Deno.Command(cmd, { args });\n        const { code, stdout, stderr } = await _cmd.output();\n        return {\n            code,\n            stdout: isWindows ? decode(Buffer.from(stdout), \"cp936\") : text(stdout),\n            stderr: isWindows ? decode(Buffer.from(stderr), \"cp936\") : text(stderr),\n        };\n    }\n    else if (typeof process === \"object\" && !!((_a = process.versions) === null || _a === void 0 ? void 0 : _a.node)) {\n        const { spawn } = await import(\"child_process\");\n        const { decode } = await interop(import(\"iconv-lite\"), false);\n        const child = isWindows && PowerShellCommands.includes(cmd)\n            ? spawn(\"powershell\", [\"-c\", cmd, ...args.map(quote)])\n            : spawn(cmd, args);\n        const stdout = [];\n        const stderr = [];\n        child.stdout.on(\"data\", chunk => {\n            if (isWindows) {\n                stdout.push(decode(chunk, \"cp936\"));\n            }\n            else {\n                stdout.push(String(chunk));\n            }\n        });\n        child.stderr.on(\"data\", chunk => {\n            if (isWindows) {\n                stderr.push(decode(chunk, \"cp936\"));\n            }\n            else {\n                stderr.push(String(chunk));\n            }\n        });\n        const code = await new Promise((resolve, reject) => {\n            child.once(\"exit\", (code, signal) => {\n                if (code === null && signal) {\n                    resolve(1);\n                }\n                else {\n                    resolve(code !== null && code !== void 0 ? code : 0);\n                }\n            }).once(\"error\", reject);\n        });\n        return {\n            code,\n            stdout: stdout.join(\"\"),\n            stderr: stderr.join(\"\"),\n        };\n    }\n    else {\n        throw new Error(\"Unsupported runtime\");\n    }\n}\n/**\n * Returns the path of the given command if it exists in the system,\n * otherwise returns `null`.\n */\nexport async function which(cmd) {\n    if (platform() === \"windows\") {\n        const { code, stdout } = await run(\"powershell\", [\n            \"-Command\",\n            `Get-Command -Name ${cmd} | Select-Object -ExpandProperty Source`\n        ]);\n        return code ? null : stdout.trim();\n    }\n    else {\n        const { code, stdout } = await run(\"which\", [cmd]);\n        return code ? null : stdout.trim();\n    }\n}\n//# sourceMappingURL=terminal.js.map"],"names":[],"mappings":"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"}