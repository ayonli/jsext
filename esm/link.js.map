{"version":3,"file":"link.js","sources":["../link.ts"],"sourcesContent":["import { ThenableAsyncGenerator } from \"./external/thenable-generator/index.ts\";\nimport run from \"./run.ts\";\nexport class RemoteCall extends ThenableAsyncGenerator {\n    constructor(source, abort) {\n        super(source);\n        this.abort = abort;\n    }\n}\n/**\n * Creates a remote module wrapper whose functions are run in another thread.\n *\n * This function uses `run()` under the hood, and the remote function must be async.\n *\n * @example\n * ```ts\n * const mod = link(() => import(\"./job-example.mjs\"));\n * console.log(await mod.greet(\"World\")); // Hi, World\n * ```\n *\n * @example\n * ```ts\n * const mod = link(() => import(\"./job-example.mjs\"));\n *\n * for await (const word of mod.sequence([\"foo\", \"bar\"])) {\n *     console.log(word);\n * }\n * // output:\n * // foo\n * // bar\n * ```\n */\nexport default function link(mod, options = {}) {\n    return new Proxy(Object.create(null), {\n        get: (_, prop) => {\n            const obj = {\n                // This syntax will give our remote function a name.\n                [prop]: (...args) => {\n                    let job;\n                    let iter;\n                    return new RemoteCall({\n                        async next() {\n                            var _a;\n                            job !== null && job !== void 0 ? job : (job = await run(mod, args, {\n                                ...options,\n                                fn: prop,\n                                keepAlive: (_a = options.keepAlive) !== null && _a !== void 0 ? _a : true,\n                            }));\n                            iter !== null && iter !== void 0 ? iter : (iter = job.iterate()[Symbol.asyncIterator]());\n                            let { done = false, value } = await iter.next();\n                            if (done) {\n                                // HACK: this will set the internal result of ThenableAsyncGenerator\n                                // to the result of the job.\n                                value = await job.result();\n                            }\n                            return Promise.resolve({ done, value });\n                        },\n                        async throw(err) {\n                            await (job === null || job === void 0 ? void 0 : job.abort(err));\n                            throw err;\n                        },\n                        async return(value) {\n                            await (job === null || job === void 0 ? void 0 : job.abort());\n                            return { value, done: true };\n                        },\n                        async then(onfulfilled, onrejected) {\n                            var _a;\n                            job !== null && job !== void 0 ? job : (job = await run(mod, args, {\n                                ...options,\n                                fn: prop,\n                                keepAlive: (_a = options.keepAlive) !== null && _a !== void 0 ? _a : true,\n                            }));\n                            return job.result().then(onfulfilled, onrejected);\n                        },\n                    }, async (reason = undefined) => {\n                        return await (job === null || job === void 0 ? void 0 : job.abort(reason));\n                    });\n                }\n            };\n            return obj[prop];\n        }\n    });\n}\n//# sourceMappingURL=link.js.map"],"names":[],"mappings":"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"}