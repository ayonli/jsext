{"version":3,"file":"client.js","sources":["../../ws/client.ts"],"sourcesContent":["import { getReadonly, setReadonly } from \"../class/util.ts\";\n/**\n * A `WebSocket` polyfill for Node.js before v21.\n * See https://developer.mozilla.org/en-US/docs/Web/API/WebSocket\n *\n * NOTE: Must install the package from NPM to use this polyfill. If the runtime\n * already supports the global `WebSocket` class, this variable will be that\n * class instead of the polyfill one.\n */\nexport const WebSocket = globalThis.WebSocket;\nconst _ws = Symbol(\"ws\");\nfunction initWebSocketStream(wss, ws) {\n    ws.binaryType = \"arraybuffer\";\n    setReadonly(wss, \"opened\", new Promise((resolve, reject) => {\n        ws.addEventListener(\"open\", () => {\n            resolve({\n                extensions: ws.extensions,\n                protocol: ws.protocol,\n                readable: new ReadableStream({\n                    start(controller) {\n                        ws.addEventListener(\"message\", ({ data }) => {\n                            if (typeof data === \"string\") {\n                                controller.enqueue(data);\n                            }\n                            else if (data instanceof ArrayBuffer) {\n                                controller.enqueue(new Uint8Array(data));\n                            }\n                            else if (data instanceof Uint8Array) {\n                                controller.enqueue(new Uint8Array(data.buffer, data.byteOffset, data.byteLength));\n                            }\n                            else {\n                                ws.close(1003, \"Unsupported message type\");\n                            }\n                        });\n                        ws.addEventListener(\"close\", () => {\n                            try {\n                                controller.close();\n                            }\n                            catch (_a) { }\n                        });\n                    },\n                    cancel() {\n                        ws.close();\n                    },\n                }),\n                writable: new WritableStream({\n                    write(chunk) {\n                        ws.send(chunk);\n                    },\n                }),\n            });\n        });\n        ws.addEventListener(\"error\", () => {\n            reject(new Error(\"Failed to establish WebSocket connection.\"));\n        });\n    }));\n    setReadonly(wss, \"closed\", new Promise((resolve) => {\n        ws.addEventListener(\"close\", (ev) => {\n            resolve({\n                closeCode: ev.code,\n                reason: ev.reason,\n            });\n        });\n    }));\n}\n/**\n * A `WebSocketStream` polyfill.\n * See https://developer.mozilla.org/en-US/docs/Web/API/WebSocketStream\n *\n * NOTE: This API depends on the Web Streams API, in Node.js, it requires\n * Node.js v18.0 or above.\n *\n * NOTE: This implementation is based on the `WebSocket` API and supports\n * half-close, closing the writable stream will not close the connection, the\n * connection will only be closed when the `close` method is called or the\n * readable stream is canceled.\n *\n * @example\n * ```ts\n * // usage\n * globalThis.WebSocketStream ??= (await import(\"@ayonli/jsext/ws\")).WebSocketStream;\n * ```\n */\nexport class WebSocketStream {\n    get url() {\n        return getReadonly(this, \"url\");\n    }\n    get opened() {\n        return getReadonly(this, \"opened\");\n    }\n    get closed() {\n        return getReadonly(this, \"closed\");\n    }\n    constructor(url, options = {}) {\n        if (typeof globalThis.WebSocket !== \"function\") {\n            throw new Error(\"WebSocket is not supported in this environment.\");\n        }\n        const { protocols, signal } = options;\n        const ws = this[_ws] = new globalThis.WebSocket(url, protocols);\n        setReadonly(this, \"url\", ws.url);\n        initWebSocketStream(this, ws);\n        signal === null || signal === void 0 ? void 0 : signal.addEventListener(\"abort\", () => ws.close());\n    }\n    close(options = {}) {\n        var _a;\n        const { closeCode, reason } = options;\n        (_a = this[_ws]) === null || _a === void 0 ? void 0 : _a.close(closeCode, reason);\n    }\n}\n// If the global `WebSocketStream` class is available, inherit from it, so that\n// the `instanceof` operator works properly.\n// @ts-ignore\nif (typeof globalThis.WebSocketStream === \"function\") {\n    // @ts-ignore\n    Object.setPrototypeOf(WebSocketStream, globalThis.WebSocketStream);\n    // @ts-ignore\n    Object.setPrototypeOf(WebSocketStream.prototype, globalThis.WebSocketStream.prototype);\n}\n//# sourceMappingURL=client.js.map"],"names":[],"mappings":"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"}