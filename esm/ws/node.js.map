{"version":3,"file":"node.js","sources":["../../ws/node.ts"],"sourcesContent":["var _a, _b;\nimport { WebSocketServer as WSServer } from \"ws\";\nimport { concat } from \"../bytes.ts\";\nconst _source = Symbol.for(\"source\");\nconst _url = Symbol.for(\"url\");\nconst _context = Symbol.for(\"context\");\nconst _listeners = Symbol.for(\"listeners\");\nconst _clients = Symbol.for(\"clients\");\nconst _server = Symbol.for(\"server\");\nexport class WebSocketConnection {\n    constructor(source, options) {\n        this[_source] = source;\n        this[_url] = options.url;\n        this[_context] = options.context;\n    }\n    get readyState() {\n        return this[_source].readyState;\n    }\n    get url() {\n        return this[_url];\n    }\n    get context() {\n        return this[_context];\n    }\n    send(data) {\n        this[_source].send(data);\n    }\n    close(code, reason) {\n        this[_source].close(code, reason);\n    }\n}\nexport class WebSocketServer {\n    constructor(listeners, options) {\n        var _c, _d;\n        this[_a] = new Map();\n        this[_b] = new WSServer();\n        const server = new WSServer(options);\n        this[_server] = server;\n        this[_listeners] = listeners;\n        this.idleTimeout = (_c = options.idleTimeout) !== null && _c !== void 0 ? _c : 30;\n        this.perMessageDeflate = (_d = options.perMessageDeflate) !== null && _d !== void 0 ? _d : false;\n        server.on(\"connection\", (_ws, req) => {\n            var _c, _d;\n            const origin = req.headers.origin;\n            const secure = (_c = origin === null || origin === void 0 ? void 0 : origin.startsWith(\"https://\")) !== null && _c !== void 0 ? _c : false;\n            const url = new URL(req.url, `${secure ? \"wss\" : \"ws\"}://${(_d = req.headers.host) !== null && _d !== void 0 ? _d : \"localhost\"}`);\n            const ws = new WebSocketConnection(_ws, {\n                url: url.toString(),\n                context: _ws[_context],\n            });\n            const listeners = this[_listeners];\n            const clients = this[_clients];\n            clients.set(_ws, ws);\n            _ws.on(\"message\", (data) => {\n                let event;\n                if (typeof data === \"string\") {\n                    event = new MessageEvent(\"message\", { data, origin: origin });\n                }\n                else if (data instanceof ArrayBuffer || ArrayBuffer.isView(data)) {\n                    event = new MessageEvent(\"message\", {\n                        data: new Uint8Array(data),\n                        origin: origin,\n                    });\n                }\n                else if (Array.isArray(data)) {\n                    event = new MessageEvent(\"message\", {\n                        data: concat(...data),\n                        origin: origin,\n                    });\n                }\n                else {\n                    return; // unknown data type\n                }\n                listeners.message(ws, event);\n            });\n            _ws.on(\"open\", () => { var _c; return (_c = listeners.open) === null || _c === void 0 ? void 0 : _c.call(listeners, ws, new Event(\"open\")); });\n            _ws.on(\"error\", () => { var _c; return (_c = listeners.error) === null || _c === void 0 ? void 0 : _c.call(listeners, ws, new Event(\"error\")); });\n            _ws.on(\"close\", (code = 1000, reason) => {\n                var _c;\n                (_c = listeners.close) === null || _c === void 0 ? void 0 : _c.call(listeners, ws, new CloseEvent(\"close\", {\n                    code,\n                    reason: reason.toString(\"utf8\"),\n                    wasClean: code === 1000,\n                }));\n                clients.delete(_ws);\n            });\n        });\n    }\n    upgrade(request, socket, head, context = undefined) {\n        this[_server].handleUpgrade(request, socket, head, (ws) => {\n            // @ts-ignore\n            ws[_context] = context;\n            this[_server].emit(\"connection\", ws, request);\n        });\n    }\n    get bunListener() {\n        return {\n            idleTimeout: this.idleTimeout,\n            perMessageDeflate: this.perMessageDeflate,\n            // no-op stubs\n            message: () => { },\n            open: () => { },\n            error: () => { },\n            close: () => { },\n        };\n    }\n    get clients() {\n        return this[_clients].values();\n    }\n}\n_a = _clients, _b = _server;\n//# sourceMappingURL=node.js.map"],"names":["WSServer"],"mappings":"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"}