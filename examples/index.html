<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Example</title>
    <link rel="stylesheet" href="./styles.css">
    <script src="../bundle/jsext.js">
        // this will also include the sub-modules and augmentations
    </script>
    <script type="importmap">
        {
            "imports": {
                "@ayonli/jsext": "../esm/index.js",
                "@ayonli/jsext/array": "../esm/array.js",
                "@ayonli/jsext/async": "../esm/async.js",
                "@ayonli/jsext/bytes": "../esm/bytes.js",
                "@ayonli/jsext/chan": "../esm/chan.js",
                "@ayonli/jsext/class": "../esm/class.js",
                "@ayonli/jsext/cli": "../esm/cli.js",
                "@ayonli/jsext/collections": "../esm/collections.js",
                "@ayonli/jsext/debounce": "../esm/debounce.js",
                "@ayonli/jsext/deprecate": "../esm/deprecate.js",
                "@ayonli/jsext/dialog": "../esm/dialog.js",
                "@ayonli/jsext/error": "../esm/error.js",
                "@ayonli/jsext/example": "../esm/example.js",
                "@ayonli/jsext/filetype": "../esm/filetype.js",
                "@ayonli/jsext/fs": "../esm/fs.js",
                "@ayonli/jsext/func": "../esm/func.js",
                "@ayonli/jsext/json": "../esm/json.js",
                "@ayonli/jsext/lock": "../esm/lock.js",
                "@ayonli/jsext/math": "../esm/math.js",
                "@ayonli/jsext/mixin": "../esm/mixin.js",
                "@ayonli/jsext/module": "../esm/module.js",
                "@ayonli/jsext/number": "../esm/number.js",
                "@ayonli/jsext/object": "../esm/object.js",
                "@ayonli/jsext/parallel": "../esm/parallel.js",
                "@ayonli/jsext/path": "../esm/path.js",
                "@ayonli/jsext/pipe": "../esm/pipe.js",
                "@ayonli/jsext/queue": "../esm/queue.js",
                "@ayonli/jsext/read": "../esm/read.js",
                "@ayonli/jsext/readAll": "../esm/readAll.js",
                "@ayonli/jsext/reader": "../esm/reader.js",
                "@ayonli/jsext/run": "../esm/run.js",
                "@ayonli/jsext/runtime": "../esm/runtime.js",
                "@ayonli/jsext/string": "../esm/string.js",
                "@ayonli/jsext/throttle": "../esm/throttle.js",
                "@ayonli/jsext/try": "../esm/try.js",
                "@ayonli/jsext/types": "../esm/types.js",
                "@ayonli/jsext/wrap": "../esm/wrap.js"
            }
        }
    </script>
    <script type="module">
        import { sleep } from "@ayonli/jsext/async";
        import {
            alert,
            confirm,
            prompt,
            progress,
            openFile,
            saveFile,
            downloadFile,
        } from "@ayonli/jsext/dialog";
        import runtime, { isREPL } from "@ayonli/jsext/runtime";

        self.onload = () => {
            const alertBtn = document.getElementById('alert');
            alertBtn.addEventListener('click', () => {
                alert('Hello, World!');
            });

            const confirmBtn = document.getElementById('confirm');
            confirmBtn.addEventListener('click', () => {
                confirm('Are you sure?').then((result) => {
                    alert("You clicked " + (result ? "OK" : "Cancel"));
                });
            });

            const promptBtn = document.getElementById('prompt');
            promptBtn.addEventListener('click', () => {
                prompt('Enter your name:').then((result) => {
                    alert("You entered: " + result);
                });
            });

            const promptPasswordBtn = document.getElementById('prompt-password');
            promptPasswordBtn.addEventListener('click', () => {
                prompt('Enter your password:', { type: 'password' }).then((result) => {
                    alert("You entered: " + result);
                });
            });

            const promptDefaultBtn = document.getElementById('prompt-default');
            promptDefaultBtn.addEventListener('click', () => {
                prompt('Enter your name:', 'John Doe').then((result) => {
                    alert("You entered: " + result);
                });
            });

            const progressBtn = document.getElementById('progress');
            progressBtn.addEventListener('click', async () => {
                const result = await progress('Loading...', async () => {
                    await sleep(1000);
                    return "Done!";
                });
                await alert("Progress completed: " + result);
            });

            const progress2Btn = document.getElementById('progress-2');
            progress2Btn.addEventListener('click', async () => {
                const result = await progress('Loading...', async (update) => {
                    for (let i = 0; i <= 100; i += 10) {
                        await sleep(500);

                        if (i === 50) {
                            update({ percent: i, message: "Halfway there..." });
                        } else {
                            update({ percent: i });
                        }
                    }

                    return "Done!";
                });
                await alert("Progress completed: " + result);
            });

            const openFileBtn = document.getElementById('open-file');
            openFileBtn.addEventListener('click', async () => {
                const file = await openFile();
                console.log(file);
                await alert("You selected: " + file?.name);
            });

            const openFilesBtn = document.getElementById('open-files');
            openFilesBtn.addEventListener('click', async () => {
                const files = await openFile({ multiple: true });
                console.log(files);
                await alert("You selected: " + files.map((file) => file.name).join(', '));
            });

            const openDirBtn = document.getElementById('open-directory');
            openDirBtn.addEventListener('click', async () => {
                const files = await openFile({ directory: true });
                console.log(files);
                await alert("You selected: " + files.map((file) => file.name).join(', '));
            });

            const downloadFileBtn = document.getElementById('download-file');
            downloadFileBtn.addEventListener('click', async () => {
                const res = await fetch('./');
                const buf = await res.arrayBuffer();
                const type = await res.headers.get('Content-Type') ?? "";
                const file = new File([buf], 'index.html', { type });

                if (file) {
                    console.log(file);
                    await saveFile(file, { name: file.name });
                }
            });

            const downloadUrlBtn = document.getElementById('download-file-url');
            downloadUrlBtn.addEventListener('click', async () => {
                await downloadFile("./", { name: 'index.html' });
            });

            const runtimeInfoBtn = document.getElementById('runtime-info');
            runtimeInfoBtn.addEventListener('click', async () => {
                const info = {
                    ...runtime(),
                    isREPL: isREPL(),
                    ua: navigator.userAgent,
                    stack: (() => {
                        const obj = {};
                        Error.captureStackTrace?.(obj);
                        return obj.stack ?? null;
                    })(),
                };
                console.log(info);
                await alert(JSON.stringify(info, null, 2));
            });
        }
    </script>
</head>

<body>
    <div class="button-list">
        <button id="alert">Alert</button>
        <button id="confirm">Confirm</button>
        <button id="prompt">Prompt</button>
        <button id="prompt-password">Prompt (Password)</button>
        <button id="prompt-default">Prompt (With defaults)</button>
        <button id="progress">Progress</button>
        <button id="progress-2">Progress (With percentage)</button>
        <button id="open-file">Open File</button>
        <button id="open-files">Open Files</button>
        <button id="open-directory">Open Directory</button>
        <button id="download-file">Download File</button>
        <button id="download-file-url">Download File (URL)</button>
        <button id="runtime-info">Runtime Info</button>
    </div>
</body>

</html>
