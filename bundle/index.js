!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self)["@ayonli/jsext"]=t()}(this,(function(){"use strict";var e="undefined"!=typeof document?document.currentScript:null;function t(e,t){if(e.length!==t.length)return!1;for(let r=0;r<e.length;r++)if(e[r]!==t[r])return!1;return!0}function r(e,t){const r=[],n=e.length;let o=0;for(let s=0;s<n;s++)e[s]===t&&(r.push(e.slice(o,s)),o=s+1);if(o<n)r.push(e.slice(o,n));else if(o===n){const t=e.constructor;"function"==typeof t.from?r.push(t.from([])):r.push(new t([]))}return r}function n(e,t){const r=e.length,n=Math.ceil(r/t),o=new Array(n);let s=0,i=0;for(;s<r;)o[i]=e.slice(s,s+t),s+=t,i++;return o}const o=String.prototype.trim,s=String.prototype.trimEnd,i=String.prototype.trimStart;function a(e,t=""){return t?l(u(e,t),t):o.call(e)}function l(e,t=""){if(t){let r=e.length;for(;r--&&-1!==t.indexOf(e[r]););return e.substring(0,r+1)}return s.call(e)}function u(e,t=""){if(t){let r=0;do{}while(-1!==t.indexOf(e[r])&&++r);return e.substring(r)}return i.call(e)}const c=new TextEncoder;function*f(e,t,r=1,n=!1){let o=e;for(;;)if(yield o,(o+=r)>t){if(!n)break;o=e}}function h(e,r){return e instanceof Uint8Array&&r instanceof Uint8Array&&t(e,r)}function p(e,t){return r(e,t)}function d(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function y(e,t){return t.reduce(((t,r)=>(r in e&&void 0!==e[r]&&(t[r]=e[r]),t)),{})}function w(e,t){const r=Reflect.ownKeys(e).filter((e=>!t.includes(e))),n=y(e,r);return e instanceof Error&&["name","message","cause"].forEach((r=>{t.includes(r)||void 0===e[r]||d(n,r)||(n[r]=e[r])})),n}function v(e){return!(null==e||Object.is(e,NaN)||e instanceof Date&&"Invalid Date"===e.toString())}function m(...e){return e.reduce(((e,t)=>e+t),0)}String.compare=function(e,t){return e<t?-1:e>t?1:0},String.random=function(e){const t="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";let r="";for(;0<e--;){r+=t[Math.floor(62*Math.random())]}return r},String.prototype.count=function(e){return function(e,t){return t?e?e.split(t).length-1:0:e.length+1}(String(this),e)},String.prototype.capitalize=function(e){return function(e,t){const r=t?/\w+/g:/\w+/;return e.replace(r,(e=>e[0].toUpperCase()+e.slice(1).toLowerCase()))}(String(this),e)},String.prototype.hyphenate=function(){return String(this).replace(/(\S)\s+(\S)/g,((e,t,r)=>t+"-"+r))},String.prototype.words=function(){return function(e){const t=e.match(/\w+/g);return t?[...t]:[]}(String(this))},String.prototype.chunk=function(e){return function(e,t){return n(e,t)}(String(this),e)},String.prototype.truncate=function(e){return function(e,t){return t<=0?"":t>=e.length?e:(t-=3,e.slice(0,t)+"...")}(String(this),e)},String.prototype.trim=function(e=""){return a(String(this),e)},String.prototype.trimEnd=function(e=""){return l(String(this),e)},String.prototype.trimStart=function(e=""){return u(String(this),e)},String.prototype.byteLength=function(){return e=String(this),c.encode(e).byteLength;var e},Number.isFloat=function(e){return!("number"!=typeof e||Number.isNaN(e)||Number.isFinite(e)&&e%1==0)},Number.isNumeric=function(e){const t=typeof e;if("number"===t||"bigint"===t)return!0;if("string"===t){if(!Number.isNaN(e))return!0;try{return BigInt(e),!0}catch(e){return!1}}return!1},Number.isBetween=function(e,[t,r]){return e>=t&&e<=r},Number.random=function(e,t){return e+Math.floor(Math.random()*(t-e+1))},Number.sequence=f,Array.prototype.first=function(){return this[0]},Array.prototype.last=function(){return this[this.length-1]},Array.prototype.count=function(e){return function(e,t){let r=0;for(let n=0;n<e.length;n++)e[n]===t&&r++;return r}(this,e)},Array.prototype.equals=function(e){return t(this,e)},Array.prototype.split=function(e){return r(this,e)},Array.prototype.chunk=function(e){return n(this,e)},Array.prototype.uniq=function(){return[...new Set(this)]},Array.prototype.shuffle=function(){return function(e){for(let t=e.length-1;t>0;t--){const r=Math.floor(Math.random()*(t+1));[e[t],e[r]]=[e[r],e[t]]}return e}(this)},Array.prototype.toShuffled=function(){return this.slice().shuffle()},Array.prototype.toReversed||(Array.prototype.toReversed=function(){return this.slice().reverse()}),Array.prototype.toSorted||(Array.prototype.toSorted=function(e){return this.slice().sort(e)}),Array.prototype.orderBy=function(e,t="asc"){return function(e,t,r="asc"){const n=e.slice();return n.sort(((e,r)=>{if("object"!=typeof e||"object"!=typeof r||!e||!r||Array.isArray(e)||Array.isArray(r))return-1;const n=e[t],o=r[t];return void 0===n||void 0===o?-1:"number"==typeof n&&"number"==typeof o?n-o:"string"==typeof n&&"string"==typeof o||"bigint"==typeof n&&"bigint"==typeof o?n<o?-1:1:-1})),"desc"===r&&n.reverse(),n}(this,e,t)},Array.prototype.groupBy=function(e,t=Object){return function(e,t,r=Object){if(r===Map){const r=new Map;for(let n=0;n<e.length;n++){const o=e[n],s=t(o,n),i=r.get(s);i?i.push(o):r.set(s,[o])}return r}{const r={};for(let n=0;n<e.length;n++){const o=e[n],s=t(o,n),i=r[s];i?i.push(o):r[s]=[o]}return r}}(this,e,t)},Uint8Array.compare=function(e,t){if(e===t)return 0;for(let r=0;r<e.length;r++){const n=e[r],o=t[r];if(void 0===o)return 1;if(n<o)return-1;if(n>o)return 1}return e.length<t.length?-1:0},Uint8Array.prototype.equals=function(e){return h(this,e)},Uint8Array.prototype.split=function(e){return p(this,e)},Uint8Array.prototype.chunk=function(e){return function(e,t){return n(e,t)}(this,e)},Object.hasOwn||(Object.hasOwn=d),Object.hasOwnMethod||(Object.hasOwnMethod=function(e,t){var r;const n=Object.getPrototypeOf(e);return!(!n||!d(n,t))&&"function"==typeof(null===(r=Object.getOwnPropertyDescriptor(n,t))||void 0===r?void 0:r.value)}),Object.patch=function(e,...t){for(const r of t)for(const t of Reflect.ownKeys(r))d(e,t)&&void 0!==e[t]||(e[t]=r[t]);return e},Object.pick=y,Object.omit=w,Object.as=function(e,t){if("function"!=typeof t)throw new TypeError("type must be a valid constructor");let r;const n={string:String,number:Number,bigint:BigInt,boolean:Boolean,symbol:Symbol};return e instanceof t?[String,Number,Boolean].includes(t)?e.valueOf():e:(r=typeof e)&&n[r]===t?e:null},Object.isValid=v,Math.sum=m,Math.avg=function(...e){return m(...e)/e.length},Math.product=function(...e){var t;return e.slice(1).reduce(((e,t)=>e*t),null!==(t=e[0])&&void 0!==t?t:0)},Promise.timeout=async function(e,t){return await Promise.race([e,new Promise(((e,r)=>setTimeout((()=>{r(new Error(`operation timeout after ${t}ms`))}),t)))])},Promise.after=async function(e,t){const[r]=await Promise.allSettled([e,new Promise((e=>setTimeout(e,t)))]);if("fulfilled"===r.status)return r.value;throw r.reason},Promise.sleep=async function(e){return new Promise((t=>setTimeout(t,e)))},Promise.until=async function(e){for(;!1===await e();)await new Promise((e=>setTimeout(e)))};const b=Symbol("inverse");class g extends Map{get[Symbol.toStringTag](){return"BiMap"}constructor(e=null){if(super(),this[b]=new Map,e)for(const[t,r]of e)this.set(t,r)}set(e,t){return super.set(e,t),this[b].set(t,e),this}getKey(e){return this[b].get(e)}hasValue(e){return this[b].has(e)}deleteValue(e){if(this[b].has(e)){const t=this[b].get(e);return super.delete(t),this[b].delete(e),!0}return!1}clear(){super.clear(),this[b].clear()}}const k=Symbol("internal");class j{get[Symbol.toStringTag](){return"CiMap"}get size(){return this[k].size}constructor(e=null){if(this[k]=new Map,e)for(const[t,r]of e)this.set(t,r)}set(e,t){const r=String(e).toLowerCase();return this[k].set(r,{key:e,value:t}),this}get(e){var t;const r=String(e).toLowerCase();return null===(t=this[k].get(r))||void 0===t?void 0:t.value}has(e){const t=String(e).toLowerCase();return this[k].has(t)}delete(e){const t=String(e).toLowerCase();return this[k].delete(t)}clear(){this[k].clear()}*entries(){for(const{key:e,value:t}of this[k].values())yield[e,t]}*keys(){for(const{key:e}of this[k].values())yield e}*values(){for(const{value:e}of this[k].values())yield e}forEach(e,t){this[k].forEach((({key:t,value:r})=>{e(r,t,this)}),t)}[Symbol.iterator](){return this.entries()}}globalThis.BiMap=g,globalThis.CiMap=j;class S extends Error{constructor(e,t=0){super(e),this.code=0,"number"==typeof t?this.code=t:(t.cause&&Object.defineProperty(this,"cause",{configurable:!0,enumerable:!1,writable:!0,value:t.cause}),t.code&&(this.code=t.code))}}function P(e){return w(e,["toString","toJSON"])}function O(e){var t;if(!(null==e?void 0:e.name))return null;let r=globalThis[e.name];r||(r="Exception"===e.name?S:Error);const n=Object.create(r.prototype,{message:{configurable:!0,enumerable:!1,writable:!0,value:null!==(t=e.message)&&void 0!==t?t:""}});n.name!==e.name&&Object.defineProperty(n,"name",{configurable:!0,enumerable:!1,writable:!0,value:e.name}),void 0!==e.stack&&Object.defineProperty(n,"stack",{configurable:!0,enumerable:!1,writable:!0,value:e.stack}),null!=e.cause&&Object.defineProperty(n,"cause",{configurable:!0,enumerable:!1,writable:!0,value:e.cause});return Reflect.ownKeys(e).filter((e=>!["name","message","stack","cause"].includes(e))).forEach((t=>{n[t]=e[t]})),n}Object.defineProperty(S.prototype,"name",{configurable:!0,enumerable:!1,writable:!0,value:"Exception"}),globalThis.Exception=S,Error.toObject=P,Error.fromObject=O,Error.prototype.toJSON=function(){return P(this)};const x=new Map;function E(e,t){if(null==e)return null;if("function"==typeof t.fromJSON)return t.fromJSON(e);if("boolean"==typeof e)return t===Boolean?e:null;if("number"==typeof e){if(t===Number)return e;if(t!==BigInt)return null;try{return BigInt(e)}catch(e){return null}}else if("string"==typeof e){if(t===String)return e;if(t===Date){const t=new Date(e);return v(t)?t:null}if(t!==BigInt)return null;try{return BigInt(e)}catch(e){return null}}else if(Array.isArray(e)){if(t===Array)return e;if(t.prototype instanceof Array)return t.from(e);if("function"!=typeof t.prototype[Symbol.iterator]||"function"!=typeof t.from)return null;try{return t.from(e)}catch(e){return null}}else{if([String,Number,Boolean,Date,Array].includes(t))return null;{if("Buffer"===e.type&&Array.isArray(e.data))if("function"==typeof Buffer&&t===Buffer)try{return Buffer.from(e.data)}catch(e){return null}else{if("function"!=typeof t.prototype[Symbol.iterator]||"function"!=typeof t.from)return null;try{return t.from(e.data)}catch(e){return null}}const r=Object.getOwnPropertyNames(e),n=Object.values(e);if(!r.slice(0,50).map(Number).every((e=>!Number.isNaN(e)))||!n.slice(0,50).map(Number).every((e=>!Number.isNaN(e)))||"function"!=typeof t.prototype[Symbol.iterator]||"function"!=typeof t.from){if(t.prototype instanceof Error){const r=O(e);if(r){const n=x.get(t.prototype);if(n)for(const t of Reflect.ownKeys(e)){const o=n[t];o&&(r[t]=E(e[t],o))}}return r}{const r=Object.create(t.prototype),n=x.get(t.prototype);if(n)for(const t of Reflect.ownKeys(e)){const o=n[t];r[t]=o?E(e[t],o):e[t]}else Object.assign(r,e);return r}}try{return t.from(Object.values(e))}catch(e){return null}}}}function I(e){return"object"==typeof e&&null!==e&&"function"==typeof e.next}function A(e){return function(e){return I(e)&&"function"==typeof e[Symbol.iterator]}(e)&&N(e)}function M(e){return function(e){return I(e)&&"function"==typeof e[Symbol.asyncIterator]}(e)&&N(e)}function N(e){return"function"==typeof e.return&&"function"==typeof e.throw}JSON.parseAs=function(e,t){return E(JSON.parse(e),t)},JSON.as=E,JSON.type=function(e){return(t,r)=>{const n=x.get(t);n?n[r]=e:x.set(t,{[r]:e})}},Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")),Symbol.asyncIterator||Object.defineProperty(Symbol,"asyncIterator",{value:Symbol("Symbol.asyncIterator")});const T=Symbol("GeneratorSource"),W=Symbol("GeneratorStatus"),_=Symbol("GeneratorResult");class L{constructor(e){this[T]=e,this[W]="suspended",this[_]=void 0}then(e,t){let r;var n;return void 0===this[T]||"closed"===this[W]?r=Promise.resolve(this[_]):"erred"===this[W]?r=Promise.reject(this[T]):"function"==typeof this[T].then?r=Promise.resolve(this[T]):"function"==typeof this[T].next?(n=this[T],r=new Promise(((e,t)=>{function r(e){try{s(n.next(e))}catch(e){t(e)}}function o(e){var r;try{s(null===(r=n.throw)||void 0===r?void 0:r.call(n,e))}catch(e){t(e)}}function s(t){Promise.resolve(t).then((t=>{t.done?e(t.value):new Promise((e=>{e(t.value)})).then(r,o)}))}s(n.next())}))):r=Promise.resolve(this[T]),this[W]="closed",r.then((e=>this[_]=e)).then(e,t)}catch(e){return Promise.resolve(this).then(null,e)}}class U extends L{next(...e){const t=e[0];let r;if(void 0===this[T]||"closed"===this[W])r={value:void 0,done:!0};else{if("erred"===this[W])return this.throw(this[T]);r="function"==typeof this[T].next?this[T].next(t):{value:this[T],done:!0}}return!0===r.done&&(this[W]="closed",this[_]=r.value),r}return(e){return this[W]="closed",this[_]=e,this[T]&&"function"==typeof this[T].return?this[T].return(e):{value:e,done:!0}}throw(e){if(this[W]="closed",this[T]&&"function"==typeof this[T].throw)return this[T].throw(e);throw e}[Symbol.iterator](){return this}}class D extends L{next(...e){const t=e[0];let r;return r=void 0===this[T]||"closed"===this[W]?Promise.resolve({value:void 0,done:!0}):"function"==typeof this[T].next?Promise.resolve(this[T].next(t)):Promise.resolve(this[T]).then((e=>({value:e,done:!0}))),r.then((e=>(!0===e.done&&(this[W]="closed",this[_]=e.value),e)))}return(e){return this[W]="closed",Promise.resolve(e).then((e=>(this[_]=e,this[T]&&"function"==typeof this[T].return?Promise.resolve(this[T].return(e)):Promise.resolve({value:e,done:!0}))))}throw(e){return this[W]="closed",this[T]&&"function"==typeof this[T].throw?Promise.resolve(this[T].throw(e)):Promise.reject(e)}[Symbol.asyncIterator](){return this}}const R=function(e){if(!(this instanceof R))return new R(e);function t(...t){try{const n=e.apply(this,t);return"function"==typeof n.then||null!==(r=n)&&"object"==typeof r&&"function"==typeof r.next&&"function"==typeof r.return&&"function"==typeof r.throw&&"function"==typeof r[Symbol.asyncIterator]?new D(n):new U(n)}catch(e){return Object.assign(new U(e),{[W]:"erred"})}var r}return t.prototype=R,t.__proto__=this,t};function B(e){return"function"==typeof e}function C(e,t){const r=function(...r){return t.call(this,e,...r)};return Object.defineProperty(r,"name",Object.getOwnPropertyDescriptor(e,"name")),Object.defineProperty(r,"length",Object.getOwnPropertyDescriptor(e,"length")),Object.defineProperty(r,"toString",{configurable:!0,enumerable:!1,writable:!0,value:e.toString.bind(e)}),r}R.create=function(e){return new R(e)},Object.setPrototypeOf(R,Function),Object.setPrototypeOf(R.prototype,Function.prototype),R.create;const F=new Map;function z(e,t,r=!1){const n=Reflect.ownKeys(t);for(const o of n)"constructor"!=o&&(r?o in e||J(e,t,o):d(e,o)||J(e,t,o));return e}function G(e,t,r=!1){z(e.prototype,t.prototype,r);const n=Object.getPrototypeOf(t);n.name&&G(e,n,!0)}function J(e,t,r){const n=Object.getOwnPropertyDescriptor(t,r);n?Object.defineProperty(e,r,n):e[r]=t[r]}var q;const K=f(1,Number.MAX_SAFE_INTEGER),$=Symbol.for("id");class H{constructor(e=0){if(this[q]=K.next().value,this.buffer=[],this.producers=[],this.consumers=[],this.error=null,this.state=1,e<0)throw new RangeError("the capacity of a channel must not be negative");this.capacity=e}push(e){if(1!==this.state)throw new Error("the channel is closed");if(this.consumers.length){const t=this.consumers.shift();return Promise.resolve(t(null,e))}return this.capacity&&this.buffer.length<this.capacity?(this.buffer.push(e),Promise.resolve(void 0)):new Promise((t=>{this.producers.push((()=>{if(this.capacity){const r=this.buffer.shift();return this.buffer.push(e),t(),r}return t(),e}))}))}pop(){if(this.buffer.length){const e=this.buffer.shift();return 2!==this.state||this.buffer.length||(this.state=0),Promise.resolve(e)}if(this.producers.length){const e=this.producers.shift();return 2!==this.state||this.producers.length||(this.state=0),Promise.resolve(e())}if(0===this.state)return Promise.resolve(void 0);if(this.error){const{error:e}=this;return this.state=0,this.error=null,Promise.reject(e)}return 2===this.state?(this.state=0,Promise.resolve(void 0)):new Promise(((e,t)=>{this.consumers.push(((r,n)=>{2!==this.state||this.consumers.length||(this.state=0),r?t(r):e(n)}))}))}close(e=null){if(1!==this.state)return;let t;for(this.state=2,this.error=e;t=this.consumers.shift();)t(e,void 0)}[(q=$,Symbol.asyncIterator)](){const e=this;return{async next(){const t=e.buffer.length,r=e.producers.length;return{value:await e.pop(),done:0===e.state&&!t&&!r}}}}}function V(e=0){return new H(e)}class X{constructor(e,t=0){this.channel=V(t),(async()=>{var t;for await(const r of this.channel)try{await e.call(void 0,r)}catch(e){null===(t=this.errorHandler)||void 0===t||t.call(this,e)}})().catch((e=>{var t;null===(t=this.errorHandler)||void 0===t||t.call(void 0,e)}))}push(e){return this.channel.push(e)}close(){var e;null===(e=this.channel)||void 0===e||e.close()}onError(e){this.errorHandler=e}}const Z="object"==typeof Bun,Q=new Map;function Y(e,...t){var r,n,o,s;if("function"==typeof e){const o=null!==(r=t[0])&&void 0!==r?r:"",s=null!==(n=t[1])&&void 0!==n&&n;return C(e,(function e(t,...r){return ee(t.name+"()",e,o,s,Z?1:2),t.apply(this,r)}))}return ee(e,t[0],null!==(o=t[1])&&void 0!==o?o:"",null!==(s=t[2])&&void 0!==s&&s,1)}function ee(e,t,r,n,o){var s;if(!n||!Q.has(t)){const i={};Error.captureStackTrace(i,t);let a=null===(s=i.stack.split("\n")[o])||void 0===s?void 0:s.trim(),l=`${e} is deprecated`;if(r&&(l+=", "+r),a){let e=a.indexOf("(");if(-1!==e){e+=1;const t=a.indexOf(")",e);a=a.slice(e,t)}l+=" ("+a+")"}console.warn("DeprecationWarning:",l),n&&Q.set(t,!0)}}var te;const re="object"==typeof Deno,ne="object"==typeof Bun,oe=!re&&!ne&&"object"==typeof process&&!!(null===(te=process.versions)||void 0===te?void 0:te.node),se=new Map,ie=new Map;function ae(e){return e&&"object"==typeof e&&["push","close"].includes(e.type)&&"number"==typeof e.channelId}async function le(e){const t=ie.get(e.channelId);t&&("push"===e.type?t.raw.push(e.value):"close"===e.type&&(t.raw.close(e.value),ie.delete(e.channelId)))}const ue=Symbol.for("shouldTransfer"),ce=/^(\.[\/\\]|\.\.[\/\\]|[a-zA-Z]:|\/)/,fe=oe?!process.argv.includes("--worker-thread"):ne?Bun.isMainThread:"undefined"==typeof WorkerGlobalScope,he=f(1,Number.MAX_SAFE_INTEGER,1,!0),pe=f(1,Number.MAX_SAFE_INTEGER,1,!0),de=new Map;let ye=[];function we(e,t=!1){let r="";if("function"==typeof e){let t=e.toString(),n=t.lastIndexOf("(");if(-1===n)throw new TypeError("the given script is not a dynamic import expression");{n+=1;const e=t.indexOf(")",n);r=a(t.slice(n,e)," '\"'")}}else r=e;return oe&&!/\.[cm]?(js|ts|)x?$/.test(r)&&ce.test(r)&&(r+=ne?".ts":".js"),ce.test(r)||t||(r="./"+r),r}function ve(e){const t={...e,type:e.type||"call"};return t.baseUrl||(re?t.baseUrl="file://"+Deno.cwd()+"/":oe||ne?ce.test(t.script)&&(t.baseUrl="file://"+process.cwd()+"/"):"object"==typeof location&&(t.baseUrl=location.href)),t}function me(e){return e&&"object"==typeof e&&["return","yield","error","gen"].includes(e.type)}async function be(t={}){var r;let{entry:n,adapter:o}=t;if(oe||ne){if(!n){const t=await import("path"),{fileURLToPath:r}=await import("url"),o=r("undefined"==typeof document&&"undefined"==typeof location?require("url").pathToFileURL(__filename).href:"undefined"==typeof document?location.href:e&&e.src||new URL("index.js",document.baseURI).href);if(o===process.argv[1])n=ne?"./node_modules/@ayonli/jsext/worker.ts":"./node_modules/@ayonli/jsext/bundle/worker-node.mjs";else{let e=t.dirname(o);[t.join("jsext","cjs"),t.join("jsext","esm"),t.join("jsext","bundle")].some((t=>e.endsWith(t)))&&(e=t.dirname(e)),n=ne?t.join(e,"worker.ts"):t.join(e,"bundle","worker-node.mjs")}}if("child_process"===o){const{fork:e}=await import("child_process"),t=e(n,["--worker-thread"],{stdio:"inherit",serialization:parseInt(process.version.slice(1))<14?"advanced":"json"}),r=t.pid;return await new Promise(((e,r)=>{t.once("error",r),t.once("message",(()=>{t.off("error",r),e()}))})),{worker:t,workerId:r,kind:"node_process"}}if(oe){const{Worker:e}=await import("worker_threads"),t=new e(n,{argv:["--worker-thread"]}),r=t.threadId;return await new Promise(((e,r)=>{t.once("error",r),t.once("online",(()=>{t.off("error",r),e()}))})),{worker:t,workerId:r,kind:"node_worker"}}{const e=new Worker(n,{type:"module"}),t=he.next().value;return await new Promise(((t,r)=>{e.onerror=e=>{r(new Error(e.message||"unable to start the worker"))},e.addEventListener("open",(()=>{e.onerror=null,t()}))})),{worker:e,workerId:t,kind:"web_worker"}}}if(re)n||(n=[...("undefined"==typeof document&&"undefined"==typeof location?require("url").pathToFileURL(__filename).href:"undefined"==typeof document?location.href:e&&e.src||new URL("index.js",document.baseURI).href).split("/").slice(0,-1),"worker.ts"].join("/"),n.endsWith("/esm/worker.ts")&&(n=n.slice(0,-14)+"/worker.ts"));else{const e=n||"https://ayonli.github.io/jsext/bundle/worker.mjs",t=await fetch(e);let o;if(null===(r=t.headers.get("content-type"))||void 0===r?void 0:r.includes("/javascript"))o=await t.blob();else{const e=await t.arrayBuffer();o=new Blob([new Uint8Array(e)],{type:"application/javascript"})}n=URL.createObjectURL(o)}return{worker:new Worker(n,{type:"module"}),workerId:he.next().value,kind:"web_worker"}}function ge(e,t){const r=[];return e=e.map((e=>e instanceof H?function(e,t){const r=e[$];if(!ie.has(r)){const t=e.push.bind(e),n=e.close.bind(e);ie.set(r,{channel:e,raw:{push:t,close:n}})}return Object.defineProperties(e,{push:{configurable:!0,writable:!0,value:async n=>{if(1!==e.state)throw new Error("the channel is closed");await Promise.resolve(t("push",n,r))}},close:{configurable:!0,writable:!0,value:(n=null)=>{const o=ie.get(r);null==o||o.raw.close(n),t("close",n,r),ie.delete(r),o&&Object.defineProperties(e,{push:{configurable:!0,writable:!0,value:o.raw.push},close:{configurable:!0,writable:!0,value:o.raw.close}})}}}),{"@@type":"Channel","@@id":r,capacity:e.capacity}}(e,((e,r,n)=>{t.then((t=>{"function"==typeof t.postMessage?t.postMessage({type:e,value:r,channelId:n}):t.send({type:e,value:r,channelId:n})}))})):e[ue]?(r.push(e),e):e)),{args:e,transferable:r}}function ke(e,t,r,n=void 0){const o=pe.next().value;de.set(o,{});let s=async function(e){let t=ye.find((e=>!e.tasks.size));t?t.lastAccess=Date.now():ye.length<Pe.maxWorkers?ye.push(t={getWorker:(async()=>{let e=(await be({entry:Pe.workerEntry,adapter:"worker_threads"})).worker;const r=n=>{var o,s;if(ae(n))le(n);else if(me(n)&&n.taskId){const i=de.get(n.taskId);if(!i)return;if("return"===n.type||"error"===n.type){if("error"===n.type?i.resolver?(i.resolver.reject(n.error),i.channel&&i.channel.close()):i.channel?i.channel.close(n.error):i.error=n.error:(i.resolver?i.resolver.resolve(n.value):i.result={value:n.value},i.channel&&i.channel.close()),t){t.tasks.delete(n.taskId),t.tasks.size||(oe||ne)&&e.unref();{const e=Date.now(),t=[];ye=ye.filter((r=>{const n=!r.tasks.size&&e-r.lastAccess>=3e5;return n&&t.push(r),!n})),t.forEach((async e=>{(await e.getWorker).terminate()}))}}}else"yield"===n.type?(null===(o=i.channel)||void 0===o||o.push({value:n.value,done:n.done}),n.done&&r({type:"return",value:n.value,taskId:n.taskId})):"gen"===n.type&&(null===(s=i.generate)||void 0===s||s.call(i))}};return oe?e.on("message",r):e.onmessage=e=>r(e.data),e})(),tasks:new Set,lastAccess:Date.now()}):(t=ye[e%ye.length],t.lastAccess=Date.now()),t.tasks.add(e);const r=await t.getWorker;return(oe||ne)&&r.ref(),r}(o);const{args:i,transferable:a}=ge(r,s);return s=s.then((r=>(r.postMessage(ve({script:e,fn:t,args:i,taskId:o,baseUrl:n}),a),r))),new D({then(e,t){const r=de.get(o);return r.error?(de.delete(o),null==t?void 0:t(r.error)):r.result?(de.delete(o),null==e?void 0:e(r.result.value)):new Promise(((e,t)=>{r.resolver={resolve:t=>{de.delete(o),e(t)},reject:e=>{de.delete(o),t(e)}}})).then(e,t)},async next(r){var i;const l=de.get(o);if(l.error){const e=l.error;throw de.delete(o),e}if(l.result){const e=l.result.value;return de.delete(o),{value:e,done:!0}}{null!==(i=l.channel)&&void 0!==i||(l.channel=V(1/0));const u=await s;return l.generate||await new Promise((e=>{l.generate=e})),u.postMessage(ve({script:e,fn:t,args:[r],taskId:o,type:"next",baseUrl:n}),a),await l.channel.pop()}},async return(r){de.delete(o);return(await s).postMessage(ve({script:e,fn:t,args:[r],taskId:o,type:"return",baseUrl:n}),a),{value:r,done:!0}},async throw(r){de.delete(o);throw(await s).postMessage(ve({script:e,fn:t,args:[r],taskId:o,type:"throw",baseUrl:n}),a),r}})}function je(e,t,r,n=void 0){const o=async function(e,t){let r;if(oe||ne){const{fileURLToPath:n}=await import("url"),o=t?n(new URL(e,t).href):e;r=await import(o)}else{const n=new URL(e,t).href;if(r=se.get(n),!r)if(re)r=await import(n),se.set(n,r);else try{r=await import(n),se.set(n,r)}catch(e){if(!String(e).includes("Failed"))throw e;{const e=await fetch(n),t=await e.arrayBuffer(),o=new Blob([new Uint8Array(t)],{type:"application/javascript"}),s=URL.createObjectURL(o);r=await import(s),se.set(n,r)}}}return"object"==typeof r.default&&void 0!==r.default.default&&(r=r.default),r}(e,n).then((e=>e[t](...r)));return new D({then:(e,t)=>o.then(e,t),async next(e){const t=await o;return await t.next(e)},async return(e){const t=await o;return await t.return(e)},throw:async e=>(await o).throw(e)})}function Se(e){var t,r,n;const o=e.split("\n");let s,i;if(s=(null===(t=o[0])||void 0===t?void 0:t.startsWith("Error"))?o[2]:o[1],s){let e=s.lastIndexOf("("),t=0;-1!==e?(e+=1,t=s.indexOf(")",e),s=s.slice(e,t)):s.startsWith("    at ")?s=s.slice(7):"object"==typeof location&&(e=null!==(n=null===(r=s.match(/(https?|file):/))||void 0===r?void 0:r.index)&&void 0!==n?n:-1,e>0&&(s=s.slice(e))),i=s.replace(/:\d+:\d+$/,""),/^(https?|file):/.test(i)||(i="file://"+i)}return i}function Pe(e){const t=we(e,!0);let r;if(ce.test(t))if("function"==typeof Error.captureStackTrace){const e={};Error.captureStackTrace(e),r=Se(e.stack)}else{const e=new Error("");r=Se(e.stack)}return new Proxy(Object.create(null),{get:(e,n)=>({[n]:(...e)=>fe?ke(t,n,e,r):je(t,n,e,r)}[n])})}!function(e){e.maxWorkers="object"==typeof navigator?navigator.hardwareConcurrency:16,e.transfer=function(e){return e[ue]=!0,e}}(Pe||(Pe={}));var Oe=Pe;let xe=[];const Ee=[];async function Ie(e,t=void 0,r=void 0){(null==r?void 0:r.workerEntry)&&Y("options.workerEntry",Ie,"set `run.workerEntry` instead");const n=we(e),o=ve({script:n,fn:(null==r?void 0:r.fn)||"default",args:null!=t?t:[]}),s=(null==r?void 0:r.workerEntry)||Oe.workerEntry;let i,a,l,u,c,f,h=null,p=()=>Promise.resolve(void 0);const d=(null==r?void 0:r.timeout)?setTimeout((()=>{const e=new Error(`operation timeout after ${r.timeout}ms`);h=e,a&&a.reject(e),p()}),r.timeout):null,y=e=>{var t;if(ae(e))le(e);else if(me(e)){if(d&&clearTimeout(d),"error"===e.type)return w(e.error);"return"===e.type?((null==r?void 0:r.keepAlive)?(null==f||f(),Ee.length&&(null===(t=Ee.shift())||void 0===t||t())):p(),a?a.resolve(e.value):i={value:e.value},null==l||l.close()):"yield"===e.type&&(e.done?y({type:"return",value:e.value}):null==l||l.push(e.value))}},w=e=>{e=e instanceof Error?e:"object"==typeof e?O(e):e,h=e,d&&clearTimeout(d),a&&a.reject(e),null==l||l.close(e)},v=()=>{var e;d&&clearTimeout(d),c&&(xe=xe.filter((e=>e!==c)),Ee.length&&(null===(e=Ee.shift())||void 0===e||e())),a?h?a.reject(h):a.resolve(void 0):h||i||(i={value:void 0}),null==l||l.close(h)};if(oe||ne)if("child_process"===(null==r?void 0:r.adapter)){let e;if(c=xe.find((e=>"child_process"===e.adapter&&!e.busy)),c){const t=await c.getWorker;e=t.worker,u=t.workerId,c.busy=!0}else{if(!(xe.length<Oe.maxWorkers))return new Promise((e=>{Ee.push(e)})).then((()=>Ie(n,t,r)));{xe.push(c={getWorker:be({entry:s,adapter:"child_process"}),adapter:"child_process",busy:!0});const t=await c.getWorker;e=t.worker,u=t.workerId}}if(f=()=>{e.unref(),e.off("message",y),c&&(c.busy=!1)},p=()=>Promise.resolve(void e.kill(1)),e.ref(),e.on("message",y),e.once("error",w),e.once("exit",v),h)throw await p(),h;const{args:t}=ge(o.args,Promise.resolve(e));o.args=t,e.send(o)}else if(oe){let e;if(c=xe.find((e=>"worker_threads"===e.adapter&&!e.busy)),c){const t=await c.getWorker;e=t.worker,u=t.workerId,c.busy=!0}else{if(!(xe.length<Oe.maxWorkers))return new Promise((e=>{Ee.push(e)})).then((()=>Ie(n,t,r)));{xe.push(c={getWorker:be({entry:s,adapter:"worker_threads"}),adapter:"worker_threads",busy:!0});const t=await c.getWorker;e=t.worker,u=t.workerId}}if(f=()=>{e.unref(),e.off("message",y),c&&(c.busy=!1)},p=async()=>{await e.terminate()},e.ref(),e.on("message",y),e.once("error",w),e.once("messageerror",w),e.once("exit",v),h)throw await p(),h;const{args:t,transferable:i}=ge(o.args,Promise.resolve(e));o.args=t,e.postMessage(o,i)}else{let e;if(c=xe.find((e=>"worker_threads"===e.adapter&&!e.busy)),c){const t=await c.getWorker;e=t.worker,u=t.workerId,c.busy=!0}else{if(!(xe.length<Oe.maxWorkers))return new Promise((e=>{Ee.push(e)})).then((()=>Ie(n,t,r)));{xe.push(c={getWorker:be({entry:s}),adapter:"worker_threads",busy:!0});const t=await c.getWorker;e=t.worker,u=t.workerId}}if(f=()=>{e.onmessage=null,c&&(c.busy=!1)},p=async()=>{await Promise.resolve(e.terminate()),v()},e.onmessage=e=>y(e.data),e.onerror=e=>y(e.error||new Error(e.message)),e.onmessageerror=()=>{w(new Error("unable to deserialize the message"))},h)throw await p(),h;const{args:t,transferable:i}=ge(o.args,Promise.resolve(e));o.args=t,e.postMessage(o,i)}else{let e;if(c=xe.find((e=>"worker_threads"===e.adapter&&!e.busy)),c){const t=await c.getWorker;e=t.worker,u=t.workerId,c.busy=!0}else{if(!(xe.length<Oe.maxWorkers))return new Promise((e=>{Ee.push(e)})).then((()=>Ie(n,t,r)));{xe.push(c={getWorker:be({entry:s}),adapter:"worker_threads",busy:!0});const t=await c.getWorker;e=t.worker,u=t.workerId}}if(f=()=>{e.onmessage=null,c&&(c.busy=!1)},p=async()=>{await Promise.resolve(e.terminate()),v()},e.onmessage=e=>y(e.data),e.onerror=e=>y(e.error||new Error(e.message)),e.onmessageerror=()=>{w(new Error("unable to deserialize the message"))},h)throw await p(),h;const{args:t,transferable:i}=ge(o.args,Promise.resolve(e));o.args=t,e.postMessage(o,i)}return{workerId:u,async abort(e=void 0){d&&clearTimeout(d),e&&(h=e instanceof Error?e:"string"==typeof e?new Error(e):new Error("operation aborted",{cause:e})),await p()},result:async()=>await new Promise(((e,t)=>{h?t(h):i?e(i.value):a={resolve:e,reject:t}})),iterate(){if(a)throw new Error("result() has been called");if(i)throw new TypeError("the response is not iterable");return l=V(1/0),{[Symbol.asyncIterator]:l[Symbol.asyncIterator].bind(l)}}}}Object.defineProperties(Ie,{maxWorkers:{set(e){Oe.maxWorkers=e},get:()=>Oe.maxWorkers},workerEntry:{set(e){Oe.workerEntry=e},get:()=>Oe.workerEntry}});const Ae=async function(){}.constructor,Me=async function*(){}.constructor,Ne={try:function e(t,...r){if(B(t))try{return e(t.apply(void 0,r))}catch(e){return[e,void 0]}let n=t;return n instanceof D?(n=n.then((e=>[null,e])),Promise.resolve(n).catch((e=>[e,void 0]))):M(n)?async function*(){let e,t;for(;;)try{const{done:r,value:o}=await n.next(e);if(r){t=o;break}e=yield Promise.resolve([null,o])}catch(e){yield Promise.resolve([e,void 0]);break}return[null,t]}():A(n)?function*(){let e,t;for(;;)try{const{done:r,value:o}=n.next(e);if(r){t=o;break}e=yield[null,o]}catch(e){yield[e,void 0];break}return[null,t]}():B(null==n?void 0:n.then)?(n=n.then((e=>[null,e])),Promise.resolve(n).catch((e=>[e,void 0]))):[null,n]},func:function(e){return function(...t){var r;const n=[],o=e=>{n.push(e)};let s;try{const r=e.call(this,o,...t);if(M(r)){const e=async function*(){var e;let t;for(;;)try{const{done:e,value:n}=await r.next(t);if(e){s={value:n,error:null};break}t=yield Promise.resolve(n)}catch(e){s={value:void 0,error:e};break}for(let t=n.length-1;t>=0;t--)await(null===(e=n[t])||void 0===e?void 0:e.call(n));if(s.error)throw s.error;return s.value}();return e}if(A(r)){const e=function*(){var e;let t;for(;;)try{const{done:e,value:n}=r.next(t);if(e){s={value:n,error:null};break}t=yield n}catch(e){s={value:void 0,error:e};break}for(let t=n.length-1;t>=0;t--)null===(e=n[t])||void 0===e||e.call(n);if(s.error)throw s.error;return s.value}();return e}if("function"==typeof(null==r?void 0:r.then))return Promise.resolve(r).then((e=>({value:e,error:null}))).catch((e=>({value:void 0,error:e}))).then((async e=>{var t;for(let e=n.length-1;e>=0;e--)await(null===(t=n[e])||void 0===t?void 0:t.call(n));if(e.error)throw e.error;return e.value}));s={value:r,error:null}}catch(e){s={value:void 0,error:e}}for(let e=n.length-1;e>=0;e--)null===(r=n[e])||void 0===r||r.call(n);if(s.error)throw s.error;return s.value}},wrap:C,throttle:function(e,t){const r="number"==typeof t?null:t.for,n="number"==typeof t?t:t.duration,o="number"!=typeof t&&!!(null==t?void 0:t.noWait),s=function(t,...r){var s;if(t.result&&(t.pending&&o||Date.now()<(null!==(s=t.expires)&&void 0!==s?s:0))){if(t.result.error)throw t.result.error;return t.result.value}if(t.pending)return t.pending;try{const s=e.call(this,...r);if("function"==typeof(null==s?void 0:s.then)){if(t.pending=s.then((e=>(t.pending=void 0,t.result={value:e},t.expires=Date.now()+n,e))).catch((e=>{throw t.pending=void 0,t.result={error:e},t.expires=Date.now()+n,e})),o&&t.result){if(t.result.error)throw t.result.error;return t.result.value}return t.pending}return t.result={value:s},t.expires=Date.now()+n,s}catch(e){throw t.result={error:e},t.expires=Date.now()+n,e}};if(r){let e=F.get(r);return e||(e={for:r},F.set(r,e)),function(...t){return s.call(this,e,...t)}}{const e={for:null};return function(...t){return s.call(this,e,...t)}}},mixins:function(e,...t){const r={ctor:null};r.ctor=class extends e{};for(const e of t)if("function"==typeof e)G(r.ctor,e);else{if(!e||"object"!=typeof e)throw new TypeError("mixin must be a constructor or an object");z(r.ctor.prototype,e)}return r.ctor},isSubclassOf:function(e,t){return"function"==typeof e&&"function"==typeof t&&e.prototype instanceof t},chan:V,queue:function(e,t=0){return new X(e,t)},read:function(e,t=void 0){var r;if(B(e[Symbol.asyncIterator]))return e;const n=V(1/0),o=n.push.bind(n),s=n.close.bind(n),i=e=>{let t;t=e instanceof ErrorEvent?e.error||new Error(e.message):new Error("something went wrong",{cause:e}),s(t)},a=Object.getPrototypeOf(e),l=Object.getOwnPropertyDescriptor(a,"onmessage");if((null==l?void 0:l.set)&&B(e.close)){const n=Object.getOwnPropertyDescriptor(a,"onerror"),u=Object.getOwnPropertyDescriptor(a,"onclose");let c;if((null==t?void 0:t.event)&&"message"!==(null==t?void 0:t.event)&&B(e.addEventListener)){const r=e,n=t.event,s=e=>{o(e.data)};r.addEventListener(n,s),c=()=>{r.removeEventListener(n,s)}}else l.set.call(e,(e=>{o(e.data)})),c=()=>{var t;null===(t=l.set)||void 0===t||t.call(e,null)};if(null===(r=null==n?void 0:n.set)||void 0===r||r.call(e,i),null==u?void 0:u.set)u.set.call(e,(()=>{var t,r;s(),null===(t=u.set)||void 0===t||t.call(e,null),null===(r=null==n?void 0:n.set)||void 0===r||r.call(e,null),null==c||c()}));else if(!(null==u?void 0:u.set)&&B(e.close)){const t=e,r=t.close;t.close=function(){var o;r.call(t),s(),t.close=r,null===(o=null==n?void 0:n.set)||void 0===o||o.call(e,null),null==c||c()}}}else if(B(e.send)&&B(e.close)){const t=e;t.onmessage=e=>{o(e.data)},t.onerror=i,t.onclose=()=>{s(),t.onclose=null,t.onerror=null,t.onmessage=null}}else if(B(e.addEventListener)){const r=e,n=(null==t?void 0:t.message)||"message",a=(null==t?void 0:t.error)||"error",l=(null==t?void 0:t.close)||"close",u=e=>{e instanceof MessageEvent&&o(e.data)};r.addEventListener(n,u),r.addEventListener(a,i),r.addEventListener(l,(function e(){s(),r.removeEventListener(l,e),r.removeEventListener(n,u),r.removeEventListener(a,i)}))}else{if(!B(e.on))throw new TypeError("the input source cannot be read as an AsyncIterable object");{const r=e;let n,i,a;"object"==typeof process&&e===process?(n="message",i="uncaughtException",a="exit"):B(e.send)&&B(e.kill)||B(e.postMessage)&&B(e.terminate)||B(e.postMessage)&&B(e.close)?(n="message",i="error",a="exit"):(n=(null==t?void 0:t.data)||"data",i=(null==t?void 0:t.error)||"error",a=(null==t?void 0:t.close)||"close"),r.on(n,o),r.once(i,s),r.once(a,(()=>{s(),r.off(n,o),r.off(i,s)}))}}return{[Symbol.asyncIterator]:n[Symbol.asyncIterator].bind(n)}},readAll:async function(e){const t=[];for await(const r of e)t.push(r);return t},run:Ie,parallel:Oe,example:function e(t,r=void 0){const n={};return Error.captureStackTrace(n,e),async function(...e){let o=t.toString().split("\n").slice(1,-1),s=o.findIndex((e=>"// output:"===e.trim().toLowerCase()));if(-1===s)return;if(s+=1,o=o.slice(s),-1!==o.findIndex((e=>"// output:"===e.trim().toLowerCase())))throw new Error("there can only be one output comment in the example");let i=[];for(let e of o){if(e=e.trimStart(),!e.startsWith("//"))throw new Error("the output comment must be at the end of the example");if(e[2]&&" "!==e[2])throw new Error("the output comment must start with '// '");i.push(e.slice(3))}const a=[...i];i=[];for(let e=a.length-1;e>=0;e--)""!==a[e]&&i.push(a[e]);i.reverse();const l=await import("node:assert"),{Writable:u}=await import("node:stream"),{Console:c}=await import("node:console"),f=[],h=new TextDecoder,p=new u({write(e,t,r){f.push(e),r()}}),d=new c(p),y=t.call(this,d,...e);"function"==typeof(null==y?void 0:y.then)&&await y,await new Promise((e=>p.end((()=>e())))),await(async()=>{var e;const t=f.map((e=>h.decode(e))).join("\n").replace(/[\n]+$/,""),o=i.join("\n");try{if(l.ok(t===o,`\nexpected:\n${o}\n\ngot:\n${t}`),!(null==r?void 0:r.suppress))for(const e of f)"object"==typeof Deno?await Deno.stdout.write(e):"object"==typeof process&&await new Promise((t=>process.stdout.write(e,(()=>t()))))}catch(t){throw Object.defineProperty(t,"stack",{configurable:!0,writable:!0,enumerable:!1,value:t.stack+"\n"+(null===(e=n.stack)||void 0===e?void 0:e.split("\n").slice(1).join("\n"))}),t}})()}},deprecate:Y};return globalThis.AsyncFunction=Ae,globalThis.AsyncGeneratorFunction=Me,Ne}));
//# sourceMappingURL=index.js.map
