!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).jsext=t()}(this,(function(){"use strict";var e="undefined"!=typeof document?document.currentScript:null;function equals$3(e,t){if(e===t)return!0;if(e.length!==t.length)return!1;for(let r=0;r<e.length;r++)if(e[r]!==t[r])return!1;return!0}function split$3(e,t){const r=[],n=e.length;let o=0;for(let s=0;s<n;s++)e[s]===t&&(r.push(e.slice(o,s)),o=s+1);if(o<n)r.push(e.slice(o,n));else if(o===n){const t=e.constructor;"function"==typeof t.from?r.push(t.from([])):r.push(new t([]))}return r}function chunk$3(e,t){const r=e.length,n=Math.ceil(r/t),o=new Array(n);let s=0,i=0;for(;s<r;)o[i]=e.slice(s,s+t),s+=t,i++;return o}function isClass(e){if("function"!=typeof e)return!1;if([String,Number,Boolean,BigInt,Symbol].includes(e))return!1;if(void 0===e.prototype)return!1;if(e.prototype.constructor!==e)return!1;const t=e.toString();if("class"===t.slice(0,5))return!0;const r=e.name[0];return!!(r&&r>="A"&&r<="Z"&&t.includes("[native code]"))}function isSubclassOf(e,t){return"function"==typeof e&&"function"==typeof t&&e.prototype instanceof t}function mergeIfNotExists(e,t,r=!1){const n=Reflect.ownKeys(t);for(const o of n)"constructor"!==o&&(r?o in e||setProp(e,t,o):hasOwn(e,o)||setProp(e,t,o));return e}function mergeHierarchy(e,t,r=!1){mergeIfNotExists(e.prototype,t.prototype,r);const n=Object.getPrototypeOf(t);n.name&&mergeHierarchy(e,n,!0)}function setProp(e,t,r){const n=Object.getOwnPropertyDescriptor(t,r);n?Object.defineProperty(e,r,n):e[r]=t[r]}function mixin(e,...t){const r={ctor:null};r.ctor=class extends e{};for(const e of t)if("function"==typeof e)mergeHierarchy(r.ctor,e);else{if(!e||"object"!=typeof e)throw new TypeError("mixin must be a constructor or an object");mergeIfNotExists(r.ctor.prototype,e)}return r.ctor}function hasOwn(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function hasOwnMethod(e,t){var r;const n=Object.getPrototypeOf(e);return!(!n||!hasOwn(n,t))&&"function"==typeof(null===(r=Object.getOwnPropertyDescriptor(n,t))||void 0===r?void 0:r.value)}function patch(e,...t){for(const r of t)for(const t of Reflect.ownKeys(r))hasOwn(e,t)&&void 0!==e[t]||(e[t]=r[t]);return e}function pick(e,t){return t.reduce(((t,r)=>(r in e&&void 0!==e[r]&&(t[r]=e[r]),t)),{})}function omit(e,t){const r=Reflect.ownKeys(e).filter((e=>!t.includes(e))),n=pick(e,r);return e instanceof Error&&["name","message","stack","cause"].forEach((r=>{t.includes(r)||void 0===e[r]||hasOwn(n,r)||(n[r]=e[r])})),n}function as$1(e,t){if("function"!=typeof t)throw new TypeError("type must be a valid constructor");let r;const n={string:String,number:Number,bigint:BigInt,boolean:Boolean,symbol:Symbol};return e instanceof t?[String,Number,Boolean].includes(t)?e.valueOf():e:(r=typeof e)&&n[r]===t?e:null}function typeOf(e){var t,r;if(void 0===e)return"undefined";if(null===e)return"null";const n=typeof e;return"function"===n?isClass(e)?"class":"function":"object"===n?null!==(r=null===(t=Object.getPrototypeOf(e))||void 0===t?void 0:t.constructor)&&void 0!==r?r:Object:n}function isValid(e){return!(null==e||Object.is(e,NaN)||e instanceof Date&&"Invalid Date"===e.toString())}function isPlainObject(e){if("object"!=typeof e||null===e)return!1;const t=Object.getPrototypeOf(e);return null===t||t.constructor===Object}function sanitize$1(e,t=!1,r={}){const{removeNulls:n,removeEmptyStrings:o,removeEmptyObjects:s,removeArrayItems:i}=r;return function process(e,r){if("string"==typeof e)return e.trim();if(Array.isArray(e)){const a=!r||t?e.map((e=>process(e,r+1))):e;return i?a.filter((e=>null===e?!n:""===e?!o:!!isValid(e)&&("object"!=typeof e||(Array.isArray(e)?e.length>0||!s:!isPlainObject(e)||(Reflect.ownKeys(e).length>0||!s))))):a}return isPlainObject(e)&&(!r||t)?Reflect.ownKeys(e).reduce(((t,i)=>{const a=process(e[i],r+1);return null===a?n||(t[i]=a):""===a?o||(t[i]=a):isValid(a)&&("object"!=typeof a?t[i]=a:Array.isArray(a)?(a.length>0||!s)&&(t[i]=a):isPlainObject(a)?(Reflect.ownKeys(a).length>0||!s)&&(t[i]=a):t[i]=a),t}),e.constructor?{}:Object.create(null)):e}(e,0)}function sortKeys(e,t=!1){return function process(e,r){return isPlainObject(e)?!r||t?[...Object.getOwnPropertyNames(e).sort(),...Object.getOwnPropertySymbols(e)].reduce(((t,n)=>(t[n]=process(e[n],r+1),t)),e.constructor?{}:Object.create(null)):e:Array.isArray(e)&&(!r||t)?e.map((e=>process(e,r+1))):e}(e,0)}function flatKeys(e,t=1,r={}){var n;const o=t,s=e.constructor?{}:Object.create(null),i=null!==(n=null==r?void 0:r.flatArrayIndices)&&void 0!==n&&n;return isPlainObject(e)||Array.isArray(e)&&i?(function process(e,t,r){r===o?s[t]=e:Array.isArray(e)&&r?i?e.forEach(((e,n)=>{process(e,t?`${t}.${n}`:String(n),t?r+1:r)})):s[t]=e:isPlainObject(e)||Array.isArray(e)&&!r?Reflect.ownKeys(e).forEach((n=>{const o=e[n];"symbol"==typeof n?0===r&&(s[n]=o):process(o,t?`${t}.${n}`:n,t?r+1:r)})):s[t]=e}(e,"",0),s):e}var t=Object.freeze({__proto__:null,as:as$1,flatKeys:flatKeys,hasOwn:hasOwn,hasOwnMethod:hasOwnMethod,isPlainObject:isPlainObject,isValid:isValid,omit:omit,patch:patch,pick:pick,sanitize:sanitize$1,sortKeys:sortKeys,typeOf:typeOf});function sum(...e){return e.reduce(((e,t)=>e+t),0)}function avg(...e){return sum(...e)/e.length}function product(...e){var t;return e.slice(1).reduce(((e,t)=>e*t),null!==(t=e[0])&&void 0!==t?t:0)}var r=Object.freeze({__proto__:null,avg:avg,product:product,sum:sum});const n=new TextEncoder,o=new TextDecoder;class ByteArray extends Uint8Array{toString(){return text(this)}toJSON(){return{type:"ByteArray",data:Array.from(this)}}}function bytes$1(e){return new ByteArray("string"==typeof e?n.encode(e).buffer:e)}function text(e,t="utf8"){var r,n;return"hex"===t?"function"==typeof Buffer?(null!==(r=as$1(e,Buffer))&&void 0!==r?r:Buffer.from(e)).toString("hex"):e.reduce(((e,t)=>e+t.toString(16).padStart(2,"0")),""):"base64"===t?"function"==typeof Buffer?(null!==(n=as$1(e,Buffer))&&void 0!==n?n:Buffer.from(e)).toString("base64"):btoa(o.decode(e)):"function"==typeof Buffer&&e instanceof Buffer?e.toString("utf8"):o.decode(e)}function copy(e,t){return e.length>t.length&&(e=e.subarray(0,t.length)),t.set(e),e.length}function concat(...e){const t=sum(...e.map((e=>e.length))),r=new(0,e[0].constructor)(t);let n=0;for(const t of e)r.set(t,n),n+=t.length;return r}function compare$1(e,t){if(e===t)return 0;for(let r=0;r<e.length;r++){const n=e[r],o=t[r];if(void 0===o)return 1;if(n<o)return-1;if(n>o)return 1}return e.length<t.length?-1:0}function equals$2(e,t){if(e.length<1e3)return equals$3(e,t);if(e===t)return!0;if(e.length!==t.length)return!1;const r=e.length,n=Math.floor(r/4),o=new Uint32Array(e.buffer,0,n),s=new Uint32Array(t.buffer,0,n);for(let o=4*n;o<r;o++)if(e[o]!==t[o])return!1;for(let e=0;e<o.length;e++)if(o[e]!==s[e])return!1;return!0}function split$2(e,t){return split$3(e,t)}function chunk$2(e,t){return chunk$3(e,t)}var s=Object.freeze({__proto__:null,ByteArray:ByteArray,chunk:chunk$2,compare:compare$1,concat:concat,copy:copy,default:bytes$1,equals:equals$2,split:split$2,text:text});const i=chars;function compare(e,t){return e<t?-1:e>t?1:0}function random$2(e,t="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"){const r=i(t);let n="";for(;0<e--;){n+=r[Math.floor(Math.random()*r.length)]}return n}function count$1(e,t){return t?e?e.split(t).length-1:0:e.length+1}function capitalize(e,t){const r=t?/\w+/g:/\w+/;return e.replace(r,(e=>e[0].toUpperCase()+e.slice(1).toLowerCase()))}function hyphenate(e){return e.replace(/(\S)\s+(\S)/g,((e,t,r)=>t+"-"+r))}function bytes(e){return bytes$1(e)}function chars(e){return"function"==typeof(null===Intl||void 0===Intl?void 0:Intl.Segmenter)?Array.from((new Intl.Segmenter).segment(e)).map((e=>e.segment)):Array.from(e)}function words(e){const t=e.match(/\w+/g);return t?[...t].map((e=>e.split("_"))).flat():[]}function lines(e){return e.split(/\r?\n/)}function chunk$1(e,t){return chunk$3(e,t)}function truncate(e,t){return t<=0?"":t>=e.length?e:(t-=3,e.slice(0,t)+"...")}const a=String.prototype.trim,l=String.prototype.trimEnd,c=String.prototype.trimStart;function trim(e,t=""){return t?trimEnd(trimStart(e,t),t):a.call(e)}function trimEnd(e,t=""){if(t){let r=e.length;for(;r--&&-1!==t.indexOf(e[r]););return e.substring(0,r+1)}return l.call(e)}function trimStart(e,t=""){if(t){let r=0;do{}while(-1!==t.indexOf(e[r])&&++r);return e.substring(r)}return c.call(e)}function stripEnd(e,t){return e.endsWith(t)?e.slice(0,-t.length):e}function stripStart(e,t){return e.startsWith(t)?e.slice(t.length):e}function byteLength(e){return bytes$1(e).byteLength}function isAscii(e,t=!1){return t?/^[-~]+$/.test(e):/^[\x00-\x7E]+$/.test(e)}var u=Object.freeze({__proto__:null,byteLength:byteLength,bytes:bytes,capitalize:capitalize,chars:chars,chunk:chunk$1,compare:compare,count:count$1,hyphenate:hyphenate,isAscii:isAscii,lines:lines,random:random$2,stripEnd:stripEnd,stripStart:stripStart,trim:trim,trimEnd:trimEnd,trimStart:trimStart,truncate:truncate,words:words});function isFloat(e){return!("number"!=typeof e||Number.isNaN(e)||Number.isFinite(e)&&e%1==0)}function isNumeric(e,t=!1){const r=typeof e;if(t)return"number"===r&&!Number.isNaN(e);if("bigint"===r)return!0;if("number"===r)return!Number.isNaN(e);if("string"===r&&e)try{return BigInt(e),!0}catch(t){return!Number.isNaN(Number(e))}return!1}function isBetween(e,[t,r]){return e>=t&&e<=r}function random$1(e,t){return e+Math.floor(Math.random()*(t-e+1))}function range(e,t,r=1){return sequence(e,t,r)}function serial(e=!1){return sequence(1,Number.MAX_SAFE_INTEGER,1,e)}function*sequence(e,t,r=1,n=!1){let o=e;for(;;)if(yield o,(o+=r)>t){if(!n)break;o=e}}String.compare=compare,String.random=random$2,String.prototype.count=function count(e){return count$1(String(this),e)},String.prototype.capitalize=function capitalize$1(e){return capitalize(String(this),e)},String.prototype.hyphenate=function capitalize(){return hyphenate(String(this))},String.prototype.bytes=function bytes$1(){return bytes(String(this))},String.prototype.chars=function chars$1(){return chars(String(this))},String.prototype.words=function words$1(){return words(String(this))},String.prototype.lines=function lines$1(){return lines(String(this))},String.prototype.chunk=function chunk(e){return chunk$1(String(this),e)},String.prototype.truncate=function truncate$1(e){return truncate(String(this),e)},String.prototype.trim=function trim$1(e=""){return trim(String(this),e)},String.prototype.trimEnd=function trimEnd$1(e=""){return trimEnd(String(this),e)},String.prototype.trimStart=function trimStart$1(e=""){return trimStart(String(this),e)},String.prototype.stripEnd=function stripEnd$1(e){return stripEnd(String(this),e)},String.prototype.stripStart=function stripStart$1(e){return stripStart(String(this),e)},String.prototype.byteLength=function byteLength$1(){return byteLength(String(this))},String.prototype.isAscii=function isAscii$1(e=!1){return isAscii(String(this),e)};var f=Object.freeze({__proto__:null,isBetween:isBetween,isFloat:isFloat,isNumeric:isNumeric,random:random$1,range:range,sequence:sequence,serial:serial});function first(e){return e[0]}function last(e){return e.length>0?e[e.length-1]:void 0}function random(e,t=!1){if(!e.length)return;if(1===e.length)return t?e.splice(0,1)[0]:e[0];const r=random$1(0,e.length-1);return t?e.splice(r,1)[0]:e[r]}function count(e,t){return function count$2(e,t){let r=0;for(let n=0;n<e.length;n++)e[n]===t&&r++;return r}(e,t)}function equals$1(e,t){return equals$3(e,t)}function split$1(e,t){return split$3(e,t)}function chunk(e,t){return chunk$3(e,t)}function uniq(e){return[...new Set(e)]}function uniqBy(e,t){const r=new Map;for(let n=0;n<e.length;n++){const o=e[n],s=t(o,n);r.has(s)||r.set(s,o)}return[...r.values()]}function shuffle(e){for(let t=e.length-1;t>0;t--){const r=Math.floor(Math.random()*(t+1));[e[t],e[r]]=[e[r],e[t]]}return e}function orderBy(e,t,r="asc"){const n=e.slice();return"function"==typeof t?orderBy(n.map(((e,r)=>({key:t(e,r),value:e}))),"key",r).map((({value:e})=>e)):(n.sort(((e,r)=>{if("object"!=typeof e||"object"!=typeof r||!e||!r||Array.isArray(e)||Array.isArray(r))return-1;const n=e[t],o=r[t];return void 0===n||void 0===o?-1:"number"==typeof n&&"number"==typeof o?n-o:"string"==typeof n&&"string"==typeof o||"bigint"==typeof n&&"bigint"==typeof o?n<o?-1:1:-1})),"desc"===r&&n.reverse(),n)}function groupBy(e,t,r=Object){if(r===Map||isSubclassOf(r,Map)){const n=new r;for(let r=0;r<e.length;r++){const o=e[r],s=t(o,r),i=n.get(s);i?i.push(o):n.set(s,[o])}return n}{const r={};for(let n=0;n<e.length;n++){const o=e[n],s=t(o,n),i=r[s];i?i.push(o):r[s]=[o]}return r}}function keyBy(e,t,r=Object){if(r===Map||isSubclassOf(r,Map)){const n=new r;for(let r=0;r<e.length;r++){const o=e[r],s=t(o,r);n.set(s,o)}return n}{const r={};for(let n=0;n<e.length;n++){const o=e[n];r[t(o,n)]=o}return r}}Number.isFloat=isFloat,Number.isNumeric=isNumeric,Number.isBetween=isBetween,Number.random=random$1,Number.range=range,Number.serial=serial,Number.sequence=sequence;var d=Object.freeze({__proto__:null,chunk:chunk,count:count,equals:equals$1,first:first,groupBy:groupBy,keyBy:keyBy,last:last,orderBy:orderBy,random:random,shuffle:shuffle,split:split$1,uniq:uniq,uniqBy:uniqBy});function isFunction(e){return"function"==typeof e}function unrefTimer(e){"object"==typeof e&&"function"==typeof e.unref?e.unref():"object"==typeof Deno&&"function"==typeof Deno.unrefTimer&&Deno.unrefTimer(e)}function asIterable(e){if(isFunction(e[Symbol.asyncIterator]))return e;if("function"==typeof ReadableStream&&e instanceof ReadableStream){const t=e.getReader();return{[Symbol.asyncIterator]:async function*(){try{for(;;){const{done:e,value:r}=await t.read();if(e)break;yield r}}finally{t.releaseLock()}}}}return null}async function timeout(e,t){return await Promise.race([e,new Promise(((e,r)=>unrefTimer(setTimeout((()=>{r(new Error(`operation timeout after ${t}ms`))}),t))))])}async function after(e,t){const[r]=await Promise.allSettled([e,new Promise((e=>setTimeout(e,t)))]);if("fulfilled"===r.status)return r.value;throw r.reason}async function sleep(e){return new Promise((t=>setTimeout(t,e)))}async function until(e){for(;!1===await e();)await sleep(0)}Array.prototype.first=function first$1(){return first(this)},Array.prototype.last=function last$1(){return last(this)},Array.prototype.random=function random$1(e=!1){return random(this,e)},Array.prototype.count=function count$1(e){return count(this,e)},Array.prototype.equals=function equals(e){return equals$1(this,e)},Array.prototype.split=function split(e){return split$1(this,e)},Array.prototype.chunk=function chunk$1(e){return chunk(this,e)},Array.prototype.uniq=function uniq$1(){return uniq(this)},Array.prototype.uniqBy=function uniqBy$1(e){return uniqBy(this,e)},Array.prototype.shuffle=function shuffle$1(){return shuffle(this)},Array.prototype.toShuffled=function toShuffled(){return this.slice().shuffle()},Array.prototype.toReversed||(Array.prototype.toReversed=function toReversed(){return this.slice().reverse()}),Array.prototype.toSorted||(Array.prototype.toSorted=function toSorted(e){return this.slice().sort(e)}),Array.prototype.orderBy=function orderBy$1(e,t="asc"){return orderBy(this,e,t)},Array.prototype.groupBy=function groupBy$1(e,t=Object){return groupBy(this,e,t)},Array.prototype.keyBy=function keyBy$1(e,t=Object){return keyBy(this,e,t)},Uint8Array.copy=copy,Uint8Array.concat=concat,Uint8Array.compare=compare$1,Uint8Array.prototype.equals=function equals(e){return equals$2(this,e)},Uint8Array.prototype.split=function split(e){return split$2(this,e)},Uint8Array.prototype.chunk=function chunk(e){return chunk$2(this,e)},Object.hasOwn||(Object.hasOwn=hasOwn),Object.hasOwnMethod||(Object.hasOwnMethod=hasOwnMethod),Object.patch=patch,Object.pick=pick,Object.omit=omit,Object.as=as$1,Object.typeOf=typeOf,Object.isValid=isValid,Object.isPlainObject=isPlainObject,Object.sanitize=sanitize$1,Object.sortKeys=sortKeys,Object.flatKeys=flatKeys,Math.sum=sum,Math.avg=avg,Math.product=product;var p=Object.freeze({__proto__:null,after:after,sleep:sleep,timeout:timeout,until:until});Promise.timeout=timeout,Promise.after=after,Promise.sleep=sleep,Promise.until=until;const h=Symbol("inverse");class BiMap extends Map{get[Symbol.toStringTag](){return"BiMap"}constructor(e=null){if(super(),this[h]=new Map,e)for(const[t,r]of e)this.set(t,r)}set(e,t){return super.set(e,t),this[h].set(t,e),this}getKey(e){return this[h].get(e)}hasValue(e){return this[h].has(e)}deleteValue(e){if(this[h].has(e)){const t=this[h].get(e);return super.delete(t),this[h].delete(e),!0}return!1}clear(){super.clear(),this[h].clear()}}class CiMap extends Map{get[Symbol.toStringTag](){return"CiMap"}constructor(e=null){if(super(),e)for(const[t,r]of e)this.set(t,r)}set(e,t){const r=String(e).toLowerCase();return super.set(r,{key:e,value:t}),this}get(e){var t;const r=String(e).toLowerCase();return null===(t=super.get(r))||void 0===t?void 0:t.value}has(e){const t=String(e).toLowerCase();return super.has(t)}delete(e){const t=String(e).toLowerCase();return super.delete(t)}*entries(){for(const{key:e,value:t}of super.values())yield[e,t]}*keys(){for(const{key:e}of super.values())yield e}*values(){for(const{value:e}of super.values())yield e}forEach(e,t){super.forEach((({key:t,value:r})=>{e(r,t,this)}),t)}[Symbol.iterator](){return this.entries()}}var y=Object.freeze({__proto__:null,BiMap:BiMap,CiMap:CiMap});globalThis.BiMap=BiMap,globalThis.CiMap=CiMap;class Exception extends Error{constructor(e,t=0){super(e),this.code=0,"number"==typeof t?this.code=t:"string"==typeof t?Object.defineProperty(this,"name",{configurable:!0,enumerable:!1,writable:!0,value:t}):(t.name&&Object.defineProperty(this,"name",{configurable:!0,enumerable:!1,writable:!0,value:t.name}),t.cause&&Object.defineProperty(this,"cause",{configurable:!0,enumerable:!1,writable:!0,value:t.cause}),t.code&&(this.code=t.code))}}function toObject(e){e instanceof Error||!e.name||!e.message||(e=fromObject(e,Error));const t={"@@type":e.constructor.name,...omit(e,["toString","toJSON","__callSiteEvals"])};return"AggregateError"===t["@@type"]&&Array.isArray(t.errors)&&(t.errors=t.errors.map((e=>e instanceof Error?toObject(e):e))),t}function fromObject(e,t=void 0){var r,n;if(!(null==e?void 0:e.name))return null;let o;t||(t=globalThis[e["@@type"]||e.name]||globalThis[e.name]),t||(t="Exception"===e["@@type"]?Exception:Error),o="DOMException"===t.name&&"function"==typeof DOMException?new t(null!==(r=e.message)&&void 0!==r?r:"",e.name):Object.create(t.prototype,{message:{configurable:!0,enumerable:!1,writable:!0,value:null!==(n=e.message)&&void 0!==n?n:""}}),o.name!==e.name&&Object.defineProperty(o,"name",{configurable:!0,enumerable:!1,writable:!0,value:e.name}),void 0!==e.stack&&Object.defineProperty(o,"stack",{configurable:!0,enumerable:!1,writable:!0,value:e.stack}),null!=e.cause&&Object.defineProperty(o,"cause",{configurable:!0,enumerable:!1,writable:!0,value:e.cause});return Reflect.ownKeys(e).filter((e=>!["@@type","name","message","stack","cause"].includes(e))).forEach((t=>{var r;null!==(r=o[t])&&void 0!==r||(o[t]=e[t])})),isAggregateError(o)&&Array.isArray(o.errors)&&(o.errors=o.errors.map((e=>isPlainObject(e)?fromObject(e):e))),o}function toErrorEvent(e,t="error"){let r="",n=0,o=0;if(e.stack){const t=e.stack.split("\n").map((e=>e.trim()));let s=t.find((e=>e.startsWith("at ")));if(s?s=s.slice(3):(s=t.find((e=>e.includes("@")&&e.length>1)))&&(s=s.slice(s.indexOf("@")+1)),s){let e=s.lastIndexOf("("),t=0;-1!==e&&(e+=1,t=s.indexOf(")",e),s=s.slice(e,t));const i=s.match(/:(\d+):(\d+)$/);i&&(r=s.slice(0,i.index),n=parseInt(i[1]),o=parseInt(i[2]))}}return new ErrorEvent(t,{error:e,message:e.message,filename:r,lineno:n,colno:o})}Object.defineProperty(Exception.prototype,"name",{configurable:!0,enumerable:!1,writable:!0,value:"Exception"});const m="object"==typeof navigator&&/Firefox|Safari/.test(navigator.userAgent);function fromErrorEvent(e){if(e.error instanceof Error)return e.error;let t,r=!1;if(e.error&&"object"==typeof e.error&&e.error.name&&e.error.message)t=fromObject(e.error,Error),r=!t.stack;else{if(!e.message)return null;t=new Error(e.message),r=!0}if(r){let r="";e.filename&&(r=m?"@"+e.filename:`Error: ${e.message}\n    at ${e.filename}`,e.lineno&&(r+=":"+e.lineno),e.colno&&(r+=":"+e.colno)),Object.defineProperty(t,"stack",{configurable:!0,enumerable:!1,writable:!0,value:r})}return t}function isDOMException(e){return"function"==typeof DOMException&&e instanceof DOMException||e instanceof Error&&"DOMException"===e.constructor.name}function isAggregateError(e){return"function"==typeof AggregateError&&e instanceof AggregateError||e instanceof Error&&"AggregateError"===e.constructor.name}var g=Object.freeze({__proto__:null,Exception:Exception,fromErrorEvent:fromErrorEvent,fromObject:fromObject,isAggregateError:isAggregateError,isDOMException:isDOMException,toErrorEvent:toErrorEvent,toObject:toObject});globalThis.Exception=Exception,Error.toObject=toObject,Error.fromObject=fromObject,Error.toErrorEvent=toErrorEvent,Error.fromErrorEvent=fromErrorEvent,Error.prototype.toJSON=function toJSON(){return toObject(this)};const w=new Map;function parseAs(e,t){return as(JSON.parse(e),t)}function as(e,t){if(null==e)return null;if("function"==typeof t.fromJSON)return t.fromJSON(e);if("boolean"==typeof e)return t===Boolean?e:null;if("number"==typeof e){if(t===Number)return e;if(t!==BigInt)return null;try{return BigInt(e)}catch(e){return null}}else if("string"==typeof e){if(t===String)return e;if(t===Date){const t=new Date(e);return isValid(t)?t:null}if(t!==BigInt)return null;try{return BigInt(e)}catch(e){return null}}else if(Array.isArray(e)){if(t===Array)return e;if(t.prototype instanceof Array)return t.from(e);if("function"!=typeof t.prototype[Symbol.iterator]||"function"!=typeof t.from)return null;try{return t.from(e)}catch(e){return null}}else{if([String,Number,Boolean,Date,Array].includes(t))return null;{if("Buffer"===e.type&&Array.isArray(e.data))if("function"==typeof Buffer&&t===Buffer)try{return Buffer.from(e.data)}catch(e){return null}else{if("function"!=typeof t.prototype[Symbol.iterator]||"function"!=typeof t.from)return null;try{return t.from(e.data)}catch(e){return null}}else if("ByteArray"===e.type&&Array.isArray(e.data))try{return bytes$1(e.data)}catch(e){return null}const r=Object.getOwnPropertyNames(e),n=Object.values(e);if(!r.slice(0,50).map(Number).every((e=>!Number.isNaN(e)))||!n.slice(0,50).map(Number).every((e=>!Number.isNaN(e)))||"function"!=typeof t.prototype[Symbol.iterator]||"function"!=typeof t.from){if(t.prototype instanceof Error){const r=fromObject(e);if(r){const n=w.get(t.prototype);if(n)for(const t of Reflect.ownKeys(e)){const o=n[t];o&&(r[t]=as(e[t],o))}}return r}{const r=Object.create(t.prototype),n=w.get(t.prototype);if(n)for(const t of Reflect.ownKeys(e)){const o=n[t];r[t]=o?as(e[t],o):e[t]}else Object.assign(r,e);return r}}try{return t.from(Object.values(e))}catch(e){return null}}}}function type(e){return(t,r)=>{const n=w.get(t);n?n[r]=e:w.set(t,{[r]:e})}}var b=Object.freeze({__proto__:null,as:as,parseAs:parseAs,type:type});function isIteratorLike(e){return"object"==typeof e&&null!==e&&"function"==typeof e.next}function isGenerator(e){return function isIterableIterator(e){return isIteratorLike(e)&&"function"==typeof e[Symbol.iterator]}(e)&&hasGeneratorSpecials(e)}function isAsyncGenerator$1(e){return function isAsyncIterableIterator(e){return isIteratorLike(e)&&"function"==typeof e[Symbol.asyncIterator]}(e)&&hasGeneratorSpecials(e)}function hasGeneratorSpecials(e){return"function"==typeof e.return&&"function"==typeof e.throw}JSON.parseAs=parseAs,JSON.as=as,JSON.type=type,Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")),Symbol.asyncIterator||Object.defineProperty(Symbol,"asyncIterator",{value:Symbol("Symbol.asyncIterator")});const v=Symbol("GeneratorSource"),k=Symbol("GeneratorStatus"),j=Symbol("GeneratorResult");class Thenable{constructor(e){this[v]=e,this[k]="suspended",this[j]=void 0}then(e,t){let r;return r=void 0===this[v]||"closed"===this[k]?Promise.resolve(this[j]):"erred"===this[k]?Promise.reject(this[v]):"function"==typeof this[v].then?Promise.resolve(this[v]):"function"==typeof this[v].next?function processIterator(e){return new Promise(((t,r)=>{function fulfilled(t){try{step(e.next(t))}catch(e){r(e)}}function rejected(t){var n;try{step(null===(n=e.throw)||void 0===n?void 0:n.call(e,t))}catch(e){r(e)}}function step(e){Promise.resolve(e).then((e=>{e.done?t(e.value):new Promise((t=>{t(e.value)})).then(fulfilled,rejected)}))}step(e.next())}))}(this[v]):Promise.resolve(this[v]),this[k]="closed",r.then((e=>this[j]=e)).then(e,t)}catch(e){return Promise.resolve(this).then(null,e)}}class ThenableGenerator extends Thenable{next(...e){const t=e[0];let r;if(void 0===this[v]||"closed"===this[k])r={value:void 0,done:!0};else{if("erred"===this[k])return this.throw(this[v]);r="function"==typeof this[v].next?this[v].next(t):{value:this[v],done:!0}}return!0===r.done&&(this[k]="closed",this[j]=r.value),r}return(e){return this[k]="closed",this[j]=e,this[v]&&"function"==typeof this[v].return?this[v].return(e):{value:e,done:!0}}throw(e){if(this[k]="closed",this[v]&&"function"==typeof this[v].throw)return this[v].throw(e);throw e}[Symbol.iterator](){return this}}class ThenableAsyncGenerator extends Thenable{next(...e){const t=e[0];let r;return r=void 0===this[v]||"closed"===this[k]?Promise.resolve({value:void 0,done:!0}):"function"==typeof this[v].next?Promise.resolve(this[v].next(t)):Promise.resolve(this[v]).then((e=>({value:e,done:!0}))),r.then((e=>(!0===e.done&&(this[k]="closed",this[j]=e.value),e)))}return(e){return this[k]="closed",Promise.resolve(e).then((e=>(this[j]=e,this[v]&&"function"==typeof this[v].return?Promise.resolve(this[v].return(e)):Promise.resolve({value:e,done:!0}))))}throw(e){return this[k]="closed",this[v]&&"function"==typeof this[v].throw?Promise.resolve(this[v].throw(e)):Promise.reject(e)}[Symbol.asyncIterator](){return this}}const ThenableGeneratorFunction=function(e){if(!(this instanceof ThenableGeneratorFunction))return new ThenableGeneratorFunction(e);function anonymous(...t){try{const r=e.apply(this,t);return"function"==typeof r.then||function isAsyncGenerator(e){return null!==e&&"object"==typeof e&&"function"==typeof e.next&&"function"==typeof e.return&&"function"==typeof e.throw&&"function"==typeof e[Symbol.asyncIterator]}(r)?new ThenableAsyncGenerator(r):new ThenableGenerator(r)}catch(e){return Object.assign(new ThenableGenerator(e),{[k]:"erred"})}}return anonymous.prototype=ThenableGeneratorFunction,anonymous.__proto__=this,anonymous};function _try(e,...t){if(isFunction(e))try{return _try(e.apply(void 0,t))}catch(e){return[e,void 0]}let r=e;return r instanceof ThenableAsyncGenerator?(r=r.then((e=>[null,e])),Promise.resolve(r).catch((e=>[e,void 0]))):isAsyncGenerator$1(r)?async function*(){let e,t;for(;;)try{const{done:n,value:o}=await r.next(e);if(n){t=o;break}e=yield Promise.resolve([null,o])}catch(e){yield Promise.resolve([e,void 0]);break}return[null,t]}():isGenerator(r)?function*(){let e,t;for(;;)try{const{done:n,value:o}=r.next(e);if(n){t=o;break}e=yield[null,o]}catch(e){yield[e,void 0];break}return[null,t]}():isFunction(null==r?void 0:r.then)?(r=r.then((e=>[null,e])),Promise.resolve(r).catch((e=>[e,void 0]))):[null,r]}function wrap(e,t){const wrapped=function(...r){return t.call(this,e,...r)};return Object.defineProperty(wrapped,"name",Object.getOwnPropertyDescriptor(e,"name")),Object.defineProperty(wrapped,"length",Object.getOwnPropertyDescriptor(e,"length")),Object.defineProperty(wrapped,"toString",{configurable:!0,enumerable:!1,writable:!0,value:e.toString.bind(e)}),wrapped}ThenableGeneratorFunction.create=function create(e){return new ThenableGeneratorFunction(e)},Object.setPrototypeOf(ThenableGeneratorFunction,Function),Object.setPrototypeOf(ThenableGeneratorFunction.prototype,Function.prototype),ThenableGeneratorFunction.create;const O=new Map;const E=new Map;var S;const x=Symbol.for("id"),P="object"==typeof Deno,A="object"==typeof Bun,$=!P&&!A&&"object"==typeof process&&!!(null===(S=process.versions)||void 0===S?void 0:S.node),C=$&&parseInt(process.version.slice(1))<14;$&&parseInt(process.version.slice(1));const I=/^(\.[\/\\]|\.\.[\/\\]|[a-zA-Z]:|\/)/,M=!($&&process.argv.includes("--worker-thread"))&&(A?Bun.isMainThread:"undefined"==typeof WorkerGlobalScope);var B;void 0===Symbol.dispose&&Object.defineProperty(Symbol,"dispose",{value:Symbol("Symbol.dispose")});const R=serial(!0);class Channel{constructor(e=0){if(this[B]=R.next().value,this.buffer=[],this.producers=[],this.consumers=[],this.error=null,this.state=1,e<0)throw new RangeError("the capacity of a channel must not be negative");this.capacity=e}send(e){if(1!==this.state)throw new Error("the channel is closed");if(this.consumers.length){const t=this.consumers.shift();return Promise.resolve(t(null,e))}return this.capacity&&this.buffer.length<this.capacity?(this.buffer.push(e),Promise.resolve(void 0)):new Promise((t=>{this.producers.push((()=>{if(this.capacity){const r=this.buffer.shift();return this.buffer.push(e),t(),r}return t(),e}))}))}recv(){if(this.buffer.length){const e=this.buffer.shift();return 2!==this.state||this.buffer.length||(this.state=0),Promise.resolve(e)}if(this.producers.length){const e=this.producers.shift();return 2!==this.state||this.producers.length||(this.state=0),Promise.resolve(e())}if(0===this.state)return Promise.resolve(void 0);if(this.error){const{error:e}=this;return this.state=0,this.error=null,Promise.reject(e)}return 2===this.state?(this.state=0,Promise.resolve(void 0)):new Promise(((e,t)=>{this.consumers.push(((r,n)=>{2!==this.state||this.consumers.length||(this.state=0),r?t(r):e(n)}))}))}close(e=null){if(1!==this.state)return;let t;for(this.state=2,this.error=e;t=this.consumers.shift();)t(e,void 0)}[(B=x,Symbol.asyncIterator)](){const e=this;return{async next(){const t=e.buffer.length,r=e.producers.length;return{value:await e.recv(),done:0===e.state&&!t&&!r}}}}[Symbol.dispose](){this.close()}push(e){return this.send(e)}pop(){return this.recv()}}function chan(e=0){return new Channel(e)}class Queue{constructor(e,t=0){this.channel=chan(t),(async()=>{var t;for await(const r of this.channel)try{await e.call(void 0,r)}catch(e){null===(t=this.errorHandler)||void 0===t||t.call(this,e)}})().catch((e=>{var t;null===(t=this.errorHandler)||void 0===t||t.call(void 0,e)}))}push(e){return this.channel.send(e)}close(){var e;null===(e=this.channel)||void 0===e||e.close()}onError(e){this.errorHandler=e}[Symbol.dispose](){this.close()}}var L;void 0===Symbol.dispose&&Object.defineProperty(Symbol,"dispose",{value:Symbol("Symbol.dispose")});const _=Symbol.for("queue"),D=Symbol.for("value"),N=Symbol.for("mutex"),T=Symbol.for("unlocked");class Mutex{constructor(e){this[L]=[],this[D]=e}async lock(){await new Promise((e=>{this[_].length?this[_].push(e):(this[_].push(e),e())}));const e=Object.create(Mutex.Lock.prototype);return e[N]=this,e}}L=_,function(e){var t;class Lock{constructor(e){this[t]=!1,this[N]=e}get value(){if(this[T])throw new ReferenceError("trying to access data after unlocked");return this[N][D]}set value(e){if(this[T])throw new ReferenceError("trying to access data after unlocked");this[N][D]=e}unlock(){this[T]=!0;const e=this[N][_];e.shift();const t=e[0];t?t():q.hasValue(this[N])&&q.deleteValue(this[N])}[(t=T,Symbol.dispose)](){this.unlock()}}e.Lock=Lock}(Mutex||(Mutex={}));const q=new BiMap;const W=new Map;function sanitizeModuleId(e,t=!1){let r="";if("function"==typeof e){let t=e.toString(),n=7,o=t.lastIndexOf("import(");if(-1===o&&(n=8,o=t.lastIndexOf("require(")),-1===o)throw new TypeError("the given script is not a dynamic import expression");{o+=n;const e=t.indexOf(")",o);r=trim(t.slice(o,e)," '\"'")}}else r=e;return($||A)&&I.test(r)&&(/\.[cm]?(js|ts|)x?$/.test(r)?$&&(r.endsWith(".ts")?r=r.slice(0,-3)+".js":r.endsWith(".mts")?r=r.slice(0,-4)+".mjs":r.endsWith(".cts")?r=r.slice(0,-4)+".cjs":r.endsWith(".tsx")&&(r=r.slice(0,-4)+".js")):r+=A?".ts":".js"),I.test(r)||t||(r="./"+r),r}async function resolveRemoteModuleUrl(e){var t;const r=await fetch(e);let n;if(null===(t=r.headers.get("content-type"))||void 0===t?void 0:t.includes("/javascript"))n=await r.blob();else{const e=await r.arrayBuffer();n=new Blob([new Uint8Array(e)],{type:"application/javascript"})}return URL.createObjectURL(n)}const F=new Map;function isChannelMessage(e){return e&&"object"==typeof e&&["send","close"].includes(e.type)&&"number"==typeof e.channelId}async function handleChannelMessage(e){const t=F.get(e.channelId);if(t)if("send"===e.type)await t.raw.send(e.value);else if("close"===e.type){const{value:r,channelId:n}=e;t.raw.close(r),F.delete(n),M&&t.writers.length>1&&t.writers.forEach((e=>{e("close",r,n)}))}}function wrapChannel(e,t){return function wireChannel(e,t){const r=e[x];if(F.has(r))F.get(r).writers.push(t);else{const n=e.send.bind(e),o=e.close.bind(e);F.set(r,{channel:e,raw:{send:n,close:o},writers:[t],counter:0}),Object.defineProperties(e,{send:{configurable:!0,writable:!0,value:async e=>{const t=F.get(r);if(t){if(1!==t.channel.state)throw new Error("the channel is closed");const n=t.writers[t.counter++%t.writers.length];await Promise.resolve(n("send",e,r))}}},close:{configurable:!0,writable:!0,value:(e=null)=>{const t=F.get(r);if(t){F.delete(r);const n=t.channel;t.writers.forEach((t=>{t("close",e,r)})),Object.defineProperties(n,{send:{configurable:!0,writable:!0,value:t.raw.send},close:{configurable:!0,writable:!0,value:t.raw.close}}),n.close(e)}}}})}}(e,t),{"@@type":"Channel","@@id":e[x],capacity:e.capacity}}function isNotQuery(e){return"?"!==e[0]&&"#"!==e[0]}function isVolume(e,t=!1){return t?/^[a-z]:$/i.test(e):/^[a-z]:(\\)?$/i.test(e)}function isWindowsPath(e){return/^[a-z]:/i.test(e)&&"://"!==e.slice(1,4)}function isPosixPath(e){return/^\//.test(e)}function isUrl(e){return/^[a-z](([a-z\-]+)?:\/\/\S+|[a-z\-]+:\/\/$)/i.test(e)||isFileUrl(e)}function isFileUrl(e){return/^file:((\/\/|\/)\S+|\/?$)/i.test(e)}function isFileProtocol(e){return/^file:(\/\/)?$/i.test(e)}function isAbsolute(e){return isPosixPath(e)||isWindowsPath(e)||isUrl(e)}function split(e){if(e){if(isUrl(e)){const{protocol:t,host:r,pathname:n,search:o,hash:s}=new URL(e);let i=t+"//"+r;if(isFileProtocol(i)&&(i+="/"),"/"===n)return o&&s?[i,o,s]:o?[i,o]:s?[i,s]:[i];{const e=trim(n,"/").split(/[/\\]+/);return o&&s?[i,...e,o,s]:o?[i,...e,o]:s?[i,...e,s]:[i,...e]}}if(isWindowsPath(e)){const[t,r,...n]=split("file:///"+e.replace(/[/\\]+/g,"/"));return[r+"\\",...n]}if(isPosixPath(e)){const[t,...r]=split("file://"+e.replace(/[/\\]+/g,"/"));return["/",...r]}{e=e.replace(/[/\\]+/g,"/");const[t,r]=e.split("?");if(r){const e=t?trimEnd(t,"/").split("/"):[],[n,o]=r.split("#");return o?[...e,"?"+n,"#"+o]:[...e,"?"+n]}{const[t,r]=e.split("#"),n=t?trimEnd(t,"/").split("/"):[];return r?[...n,"#"+r]:n}}}return[]}function stripFileProtocol(e){return e.replace(/^file:\/\/(localhost)?\/?([a-z]:)/i,"$2").replace(/^file:\/?([a-z]:)/i,"$1").replace(/^file:\/\/(localhost)?\//i,"/").replace(/^file:\//i,"/")}function extractSegmentsForComparison(e,t,r={}){r.caseInsensitive&&(e=e.toLowerCase(),t=t.toLowerCase()),r.ignoreFileProtocol&&(e=stripFileProtocol(e),t=stripFileProtocol(t));const n=split(e).filter(isNotQuery),o=split(t).filter(isNotQuery);return n.length<o.length?{result:!1,paths:[],subs:[]}:(r.caseInsensitive||(n.forEach(((e,t)=>{isVolume(e)&&(n[t]=e.toLowerCase())})),o.forEach(((e,t)=>{isVolume(e)&&(o[t]=e.toLowerCase())}))),o.length?{result:void 0,paths:n,subs:o}:{result:!0,paths:n,subs:o})}function endsWith(e,t,r={}){const{result:n,paths:o,subs:s}=extractSegmentsForComparison(e,t,r);if(void 0!==n)return n;for(let e=s.length-1,t=o.length-1;e>=0;e--,t--)if(s[e]!==o[t])return!1;return!0}const z=(()=>{var e,t;if("object"==typeof Deno&&"string"==typeof(null===(e=Deno.build)||void 0===e?void 0:e.os)){if("windows"===Deno.build.os)return"\\"}else if("object"==typeof process&&(null===(t=process.versions)||void 0===t?void 0:t.node)&&"win32"===process.platform)return"\\";return"/"})();function cwd(){if("object"==typeof Deno&&"function"==typeof Deno.cwd)return Deno.cwd();if("object"==typeof process&&"function"==typeof process.cwd)return process.cwd();if("object"==typeof location&&location.origin)return location.origin+("/"===location.pathname?"":location.pathname);throw new Error("Unable to determine the current working directory.")}function join(...e){let t=[];for(let r=0;r<e.length;r++){const n=e[r];n&&(isAbsolute(n)&&(t=[]),t.push(n))}const r=[];for(let e=0;e<t.length;e++){let n=t[e];for(const e of split(n))".."===e?!r.length||r.every((e=>".."===e))?r.push(".."):(r.length>2||2===r.length&&!isAbsolute(r[1])||1===r.length&&!isAbsolute(r[0]))&&r.pop():e&&"."!==e&&r.push(e)}if(!r.length)return".";const n=r[0],o=isUrl(n)||isPosixPath(n)?"/":isWindowsPath(n)?"\\":z;let s="";for(let e=0;e<r.length;e++){const t=r[e];s&&"?"!==t[0]&&"#"!==t[0]?isVolume(t)?s?s+=t+"/":s=t:s+=(s.endsWith(o)?"":o)+trim(t,"/\\"):s+=t}return/^file:\/\/\/[a-z]:$/i.test(s)?s+"/":s}function resolve(...e){e=e.filter((e=>""!==e));const t=cwd();return e.length?(e=isAbsolute(e[0])?e:[t,...e],join(...e)):t}function dirname(e){if(isUrl(e)){const{protocol:t,host:r,pathname:n}=new URL(e),o=t+"//"+r,s=dirname(n);return"/"===s?isFileProtocol(o)?o+"/":o:o+s}{const t=split(e).filter(isNotQuery),r=t.pop();return t.length?join(...t):"/"===r?"/":isVolume(r,!0)?r+"\\":isVolume(r)?r:"."}}function basename(e,t=""){if(isUrl(e)){const{pathname:r}=new URL(e);return basename(r,t)}{const r=split(e).filter(isNotQuery).pop();return!r||"/"===r||isVolume(r)?"":t?stripEnd(r,t):r}}function extname(e){const t=basename(e),r=t.lastIndexOf(".");return-1===r?"":t.slice(r)}var K=Object.freeze({__proto__:null,basename:basename,contains:function contains(e,t,r={}){const{result:n,paths:o,subs:s}=extractSegmentsForComparison(e,t,r);if(void 0!==n)return n;const i=s[0];for(let e=0;e<o.length;e++){if(o[e]!==i)continue;const t=e;let r=1,n=e;for(;r<s.length&&(n++,o[n]===s[n-t]);)r++;if(r===s.length)return!0}return!1},cwd:cwd,dirname:dirname,endsWith:endsWith,equals:function equals(e,t,r={}){const{result:n,paths:o,subs:s}=extractSegmentsForComparison(e,t,r);if(!1===n||o.length!==s.length)return!1;for(let e=0;e<o.length;e++)if(o[e]!==s[e])return!1;return!0},extname:extname,isAbsolute:isAbsolute,isFileUrl:isFileUrl,isPosixPath:isPosixPath,isUrl:isUrl,isWindowsPath:isWindowsPath,join:join,normalize:function normalize(e){return join(e)},resolve:resolve,sanitize:function sanitize(e){return join(...split(e).filter(isNotQuery))},sep:z,split:split,startsWith:function startsWith(e,t,r={}){const{result:n,paths:o,subs:s}=extractSegmentsForComparison(e,t,r);if(void 0!==n)return n;for(let e=0;e<s.length;e++)if(s[e]!==o[e])return!1;return!0}});const U=serial(!0);let V,G=[];const J=new Map,H=(async()=>{if($){const e=await import("os");return"function"==typeof e.availableParallelism?e.availableParallelism():e.cpus().length}return"object"==typeof navigator&&navigator.hardwareConcurrency?navigator.hardwareConcurrency:8})();function isCallResponse(e){return e&&"object"==typeof e&&["return","yield","error","gen"].includes(e.type)}function getModuleDir(e){if(".ts"===extname(e))return resolve(e,"../../..");let t=dirname(e);return endsWith(t,"jsext/bundle")?dirname(t):resolve(t,"../../..")}async function createWorker(t){let{adapter:r="worker_threads",parallel:n}=t;const o=await async function getWorkerEntry(t={}){if($||A){if(t.workerEntry)return t.workerEntry;const{fileURLToPath:r}=await import("url"),n=r("undefined"==typeof document&&"undefined"==typeof location?require("url").pathToFileURL(__filename).href:"undefined"==typeof document?location.href:e&&e.src||new URL("jsext.js",document.baseURI).href);if(n===process.argv[1]){const e=join(cwd(),"node_modules/@ayonli/jsext");return A?".ts"===extname(n)?join(e,"worker.ts"):join(e,"bundle/worker.mjs"):join(e,"bundle/worker-node.mjs")}{const e=getModuleDir(n);return A?".ts"===extname(n)?join(e,"worker.ts"):join(e,"bundle/worker.mjs"):join(e,"bundle/worker-node.mjs")}}if(P)return t.workerEntry?t.workerEntry:("undefined"==typeof document&&"undefined"==typeof location?require("url").pathToFileURL(__filename).href:"undefined"==typeof document?location.href:e&&e.src||new URL("jsext.js",document.baseURI).href).includes("jsr.io")?"jsr:@ayonli/jsext/worker.ts":join(getModuleDir("undefined"==typeof document&&"undefined"==typeof location?require("url").pathToFileURL(__filename).href:"undefined"==typeof document?location.href:e&&e.src||new URL("jsext.js",document.baseURI).href),"worker.ts");if(t.workerEntry)return isUrl(t.workerEntry)?await resolveRemoteModuleUrl(t.workerEntry):t.workerEntry;{const e="https://ayonli.github.io/jsext/bundle/worker.mjs";return await resolveRemoteModuleUrl(e)}}(n);if($||A){if("child_process"===r){const{fork:e}=await import("child_process"),t=e(o,["--worker-thread"],{stdio:"inherit",serialization:C?"json":"advanced"}),r=t.pid;return await new Promise(((e,r)=>{t.once("error",r),t.once("message",(()=>{t.off("error",r),e()}))})),{worker:t,workerId:r,kind:"node_process"}}if($){const{Worker:e}=await import("worker_threads"),t=new e(o,{argv:["--worker-thread"]}),r=t.threadId;return await new Promise(((e,r)=>{t.once("error",r),t.once("online",(()=>{t.off("error",r),e()}))})),{worker:t,workerId:r,kind:"node_worker"}}{const e=new Worker(o,{type:"module"}),t=U.next().value;return await new Promise(((t,r)=>{e.onerror=e=>{r(new Error(e.message||"unable to start the worker"))},e.addEventListener("open",(()=>{e.onerror=null,t()}))})),{worker:e,workerId:t,kind:"bun_worker"}}}return{worker:new Worker(o,{type:"module"}),workerId:U.next().value,kind:"web_worker"}}function handleWorkerMessage(e,t,r){var n,o,s,i;if(isChannelMessage(r))handleChannelMessage(r);else if(isCallResponse(r)&&r.taskId){const a=J.get(r.taskId);if(!a)return;if("return"===r.type||"error"===r.type){if("error"===r.type){const e=isPlainObject(r.error)&&null!==(n=fromObject(r.error))&&void 0!==n?n:r.error;e instanceof Error&&(e.message.includes("not be cloned")||(null===(o=e.stack)||void 0===o?void 0:o.includes("not be cloned")))&&Object.defineProperty(e,"stack",{configurable:!0,enumerable:!1,writable:!0,value:(e.stack?e.stack+"\n    ":"")+`at ${a.fn} (${a.module})`}),a.resolver?(a.resolver.reject(e),a.channel&&a.channel.close()):a.channel?a.channel.close(e):a.error=e}else{const e=unwrapReturnValue(r.value);a.resolver?a.resolver.resolve(e):a.result={value:e},a.channel&&a.channel.close()}e.tasks.delete(r.taskId),e.tasks.size||!$&&!A||t.unref()}else if("yield"===r.type){const n=unwrapReturnValue(r.value);null===(s=a.channel)||void 0===s||s.send({value:n,done:r.done}),r.done&&handleWorkerMessage(e,t,{type:"return",value:n,taskId:r.taskId})}else"gen"===r.type&&(null===(i=a.generate)||void 0===i||i.call(a))}}function handleWorkerClose(e,t){for(const r of e.tasks){e.tasks.delete(r);const n=J.get(r);n&&(n.resolver?(n.resolver.reject(t),n.channel&&n.channel.close()):n.channel?n.channel.close(t):n.error=t)}G=G.filter((t=>t!==e))}async function acquireWorker(e,t){const r=t.maxWorkers||await H;let n=G.find((e=>!e.tasks.size));n?n.lastAccess=Date.now():G.length<r?(G.push(n={getWorker:(async()=>{const e=(await createWorker({parallel:t})).worker,r=handleWorkerMessage.bind(void 0,n,e),o=handleWorkerClose.bind(void 0,n);if($)e.on("message",r).on("error",o);else if(A){const t=e;t.onmessage=e=>r(e.data),t.onerror=()=>t.terminate(),t.addEventListener("close",(e=>{o(new Error(e.reason+" ("+e.code+")"))}))}else{const t=e;t.onmessage=e=>r(e.data),t.onerror=e=>{var r;t.terminate(),o(null!==(r=fromErrorEvent(e))&&void 0!==r?r:new Error("worker exited"))}}return e})(),tasks:new Set,lastAccess:Date.now()}),V||(V=setInterval((()=>{const e=Date.now(),t=[];G=G.filter((r=>{const n=!r.tasks.size&&e-r.lastAccess>=1e4;return n&&t.push(r),!n})),t.forEach((async e=>{const t=await e.getWorker;await t.terminate()}))}),1e3),$||A?V.unref():P&&Deno.unrefTimer(V))):(n=G[e%G.length],n.lastAccess=Date.now()),n.tasks.add(e);const o=await n.getWorker;return($||A)&&o.ref(),o}function wrapArgs(e,t){const r=[];return e=e.map((e=>{if(e instanceof Channel)return wrapChannel(e,((e,r,n)=>{t.then((t=>{if("function"==typeof t.postMessage)try{t.postMessage({type:e,value:r,channelId:n})}catch(t){if("close"!==e||!String(t).includes("Worker has been terminated"))throw t}else t.send({type:e,value:r,channelId:n})}))}));if(e instanceof Exception||isDOMException(e)||isAggregateError(e))return toObject(e);if(e instanceof ArrayBuffer)r.push(e);else if(isPlainObject(e))for(const t of Object.getOwnPropertyNames(e)){const n=e[t];n instanceof ArrayBuffer?r.push(n):(n instanceof Exception||isDOMException(n)||isAggregateError(n))&&(e[t]=toObject(n))}else Array.isArray(e)&&(e=e.map((e=>e instanceof ArrayBuffer?(r.push(e),e):e instanceof Exception||isDOMException(e)||isAggregateError(e)?toObject(e):e)));return e})),{args:e,transferable:r}}function unwrapReturnValue(e){return!isPlainObject(e)||"Exception"!==e["@@type"]&&"DOMException"!==e["@@type"]&&"AggregateError"!==e["@@type"]?e:fromObject(e)}const Q=serial(!0);async function safeRemoteCall(e,t,r,n){try{e.postMessage(t,r)}catch(t){throw J.delete(n),"function"==typeof e.unref&&e.unref(),t}}function createLocalCall(e,t,r){const n=async function resolveModule(e,t){let r;if($||A){const{fileURLToPath:n}=await import("url"),o=t?n(new URL(e,t).href):e;r=await import(o)}else{const n=new URL(e,t).href;if(r=W.get(n),!r)if(P)r=await import(n),W.set(n,r);else try{r=await import(n),W.set(n,r)}catch(e){if(!String(e).includes("Failed"))throw e;{const e=await resolveRemoteModuleUrl(n);r=await import(e),W.set(n,r)}}}return"object"==typeof r.default&&void 0!==r.default.default&&(r=r.default),r}(e).then((e=>e[t](...r)));return new ThenableAsyncGenerator({then:(e,t)=>n.then(e,t),async next(e){const t=await n;return await t.next(e)},async return(e){const t=await n;return await t.return(e)},throw:async e=>(await n).throw(e)})}function extractBaseUrl(e){var t,r,n;let o=e.split("\n");const s=o.findIndex((e=>"Error"===e));let i,a;if(-1!==s&&(o=o.slice(s)),i=(null===(t=o[0])||void 0===t?void 0:t.startsWith("Error"))?o[2]:o[1],i){let e=i.lastIndexOf("("),t=0;-1!==e?(e+=1,t=i.indexOf(")",e),i=i.slice(e,t)):i.startsWith("    at ")?i=i.slice(7):"object"==typeof location&&(e=null!==(n=null===(r=i.match(/(https?|file):/))||void 0===r?void 0:r.index)&&void 0!==n?n:-1,e>0&&(i=i.slice(e))),a=i.replace(/:\d+:\d+$/,""),/^(https?|file):/.test(a)||(a=I.test(a)?"file://"+a:P?"file://"+Deno.cwd()+"/":$||A?"file://"+process.cwd()+"/":"object"==typeof location?location.href:"")}return a}function parallel(e){let t,r=sanitizeModuleId(e,!0);if(I.test(r))if("function"==typeof Error.captureStackTrace){const e={};Error.captureStackTrace(e),t=extractBaseUrl(e.stack)}else{t=extractBaseUrl(new Error("").stack)}return t&&(r=new URL(r,t).href),new Proxy(Object.create(null),{get:(e,t)=>{if(Reflect.has(e,t))return e[t];if("symbol"==typeof t)return;const n={[t]:(...e)=>M?function createRemoteCall(e,t,r){const n=Q.next().value;J.set(n,{module:e,fn:t});let o=acquireWorker(n,parallel);const{args:s,transferable:i}=wrapArgs(r,o);return o=o.then((async r=>(await safeRemoteCall(r,{type:"call",module:e,fn:t,args:s,taskId:n},i,n),r))),new ThenableAsyncGenerator({then(e,t){const r=J.get(n);return r.error?(J.delete(n),null==t?void 0:t(r.error)):r.result?(J.delete(n),null==e?void 0:e(r.result.value)):o.then((()=>new Promise(((e,t)=>{r.resolver={resolve:t=>{J.delete(n),e(t)},reject:e=>{J.delete(n),t(e)}}})))).then(e,t)},async next(e){var t;const r=J.get(n);if(r.error){const e=r.error;throw J.delete(n),e}if(r.result){const e=r.result.value;return J.delete(n),{value:e,done:!0}}{null!==(t=r.channel)&&void 0!==t||(r.channel=chan(1/0));const s=await o;r.generate||await new Promise((e=>{r.generate=e}));const{args:i,transferable:a}=wrapArgs([e],o);return await safeRemoteCall(s,{type:"next",args:i,taskId:n},a,n),await r.channel.recv()}},async return(e){J.delete(n);const t=await o,{args:r,transferable:s}=wrapArgs([e],o);return await safeRemoteCall(t,{type:"return",args:r,taskId:n},s,n),{value:e,done:!0}},async throw(e){J.delete(n);const t=await o;throw await safeRemoteCall(t,{type:"throw",args:[e],taskId:n},i,n),e}})}(r,t,e):createLocalCall(r,t,e)};return n[t]}})}!function(e){e.maxWorkers=void 0,e.workerEntry=void 0}(parallel||(parallel={}));var Y=parallel;const Z=new Map;let X;const ee=[];async function run(e,t,r){var n;const o=run.maxWorkers||Y.maxWorkers||await H,s=(null==r?void 0:r.fn)||"default";let i,a=sanitizeModuleId(e);P?i="file://"+Deno.cwd()+"/":$||A?I.test(a)&&(i="file://"+process.cwd()+"/"):"object"==typeof location&&(i=location.href),i&&(a=new URL(a,i).href);const l={type:"call",module:a,fn:s,args:null!=t?t:[]},c=(null==r?void 0:r.adapter)||"worker_threads",u=null!==(n=Z.get(c))&&void 0!==n?n:Z.set(c,[]).get(c);let f=u.find((e=>!e.busy));if(f)f.busy=!0,f.lastAccess=Date.now();else{if(!(u.length<o))return new Promise((e=>{ee.push(e)})).then((()=>run(a,t,r)));u.push(f={getWorker:createWorker({parallel:Y,adapter:c}),adapter:c,busy:!0,lastAccess:Date.now()}),X||(X=setInterval((()=>{Z.forEach(((e,t)=>{const r=Date.now(),n=[];Z.set(t,e.filter((e=>{const t=!e.busy&&r-e.lastAccess>=1e4;return t&&n.push(e),!t}))),n.forEach((async e=>{const{worker:t}=await e.getWorker;"function"==typeof t.terminate?await t.terminate():t.kill()}))}))}),1e3),$||A?X.unref():P&&Deno.unrefTimer(X))}let d,p,h,y,m,g=null,terminate=()=>Promise.resolve(void 0);const w=(null==r?void 0:r.timeout)?setTimeout((async()=>{const e=new Error(`operation timeout after ${r.timeout}ms`);g=e,await terminate(),handleClose(e,!0)}),r.timeout):null;w&&unrefTimer(w);const handleMessage=async e=>{var t,n;if(isChannelMessage(e))await handleChannelMessage(e);else if(isCallResponse(e))if(w&&clearTimeout(w),"return"===e.type||"error"===e.type){if("error"===e.type){const r=isPlainObject(e.error)&&null!==(t=fromObject(e.error))&&void 0!==t?t:e.error;r instanceof Error&&(r.message.includes("not be cloned")||(null===(n=r.stack)||void 0===n?void 0:n.includes("not be cloned"))||r.message.includes("Do not know how to serialize"))&&Object.defineProperty(r,"stack",{configurable:!0,enumerable:!1,writable:!0,value:(r.stack?r.stack+"\n    ":"")+`at ${s} (${a})`}),g=r}else d={value:unwrapReturnValue(e.value)};(null==r?void 0:r.keepAlive)||await terminate(),handleClose(null,!(null==r?void 0:r.keepAlive))}else if("yield"===e.type){const t=unwrapReturnValue(e.value);e.done?handleMessage({type:"return",value:t}):null==h||h.send(t)}},handleClose=(e,t=!1)=>{var r,n,o;if(w&&clearTimeout(w),t){if(f){const e=null===(n=Z.get(c))||void 0===n?void 0:n.filter((e=>e!==f));(null==e?void 0:e.length)?Z.set(c,e):Z.delete(c),ee.length&&(null===(o=ee.shift())||void 0===o||o())}}else null==m||m(),ee.length&&(null===(r=ee.shift())||void 0===r||r());e&&(null!=g||(g=e)),g?p?(p.reject(g),h&&h.close()):h&&(g instanceof Error?h.close(g):"string"==typeof g?h.close(new Error(g)):h.close(new Error("unknown error",{cause:g}))):(null!=d||(d={value:void 0}),p&&p.resolve(d.value),h&&h.close())},safeRemoteCall=async(e,t,n=[])=>{try{"function"==typeof e.postMessage?e.postMessage(t,n):await new Promise(((r,n)=>{e.send(t,(e=>{e?n(e):r()}))}))}catch(t){throw"function"==typeof e.unref&&e.unref(),g=t,(null==r?void 0:r.keepAlive)||await terminate(),handleClose(null,!(null==r?void 0:r.keepAlive)),t}};if($||A)if("child_process"===c){const e=await f.getWorker,t=e.worker;if(y=e.workerId,t.ref(),t.on("message",handleMessage),t.once("exit",((e,t)=>{g||d||handleClose(new Error(`worker exited (${null!=e?e:t})`),!0)})),m=()=>{t.unref(),t.off("message",handleMessage),t.removeAllListeners("exit"),f&&(f.busy=!1)},terminate=()=>Promise.resolve(void t.kill(1)),g)throw await terminate(),g;const{args:r}=wrapArgs(l.args,Promise.resolve(t));l.args=r,await safeRemoteCall(t,l)}else if($){const e=await f.getWorker,t=e.worker,handleErrorEvent=e=>{g||d||handleClose(e,!0)};if(y=e.workerId,t.ref(),t.on("message",handleMessage),t.once("error",handleErrorEvent),m=()=>{t.unref(),t.off("message",handleMessage),t.off("error",handleErrorEvent),f&&(f.busy=!1)},terminate=async()=>{await t.terminate()},g)throw await terminate(),g;const{args:r,transferable:n}=wrapArgs(l.args,Promise.resolve(t));l.args=r,await safeRemoteCall(t,l,n)}else{const e=await f.getWorker,t=e.worker,handleCloseEvent=e=>{g||d||handleClose(new Error(e.reason+" ("+e.code+")"),!0)};if(y=e.workerId,t.ref(),t.onmessage=e=>handleMessage(e.data),t.onerror=()=>{t.terminate()},t.addEventListener("close",handleCloseEvent),m=()=>{t.unref(),t.onmessage=null,t.onerror=null,t.removeEventListener("close",handleCloseEvent),f&&(f.busy=!1)},terminate=()=>Promise.resolve(t.terminate()),g)throw await terminate(),g;const{args:r,transferable:n}=wrapArgs(l.args,Promise.resolve(t));l.args=r,await safeRemoteCall(t,l,n)}else{const e=await f.getWorker,t=e.worker;if(y=e.workerId,t.onmessage=e=>handleMessage(e.data),t.onerror=e=>{var r;g||d||(t.terminate(),handleClose(null!==(r=fromErrorEvent(e))&&void 0!==r?r:new Error("worker exited"),!0))},m=()=>{t.onmessage=null,t.onerror=null,f&&(f.busy=!1)},terminate=()=>Promise.resolve(t.terminate()),g)throw await terminate(),g;const{args:r,transferable:n}=wrapArgs(l.args,Promise.resolve(t));l.args=r,await safeRemoteCall(t,l,n)}return{workerId:y,async abort(e=void 0){w&&clearTimeout(w),e?g=e:d={value:void 0},await terminate(),handleClose(null,!0)},result:async()=>await new Promise(((e,t)=>{g?t(g):d?e(d.value):p={resolve:e,reject:t}})),iterate(){if(p)throw new Error("result() has been called");if(d)throw new TypeError("the response is not iterable");return h=chan(1/0),{[Symbol.asyncIterator]:h[Symbol.asyncIterator].bind(h)}}}}!function(e){e.maxWorkers=void 0,e.workerEntry=void 0}(run||(run={})),Object.defineProperties(run,{workerEntry:{set(e){Y.workerEntry=e},get:()=>Y.workerEntry}});var te=run;const re="object"==typeof Bun,ne=new Map;function emitWarning(e,t,r,n,o){var s;if(!n||!ne.has(t)){let i={};"function"==typeof Error.captureStackTrace?Error.captureStackTrace(i,t):i=new Error("");let a=i.stack.split("\n");const l=a.findIndex((e=>"Error"===e));-1!==l&&(a=a.slice(l));let c=null===(s=a[o])||void 0===s?void 0:s.trim(),u=`${e} is deprecated`;if(r&&(u+=", "+r),c){let e=c.indexOf("(");if(-1!==e){e+=1;const t=c.indexOf(")",e);c=c.slice(e,t)}u+=" ("+c+")"}console.warn("DeprecationWarning:",u),n&&ne.set(t,!0)}}const oe=async function(){}.constructor,se=async function*(){}.constructor,ie={_try:_try,try:_try,func:function func(e){return function(...t){var r;const n=[],defer=e=>{n.push(e)};let o;try{const r=e.call(this,defer,...t);if(isAsyncGenerator$1(r)){const e=async function*(){var e;let t;for(;;)try{const{done:e,value:n}=await r.next(t);if(e){o={value:n,error:null};break}t=yield Promise.resolve(n)}catch(e){o={value:void 0,error:e};break}for(let t=n.length-1;t>=0;t--)await(null===(e=n[t])||void 0===e?void 0:e.call(n));if(o.error)throw o.error;return o.value}();return e}if(isGenerator(r)){const e=function*(){var e;let t;for(;;)try{const{done:e,value:n}=r.next(t);if(e){o={value:n,error:null};break}t=yield n}catch(e){o={value:void 0,error:e};break}for(let t=n.length-1;t>=0;t--)null===(e=n[t])||void 0===e||e.call(n);if(o.error)throw o.error;return o.value}();return e}if("function"==typeof(null==r?void 0:r.then))return Promise.resolve(r).then((e=>({value:e,error:null}))).catch((e=>({value:void 0,error:e}))).then((async e=>{var t;for(let e=n.length-1;e>=0;e--)await(null===(t=n[e])||void 0===t?void 0:t.call(n));if(e.error)throw e.error;return e.value}));o={value:r,error:null}}catch(e){o={value:void 0,error:e}}for(let e=n.length-1;e>=0;e--)null===(r=n[e])||void 0===r||r.call(n);if(o.error)throw o.error;return o.value}},wrap:wrap,throttle:function throttle(e,t){const r="number"==typeof t?null:t.for,n="number"==typeof t?t:t.duration,o="number"!=typeof t&&!!(null==t?void 0:t.noWait),handleCall=function(t,...r){var s;if(t.result&&(t.pending&&o||Date.now()<(null!==(s=t.expires)&&void 0!==s?s:0))){if(t.result.error)throw t.result.error;return t.result.value}if(t.pending)return t.pending;try{const s=e.call(this,...r);if("function"==typeof(null==s?void 0:s.then)){if(t.pending=Promise.resolve(s).finally((()=>{t.result={value:t.pending},t.pending=void 0,t.expires=Date.now()+n})),o&&t.result){if(t.result.error)throw t.result.error;return t.result.value}return t.pending}return t.result={value:s},t.expires=Date.now()+n,s}catch(e){throw t.result={error:e},t.expires=Date.now()+n,e}};if(null==r||""===r){const e={for:null};return function(...t){return handleCall.call(this,e,...t)}}{let e=O.get(r);return e||(e={for:r},O.set(r,e)),function(...t){return handleCall.call(this,e,...t)}}},debounce:function debounce(e,t,r=void 0){const n="number"==typeof t?t:t.delay,o="number"==typeof t?null:t.for,s=null!=o&&""!==o;let i=s?E.get(o):void 0;i||(i={for:o,tasks:[],data:void 0,timer:void 0},s&&E.set(o,i));const a=i;return async function(t){return"function"==typeof r&&void 0!==a.data?a.data=r(a.data,t):a.data=t,a.timer&&clearTimeout(a.timer),a.timer=setTimeout((()=>{const t=a.tasks,r=a.data;a.tasks=[],a.data=void 0,s&&E.delete(o);const resolve=e=>{t.forEach((({resolve:t})=>t(e)))},reject=e=>{t.forEach((({reject:t})=>t(e)))};try{const t=e.call(this,r);"function"==typeof(null==t?void 0:t.then)?t.then(resolve,reject):resolve(t)}catch(e){reject(e)}}),n),await new Promise(((e,t)=>{a.tasks.push({resolve:e,reject:t})}))}},queue:function queue(e,t=0){return new Queue(e,t)},lock:async function lock(e){let t=q.get(e);return t||q.set(e,t=new Mutex(void 0)),await t.lock()},read:function read$1(e,t=void 0){var r;const n=asIterable(e);if(n)return n;const o=chan(1/0),s=o.send.bind(o),i=o.close.bind(o),handleBrowserErrorEvent=e=>{let t;t=e instanceof ErrorEvent?e.error||new Error(e.message):new Error("something went wrong",{cause:e}),i(t)},a=Object.getPrototypeOf(e),l=Object.getOwnPropertyDescriptor(a,"onmessage");if((null==l?void 0:l.set)&&isFunction(e.close)){const n=Object.getOwnPropertyDescriptor(a,"onerror"),o=Object.getOwnPropertyDescriptor(a,"onclose");let c;if((null==t?void 0:t.event)&&"message"!==(null==t?void 0:t.event)&&isFunction(e.addEventListener)){const r=e,n=t.event,msgListener=e=>{s(e.data)};r.addEventListener(n,msgListener),c=()=>{r.removeEventListener(n,msgListener)}}else l.set.call(e,(e=>{s(e.data)})),c=()=>{var t;null===(t=l.set)||void 0===t||t.call(e,null)};if(null===(r=null==n?void 0:n.set)||void 0===r||r.call(e,handleBrowserErrorEvent),null==o?void 0:o.set)o.set.call(e,(()=>{var t,r;i(),null===(t=o.set)||void 0===t||t.call(e,null),null===(r=null==n?void 0:n.set)||void 0===r||r.call(e,null),null==c||c()}));else if(!(null==o?void 0:o.set)&&isFunction(e.close)){const t=e,r=t.close;t.close=function close(){var o;r.call(t),i(),t.close=r,null===(o=null==n?void 0:n.set)||void 0===o||o.call(e,null),null==c||c()}}}else if(isFunction(e.send)&&isFunction(e.close)){const t=e;t.onmessage=e=>{s(e.data)},t.onerror=handleBrowserErrorEvent,t.onclose=()=>{i(),t.onclose=null,t.onerror=null,t.onmessage=null}}else if(isFunction(e.addEventListener)){const r=e,n=(null==t?void 0:t.message)||"message",o=(null==t?void 0:t.error)||"error",a=(null==t?void 0:t.close)||"close",msgListener=e=>{e instanceof MessageEvent&&s(e.data)};r.addEventListener(n,msgListener),r.addEventListener(o,handleBrowserErrorEvent),r.addEventListener(a,(function closeListener(){i(),r.removeEventListener(a,closeListener),r.removeEventListener(n,msgListener),r.removeEventListener(o,handleBrowserErrorEvent)}))}else{if(!isFunction(e.on))throw new TypeError("the input source cannot be read as an AsyncIterable object");{const r=e;let n,o,a;"object"==typeof process&&e===process?(n="message",o="uncaughtException",a="exit"):isFunction(e.send)&&isFunction(e.kill)||isFunction(e.postMessage)&&isFunction(e.terminate)||isFunction(e.postMessage)&&isFunction(e.close)?(n="message",o="error",a="exit"):(n=(null==t?void 0:t.data)||"data",o=(null==t?void 0:t.error)||"error",a=(null==t?void 0:t.close)||"close"),r.on(n,s),r.once(o,i),r.once(a,(()=>{i(),r.off(n,s),r.off(o,i)}))}}return{[Symbol.asyncIterator]:o[Symbol.asyncIterator].bind(o)}},readAll:async function readAll(e){const t=asIterable(e),r=[];for await(const e of t)r.push(e);return r},chan:chan,parallel:Y,run:te,example:function example(e,t=void 0){const r={};return Error.captureStackTrace(r,example),async function(...n){let o=e.toString().split("\n").slice(1,-1),s=o.findIndex((e=>"// output:"===e.trim().toLowerCase()));if(-1===s)return;if(s+=1,o=o.slice(s),-1!==o.findIndex((e=>"// output:"===e.trim().toLowerCase())))throw new Error("there can only be one output comment in the example");let i=[];for(let e of o){if(e=e.trimStart(),!e.startsWith("//"))throw new Error("the output comment must be at the end of the example");if(e[2]&&" "!==e[2])throw new Error("the output comment must start with '// '");i.push(e.slice(3))}const a=[...i];i=[];for(let e=a.length-1;e>=0;e--)""!==a[e]&&i.push(a[e]);i.reverse();const l=await import("node:assert"),{Writable:c}=await import("node:stream"),{Console:u}=await import("node:console"),f=[],d=new TextDecoder,p=new c({write(e,t,r){f.push(e),r()}}),h=new u(p),y=e.call(this,h,...n);"function"==typeof(null==y?void 0:y.then)&&await y,await new Promise((e=>p.end((()=>e())))),await(async()=>{var e;const n=f.map((e=>d.decode(e))).join("\n").replace(/[\n]+$/,""),o=i.join("\n");try{if(l.ok(n===o,`\nexpected:\n${o}\n\ngot:\n${n}`),!(null==t?void 0:t.suppress))for(const e of f)"object"==typeof Deno?await Deno.stdout.write(e):"object"==typeof process&&await new Promise((t=>{process.stdout.write(e,(()=>t()))}))}catch(t){throw Object.defineProperty(t,"stack",{configurable:!0,writable:!0,enumerable:!1,value:t.stack+"\n"+(null===(e=r.stack)||void 0===e?void 0:e.split("\n").slice(1).join("\n"))}),t}})()}},deprecate:function deprecate(e,...t){var r,n,o,s;if("function"==typeof e){const o=null!==(r=t[0])&&void 0!==r?r:"",s=null!==(n=t[1])&&void 0!==n&&n;return wrap(e,(function wrapped(e,...t){return emitWarning(e.name+"()",wrapped,o,s,re?1:2),e.apply(this,t)}))}return emitWarning(e,t[0],null!==(o=t[1])&&void 0!==o?o:"",null!==(s=t[2])&&void 0!==s&&s,1)},isClass:isClass,isSubclassOf:isSubclassOf,mixin:mixin,mixins:mixin};function useColorTheme(){if("function"==typeof window.matchMedia){const e=window.matchMedia("(prefers-color-scheme: dark)");return{theme:e.matches?"dark":"light",onChange:t=>{e.addEventListener("change",(()=>{t(e.matches?"dark":"light")}))}}}return{theme:"light",onChange:e=>{}}}function i18n(e){let t="en";return"object"==typeof navigator&&"string"==typeof navigator.language&&(t=navigator.language.split("-")[0]),e[t]||e.en}globalThis.AsyncFunction=oe,globalThis.AsyncGeneratorFunction=se;const ae=new WeakMap,le="#fff",ce="#222",ue="#000",fe="#fff";function Dialog(e,...t){const{onCancel:r,onOk:n}=e,o=t.some((e=>e.querySelector("input"))),s=document.createElement("dialog"),{theme:i,onChange:a}=useColorTheme();s.style.fontFamily="Inter,sans-serif",s.style.color="light"===i?ue:fe,s.style.fontSize="13px",s.style.width="450px",s.style.boxSizing="border-box",s.style.border="1px solid #ccc",s.style.borderRadius="13px",s.style.padding="1rem",s.style.backgroundColor="light"===i?le:ce,s.style.outline="none",o||(s.inert=!0),a((e=>{s.style.color="light"===e?ue:fe,s.style.backgroundColor="light"===e?le:ce}));const close=()=>{s.returnValue&&"Cancel"!==s.returnValue?"OK"===s.returnValue&&(null==n||n(s)):null==r||r(s);try{document.body.removeChild(s)}catch(e){if("NotFoundError"!==e.name)throw e}};return"function"==typeof s.close?s.addEventListener("close",close):ae.set(s,close),s.addEventListener("keypress",(e=>{"Enter"===e.key&&closeDialog(s,"OK")})),t.forEach((e=>{s.appendChild(e)})),requestAnimationFrame((()=>{"function"==typeof s.showModal?s.showModal():"function"==typeof s.show?s.show():s.open=!0,o||(s.inert=!1,requestAnimationFrame((()=>{s.focus()})))})),s}function closeDialog(e,t){if("function"==typeof e.close)e.close(t);else{e.open=!1,e.returnValue=t;try{e.dispatchEvent(new Event("close"))}catch(t){const r=ae.get(e);r&&(r(),ae.delete(e))}}}const de="#fff",pe="#222",he="#f4f4f4",ye="#333",me={ar:"إلغاء",be:"Адмяніць",bg:"Отказ",bn:"বাতিল",bs:"Otkaži",cs:"Storno",da:"Annuller",de:"Abbrechen",el:"Ακύρωση",en:"Cancel",es:"Cancelar",et:"Tühista",eu:"Ezeztatu",fa:"لغو",fi:"Peruuta",fr:"Annuler",hi:"रद्द करें",hu:"Mégsem",hy:"Չեղարկել",id:"Batal",is:"Hætta við",it:"Annulla",iw:"ביטול",ja:"キャンセル",ko:"취소",lb:"Ofbriechen",lo:"ຍົກເລີກ",lv:"Atcelt",lt:"Atšaukti",mk:"Откажи",ml:"റദ്ദാക്കുക",mi:"Whakakore",mn:"Цуцлах",my:"ပယ်ဖျက်",ne:"रद्द गर्नुहोस्",nl:"Annuleren",no:"Avbryt",pl:"Anuluj",pt:"Cancelar",ro:"Anulare",ru:"Отмена",sa:"रद्द",sk:"Zrušiť",sl:"Prekliči",so:"Kaari",sq:"Anulo",sv:"Avbryt",th:"ยกเลิก",tl:"Kanselahin",tr:"İptal",ug:"بىكارلاش",uk:"Скасувати",vi:"Hủy",zh:"取消"};function CancelButton(){const e=document.createElement("button"),{theme:t,onChange:r}=useColorTheme();return e.textContent=i18n(me),e.style.minWidth="80px",e.style.height="32px",e.style.boxSizing="border-box",e.style.border="1px solid #8ebceb",e.style.borderRadius="1.5rem",e.style.color="#006bd6",e.style.backgroundColor="light"===t?de:pe,e.style.userSelect="none",e.style.fontSize="1em",e.style.fontWeight="500",e.addEventListener("mouseover",(()=>{const{theme:t}=useColorTheme();e.style.backgroundColor="light"===t?he:ye})),e.addEventListener("mouseout",(()=>{const{theme:t}=useColorTheme();e.style.backgroundColor="light"===t?de:pe})),e.addEventListener("click",(e=>{var t;closeDialog(null===(t=e.target)||void 0===t?void 0:t.closest("dialog"),"Cancel")})),r((t=>{e.style.backgroundColor="light"===t?de:pe})),e}function Footer(...e){const t=document.createElement("footer");return t.style.display="flex",t.style.justifyContent="flex-end",t.style.alignItems="center",t.style.gap="0.5em",e.forEach((e=>{t.appendChild(e)})),t}const ge="#333",we="#ccc";function Text(e){const t=document.createElement("p");return t.textContent=e,t.style.margin="0 0 1rem",t.style.fontSize="1em",t}const be=bytes$1("\n"),ve=bytes$1("\r");bytes$1("\t");const ke=bytes$1("\b"),je=bytes$1([127]),Oe=bytes$1([27]),Ee=bytes$1([3]),Se=bytes$1([1]),xe=bytes$1([5]),Pe=bytes$1("\r[K"),Ae=bytes$1("[0K");bytes$1("[1K");const $e=bytes$1("[D"),Ce=bytes$1("[C"),Ie=bytes$1("[A"),Me=bytes$1("[B"),Be=/^(?:\p{Emoji_Modifier_Base}\p{Emoji_Modifier}?|\p{Emoji_Presentation}|\p{Emoji}\uFE0F)(?:\u200d(?:\p{Emoji_Modifier_Base}\p{Emoji_Modifier}?|\p{Emoji_Presentation}|\p{Emoji}\uFE0F))*$/u,isFullWidth=e=>12288===e||e>=65281&&e<=65376||e>=65504&&e<=65510,isWide=e=>e>=4352&&e<=4447||8986===e||8987===e||9001===e||9002===e||e>=9193&&e<=9196||9200===e||9203===e||9725===e||9726===e||9748===e||9749===e||e>=9800&&e<=9811||9855===e||9875===e||9889===e||9898===e||9899===e||9917===e||9918===e||9924===e||9925===e||9934===e||9940===e||9962===e||9970===e||9971===e||9973===e||9978===e||9981===e||9989===e||9994===e||9995===e||10024===e||10060===e||10062===e||e>=10067&&e<=10069||10071===e||e>=10133&&e<=10135||10160===e||10175===e||11035===e||11036===e||11088===e||11093===e||e>=11904&&e<=11929||e>=11931&&e<=12019||e>=12032&&e<=12245||e>=12272&&e<=12287||e>=12289&&e<=12350||e>=12353&&e<=12438||e>=12441&&e<=12543||e>=12549&&e<=12591||e>=12593&&e<=12686||e>=12688&&e<=12771||e>=12783&&e<=12830||e>=12832&&e<=12871||e>=12880&&e<=19903||e>=19968&&e<=42124||e>=42128&&e<=42182||e>=43360&&e<=43388||e>=44032&&e<=55203||e>=63744&&e<=64255||e>=65040&&e<=65049||e>=65072&&e<=65106||e>=65108&&e<=65126||e>=65128&&e<=65131||e>=94176&&e<=94180||94192===e||94193===e||e>=94208&&e<=100343||e>=100352&&e<=101589||e>=101632&&e<=101640||e>=110576&&e<=110579||e>=110581&&e<=110587||110589===e||110590===e||e>=110592&&e<=110882||110898===e||e>=110928&&e<=110930||110933===e||e>=110948&&e<=110951||e>=110960&&e<=111355||126980===e||127183===e||127374===e||e>=127377&&e<=127386||e>=127488&&e<=127490||e>=127504&&e<=127547||e>=127552&&e<=127560||127568===e||127569===e||e>=127584&&e<=127589||e>=127744&&e<=127776||e>=127789&&e<=127797||e>=127799&&e<=127868||e>=127870&&e<=127891||e>=127904&&e<=127946||e>=127951&&e<=127955||e>=127968&&e<=127984||127988===e||e>=127992&&e<=128062||128064===e||e>=128066&&e<=128252||e>=128255&&e<=128317||e>=128331&&e<=128334||e>=128336&&e<=128359||128378===e||128405===e||128406===e||128420===e||e>=128507&&e<=128591||e>=128640&&e<=128709||128716===e||e>=128720&&e<=128722||e>=128725&&e<=128727||e>=128732&&e<=128735||128747===e||128748===e||e>=128756&&e<=128764||e>=128992&&e<=129003||129008===e||e>=129292&&e<=129338||e>=129340&&e<=129349||e>=129351&&e<=129535||e>=129648&&e<=129660||e>=129664&&e<=129672||e>=129680&&e<=129725||e>=129727&&e<=129733||e>=129742&&e<=129755||e>=129760&&e<=129768||e>=129776&&e<=129784||e>=131072&&e<=196605||e>=196608&&e<=262141;function charWidth(e){if(Be.test(e)){const t=byteLength(e);return 1===t||3===t||6===t?1:2}return isWide(e.codePointAt(0))||isFullWidth(e.codePointAt(0))?2:1}function strWidth(e){return sum(...chars(e).map(charWidth))}function toLeft(e){return bytes$1(`[${strWidth(e)}D`)}function toRight(e){return bytes$1(`[${strWidth(e)}C`)}async function read(e){if("fd"in e)return new Promise((t=>{e.once("data",(e=>{t(bytes$1(e))}))}));{const t=e.readable.getReader(),{done:r,value:n}=await t.read();return t.releaseLock(),bytes$1(r?[]:n)}}async function write(e,t){"fd"in e?await new Promise((r=>{e.write(t,(()=>r()))})):await e.write(t)}function writeSync(e,t){"fd"in e?write(e,t):e.writeSync(t)}function isCancelEvent(e){return equals$2(e,Oe)||equals$2(e,Ee)}async function isNodeRepl(){var e;const t=await import("repl");return!!(null!==(e=t.default)&&void 0!==e?e:t).repl}async function handleDomProgress(e,t,r){const{signal:n,abort:o,listenForAbort:s}=r,i=Text(e),{element:a,setValue:l}=function Progress(){const e=document.createElement("div"),t=document.createElement("progress"),r=document.createElement("span"),{theme:n,onChange:o}=useColorTheme();return e.style.width="100%",e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center",e.style.gap="0.5em",t.max=100,t.style.width="100%",r.style.color="light"===n?ge:we,r.style.fontSize="1em",o((e=>{r.style.color="light"===e?ge:we})),e.appendChild(t),e.appendChild(r),{element:e,setValue:e=>{t.value=e,r.textContent=`${e}%`}}}(),c=Dialog({onCancel:o},i);o?c.appendChild(Footer(a,CancelButton())):c.appendChild(a),document.body.appendChild(c);let u=t((e=>{n.aborted||(e.message&&(i.textContent=e.message),void 0!==e.percent&&l(e.percent))}),n);s&&(u=Promise.race([u,s()]));try{return await u}finally{n.aborted||closeDialog(c,"OK")}}async function handleTerminalProgress(e,t,r,n,o){const{signal:s,abort:i,listenForAbort:a}=o;writeSync(t,bytes$1(r));let l,c=stripEnd(r,"..."),u=r.endsWith("...")?"...":"";const f=setInterval((()=>{"..."===u?u=".":u+=".",writeSync(t,Pe),writeSync(t,bytes$1(c+u))}),1e3),nodeReader=e=>{isCancelEvent(e)&&(null==i||i())},d="fd"in e?null:e.readable.getReader();i&&("fd"in e?e.on("data",nodeReader):(async()=>{for(;;)try{const{done:e,value:t}=await d.read();if(e||isCancelEvent(t)){s.aborted||i();break}}catch(e){s.aborted||i();break}})());let p=n((e=>{if(!s.aborted&&(writeSync(t,Pe),e.message&&(c=e.message),void 0!==e.percent&&(l=e.percent),writeSync(t,bytes$1(c)),void 0!==l)){writeSync(t,bytes$1(" ... "+l+"%")),clearInterval(f)}}),s);a&&(p=Promise.race([p,a()]));try{return await p}finally{writeSync(t,be),clearInterval(f),"fd"in e?e.off("data",nodeReader):null==d||d.releaseLock()}}const Re="#fff",Le="#222",_e="#000",De="#fff";const Ne={ar:"موافق",be:"Добра",bg:"ОК",bn:"ঠিক আছে",bs:"U redu",cs:"OK",da:"OK",de:"OK",el:"ΟΚ",en:"OK",es:"Aceptar",et:"OK",eu:"Ados",fa:"باشه",fi:"OK",fr:"OK",hi:"ठीक",hu:"OK",hy:"Լավ",id:"OK",is:"Í lagi",it:"OK",iw:"אישור",ja:"OK",ko:"확인",lb:"OK",lo:"ຕົກລົງ",lv:"Labi",lt:"Gerai",mk:"Добро",ml:"ശരി",mi:"OK",mn:"Зөв",my:"အိုး",ne:"ठिक",nl:"OK",no:"OK",pl:"OK",pt:"OK",ro:"OK",ru:"OK",sa:"ठीक",sk:"OK",sl:"V redu",so:"OK",sq:"OK",sv:"OK",th:"ตกลง",tl:"OK",tr:"Tamam",ug:"جەزملە",uk:"OK",vi:"OK",zh:"确定"};function OkButton(){const e=document.createElement("button");return e.textContent=i18n(Ne),e.style.minWidth="80px",e.style.height="32px",e.style.boxSizing="border-box",e.style.borderStyle="none",e.style.borderRadius="1.5rem",e.style.color="#fff",e.style.backgroundColor="#006bd6",e.style.userSelect="none",e.style.fontSize="1em",e.style.fontWeight="500",e.addEventListener("mouseover",(()=>{e.style.backgroundColor="#0174e6"})),e.addEventListener("mouseout",(()=>{e.style.backgroundColor="#006bd6"})),e.addEventListener("click",(e=>{var t;closeDialog(null===(t=e.target)||void 0===t?void 0:t.closest("dialog"),"OK")})),e}async function promptInBrowser(e,t){const{type:r,defaultValue:n}=t;return new Promise((t=>{document.body.appendChild(Dialog({onCancel:()=>t(null),onOk:e=>{const r=e.querySelector("input");t(r.value)}},Text(e),function Input(e){var t,r;const n=document.createElement("div"),o=document.createElement("input"),{theme:s,onChange:i}=useColorTheme();return n.style.display="flex",n.style.margin="0 0 1rem",o.autofocus=!0,o.style.width="100%",o.style.height="32px",o.style.boxSizing="border-box",o.style.border="1px solid #ccc",o.style.borderRadius="1.5rem",o.style.padding="0 1rem",o.style.fontSize="1em",o.style.color="light"===s?_e:De,o.style.backgroundColor="light"===s?Re:Le,o.type=null!==(t=e.type)&&void 0!==t?t:"text",o.value=null!==(r=e.value)&&void 0!==r?r:"",i((e=>{o.style.color="light"===e?_e:De,o.style.backgroundColor="light"===e?Re:Le})),n.appendChild(o),n}({type:r,value:n}),Footer(CancelButton(),OkButton())))}))}function getMasks(e,t){return new Array(t).fill(e).join("")}async function question(e,t){const{stdin:r,stdout:n,defaultValue:o="",mask:s}=t,i=[];let a=0;if(await write(n,bytes$1(e)),o){const e=chars(o);i.push(...e),a+=e.length,void 0===s?await write(n,bytes$1(o)):s&&await write(n,bytes$1(getMasks(s,e.length)))}for(;;){const e=await read(r);if(e.length&&!equals$2(e,Ie)&&!equals$2(e,Me))if(equals$2(e,$e)){if(a>0){const e=i[--a];void 0===s?await write(n,toLeft(e)):s&&await write(n,toLeft(s))}}else if(equals$2(e,Ce)){if(a<i.length){const e=i[a++];void 0===s?await write(n,toRight(e)):s&&await write(n,toRight(s))}}else if(equals$2(e,Se)){const e=i.slice(0,a);e.length&&(a=0,void 0===s?await write(n,toLeft(e.join(""))):s&&await write(n,toLeft(getMasks(s,e.length))))}else if(equals$2(e,xe)){const e=i.slice(a);e.length&&(a=i.length,void 0===s?await write(n,toRight(e.join(""))):s&&await write(n,toRight(getMasks(s,e.length))))}else{if(isCancelEvent(e))return await write(n,be),null;if(equals$2(e,ve)||equals$2(e,be))return await write(n,be),i.join("");if(equals$2(e,ke)||equals$2(e,je)){if(a>0){a--;const[e]=i.splice(a,1),t=i.slice(a);if(void 0===s){if(await write(n,toLeft(e)),await write(n,Ae),t.length){const e=t.join("");await write(n,bytes$1(e)),await write(n,toLeft(e))}}else if(s&&(await write(n,toLeft(s)),await write(n,Ae),t.length)){const e=getMasks(s,t.length);await write(n,bytes$1(e)),await write(n,toLeft(e))}}}else{const t=chars(String(e));if(a===i.length)i.push(...t),a+=t.length,void 0===s?await write(n,e):s&&await write(n,bytes$1(getMasks(s,t.length)));else if(i.splice(a,0,...t),a+=t.length,void 0===s){const t=i.slice(a).join("");await write(n,concat(e,bytes$1(t))),await write(n,toLeft(t))}else if(s){const e=getMasks(s,t.length),r=getMasks(s,i.slice(a).length);await write(n,bytes$1(e+r)),await write(n,toLeft(r))}}}}}async function questionInDeno(e,t={}){const{stdin:r,stdout:n}=Deno;if(!r.isTerminal())return null;r.setRaw(!0);try{return await question(e,{stdin:r,stdout:n,...t})}finally{r.setRaw(!1)}}async function questionInNode(e,t={}){const{stdin:r,stdout:n}=process;if(!n.isTTY)return null;r.isPaused()&&r.resume();const o=r.isRaw;o||r.setRawMode(!0);try{return await question(e,{stdin:r,stdout:n,...t})}finally{r.setRawMode(o),await isNodeRepl()||r.pause()}}async function questionInNodeRepl(e,t={}){return await async function hijackNodeStdin(e,t){const r=e.listeners("keypress");e.removeAllListeners("keypress");const n=await t();return r.forEach((t=>e.addListener("keypress",t))),n}(process.stdin,(async()=>await questionInNode(e,t)))}var Te=Object.freeze({__proto__:null,alert:async function alert(e){"object"==typeof document?await async function alertInBrowser(e){await new Promise((t=>{document.body.appendChild(Dialog({onCancel:()=>t(),onOk:()=>t()},Text(e),Footer(OkButton())))}))}(e):"object"==typeof Deno?await questionInDeno(e+" [Enter] "):(await isNodeRepl(),await questionInNodeRepl(e+" [Enter] "))},confirm:async function confirm(e){if("object"==typeof document)return await async function confirmInBrowser(e){return new Promise((t=>{document.body.appendChild(Dialog({onCancel:()=>t(!1),onOk:()=>t(!0)},Text(e),Footer(CancelButton(),OkButton())))}))}(e);{let t;t="object"==typeof Deno?await questionInDeno(e+" [Y/n] "):await isNodeRepl()?await questionInNodeRepl(e+" [Y/n] "):await questionInNode(e+" [Y/n] ");const r=null==t?void 0:t.toLowerCase().trim();return""===r||"y"===r||"yes"===r}},progress:async function progress(e,t,r=void 0){const n=new AbortController,o=n.signal;let s=null;const i=r?async()=>{try{const e=await r();s={value:e},n.abort()}catch(e){n.abort(e)}}:void 0,a=r?()=>new Promise(((e,t)=>{o.addEventListener("abort",(()=>{s?e(s.value):t(o.reason)}))})):void 0;return"object"==typeof document?await handleDomProgress(e,t,{signal:o,abort:i,listenForAbort:a}):"object"==typeof Deno?await async function handleDenoProgress(e,t,r){const{stdin:n,stdout:o}=Deno;if(!n.isTerminal)return null;n.setRaw(!0);try{return await handleTerminalProgress(n,o,e,t,r)}finally{n.setRaw(!1)}}(e,t,{signal:o,abort:i,listenForAbort:a}):await async function handleNodeProgress(e,t,r){const{stdin:n,stdout:o}=process;if(!o.isTTY)return null;n.isPaused()&&n.resume();const s=n.isRaw;s||n.setRawMode(!0);try{return await handleTerminalProgress(n,o,e,t,r)}finally{n.setRawMode(s),await isNodeRepl()||n.pause()}}(e,t,{signal:o,abort:i,listenForAbort:a})},prompt:async function prompt(e,t=""){var r,n;const o="string"==typeof t?t:t.defaultValue,s="object"==typeof t&&null!==(r=t.type)&&void 0!==r?r:"text",i="password"===s?"object"==typeof t&&null!==(n=t.mask)&&void 0!==n?n:"*":void 0;return"object"==typeof document?await promptInBrowser(e,{type:s,defaultValue:o}):"object"==typeof Deno?await questionInDeno(e+" ",{defaultValue:o,mask:i}):await isNodeRepl()?await questionInNodeRepl(e+" ",{defaultValue:o,mask:i}):await questionInNode(e+" ",{defaultValue:o,mask:i})}});return{...ie,string:u,number:f,array:d,object:t,json:b,math:r,promise:p,error:g,collections:y,bytes:{...omit(s,["default"]),bytes:bytes$1},path:K,dialog:Te}}));
//# sourceMappingURL=jsext.js.map
